<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">Painel Administrador</h1>
                {% include 'blocks/help-button.html.twig' with {'section': 'dashboard', 'title': 'Ajuda com Dashboard', 'show_text': false} %}
            </div>
            
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> {{ success }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            {% if info %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle"></i> {{ info }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if pending_transfers and pending_transfers|length > 0 %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
                    <div class="flex-grow-1">
                        <strong>Tem {{ pending_transfers|length }} convite(s) pendente(s) para administração de condomínios.</strong>
                        <br>
                        <small>Por favor, aceite ou rejeite os convites para continuar.</small>
                    </div>
                    <a href="{{ BASE_URL }}admin-transfers/pending" class="btn btn-warning btn-sm ms-3">
                        <i class="bi bi-eye"></i> Ver Convites
                    </a>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            {% if not admin_condominiums and (user.role == 'admin' or user.role == 'super_admin') %}
            <!-- Show create condominium first when no condominiums exist -->
            <div class="card shadow-sm mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Condomínios que Geres</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="text-center py-5">
                                {% if can_create_condominium is defined and can_create_condominium == true %}
                                <a href="{{ BASE_URL }}condominiums/create" class="text-decoration-none">
                                    <div class="card border-dashed border-3 border-primary shadow-sm" style="border-style: dashed !important; min-height: 300px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                        <div class="card-body text-center p-5">
                                            <i class="bi bi-plus-circle display-1 text-primary mb-4"></i>
                                            <h3 class="card-title text-primary mb-3">Criar o Seu Primeiro Condomínio</h3>
                                            <p class="card-text text-muted lead mb-4">Comece a gerir o seu condomínio de forma simples e eficiente</p>
                                            <button class="btn btn-primary btn-lg">
                                                <i class="bi bi-plus-circle"></i> Criar Condomínio
                                            </button>
                                        </div>
                                    </div>
                                </a>
                                {% else %}
                                <div class="card border-dashed border-3 border-secondary shadow-sm" style="border-style: dashed !important; min-height: 300px; display: flex; align-items: center; justify-content: center; opacity: 0.6;">
                                    <div class="card-body text-center p-5">
                                        <i class="bi bi-plus-circle display-1 text-secondary mb-4"></i>
                                        <h3 class="card-title text-secondary mb-3">Novo Condomínio</h3>
                                        <p class="card-text text-muted mb-4">Limite de condomínios atingido</p>
                                        <p class="card-text text-danger">
                                            <i class="bi bi-exclamation-triangle"></i> Limite de condomínios atingido ({{ current_condominium_count|default(0) }}/{{ condominium_limit|default('∞') }})
                                        </p>
                                        <a href="{{ BASE_URL }}subscription" class="btn btn-primary mt-3">
                                            <i class="bi bi-arrow-up-circle"></i> Alterar Plano
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% elseif admin_condominiums %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Condomínios que Geres</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        {% for condominium in admin_condominiums %}
                        <div class="col-md-6 col-lg-4">
                            <a href="{{ BASE_URL }}condominiums/switch/{{ condominium.id }}" class="text-decoration-none">
                                <div class="card h-100 shadow-sm card-hover border-primary">
                                    {% if condominium.logo_url %}
                                    <div style="width: 100%; height: 150px; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                        <img src="{{ condominium.logo_url }}" alt="{{ condominium.name }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
                                    </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 class="card-title mb-0">{{ condominium.name }}</h5>
                                            <span class="badge bg-primary">Admin</span>
                                        </div>
                                        <p class="card-text text-muted">
                                            <i class="bi bi-geo-alt"></i> {{ condominium.city }}{% if condominium.district %}, {{ condominium.district }}{% endif %}
                                        </p>
                                        <p class="card-text small text-muted">{{ condominium.address }}</p>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <span class="badge {% if condominium.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                                {% if condominium.is_active %}Ativo{% else %}Inativo{% endif %}
                                            </span>
                                            <span class="text-primary">
                                                <i class="bi bi-arrow-right"></i> Gerir
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                        {% if user.role == 'admin' or user.role == 'super_admin' %}
                        <div class="col-md-6 col-lg-4">
                            {% if can_create_condominium is defined and can_create_condominium == true %}
                            <a href="{{ BASE_URL }}condominiums/create" class="text-decoration-none">
                                <div class="card h-100 shadow-sm card-hover border-dashed border-2 border-primary" style="border-style: dashed !important; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <div class="card-body text-center">
                                        <i class="bi bi-plus-circle display-4 text-primary mb-3"></i>
                                        <h5 class="card-title text-primary">Novo Condomínio</h5>
                                        <p class="card-text text-muted small">Clique para criar um novo condomínio</p>
                                    </div>
                                </div>
                            </a>
                            {% else %}
                            <div class="card h-100 shadow-sm border-dashed border-2 border-secondary" style="border-style: dashed !important; min-height: 200px; display: flex; align-items: center; justify-content: center; opacity: 0.6; cursor: not-allowed;" data-bs-toggle="tooltip" data-bs-placement="top" title="Limite de condomínios atingido. Altere o seu plano para adicionar mais condomínios.">
                                <div class="card-body text-center">
                                    <i class="bi bi-plus-circle display-4 text-secondary mb-3"></i>
                                    <h5 class="card-title text-secondary">Novo Condomínio</h5>
                                    <p class="card-text text-muted small">Limite atingido</p>
                                    <p class="card-text text-danger small mt-2">
                                        <i class="bi bi-exclamation-triangle"></i> Limite de condomínios atingido ({{ current_condominium_count|default(0) }}/{{ condominium_limit|default('∞') }})
                                    </p>
                                    <a href="{{ BASE_URL }}subscription" class="btn btn-sm btn-primary mt-2">
                                        <i class="bi bi-arrow-up-circle"></i> Alterar Plano
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if condomino_condominiums %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-house-door"></i> Condomínios onde és Condómino</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        {% for condominium in condomino_condominiums %}
                        <div class="col-md-6 col-lg-4">
                            <a href="{{ BASE_URL }}condominiums/switch/{{ condominium.id }}" class="text-decoration-none">
                                <div class="card h-100 shadow-sm card-hover border-info">
                                    {% if condominium.logo_url %}
                                    <div style="width: 100%; height: 150px; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                        <img src="{{ condominium.logo_url }}" alt="{{ condominium.name }}" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
                                    </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 class="card-title mb-0">{{ condominium.name }}</h5>
                                            <span class="badge bg-info">Condómino</span>
                                        </div>
                                        <p class="card-text text-muted">
                                            <i class="bi bi-geo-alt"></i> {{ condominium.city }}{% if condominium.district %}, {{ condominium.district }}{% endif %}
                                        </p>
                                        <p class="card-text small text-muted">{{ condominium.address }}</p>
                                        {% if condominium.fraction_identifier %}
                                        <p class="card-text small text-muted mb-2">
                                            <i class="bi bi-house"></i> Fração: {{ condominium.fraction_identifier }}
                                        </p>
                                        {% endif %}
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <span class="badge {% if condominium.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                                {% if condominium.is_active %}Ativo{% else %}Inativo{% endif %}
                                            </span>
                                            <span class="text-info">
                                                <i class="bi bi-arrow-right"></i> Ver Detalhes
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if admin_condominiums or condomino_condominiums %}
            <!-- Dashboard Information Cards -->
            <div class="row mb-4">
                <!-- Licenses Card -->
                {% if admin_condominiums|length > 0 %}
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card border-primary h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-muted mb-0"><i class="bi bi-key"></i> Licenças</h6>
                                {% if license_info.plan_type %}
                                <a href="{{ BASE_URL }}subscription" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-gear"></i>
                                </a>
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <h3 class="mb-0">
                                    {{ license_info.used_licenses }}
                                    {% if license_info.license_limit is not null %}
                                    <small class="text-muted">/ {{ license_info.license_limit }}</small>
                                    {% endif %}
                                </h3>
                                <p class="text-muted small mb-0">Licenças usadas</p>
                            </div>
                            {% if license_info.license_limit is not null %}
                            <div class="mb-2">
                                <h4 class="mb-0 text-success">
                                    {{ license_info.license_limit - license_info.used_licenses }}
                                </h4>
                                <p class="text-muted small mb-0">Licenças disponíveis</p>
                            </div>
                            {% if license_info.license_min is not null %}
                            <div class="mb-2">
                                <p class="text-muted small mb-0">
                                    <strong>{{ license_info.license_min }}</strong> do pacote
                                    {% if license_info.extra_licenses > 0 %}
                                    + <strong class="text-success">{{ license_info.extra_licenses }}</strong> extras
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                            {% endif %}
                            {% if license_info.plan_name %}
                            <p class="text-muted small mb-0">{{ license_info.plan_name }}</p>
                            {% endif %}
                            {% if license_info.license_limit is not null %}
                            <div class="progress mt-2" style="height: 8px;">
                                {% set usage_percent = (license_info.used_licenses / license_info.license_limit * 100)|round %}
                                <div class="progress-bar {% if usage_percent >= 90 %}bg-danger{% elseif usage_percent >= 75 %}bg-warning{% else %}bg-primary{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ usage_percent }}%"
                                     aria-valuenow="{{ usage_percent }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Unread Notifications Card -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <a href="{{ BASE_URL }}notifications" class="text-decoration-none">
                        <div class="card border-info h-100 card-hover">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="text-muted mb-0"><i class="bi bi-bell"></i> Notificações</h6>
                                    {% if unread_notifications_count > 0 %}
                                    <span class="badge bg-danger">{{ unread_notifications_count }}</span>
                                    {% endif %}
                                </div>
                                <h3 class="mb-0 {% if unread_notifications_count > 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {{ unread_notifications_count }}
                                </h3>
                                <p class="text-muted small mb-0">Não lidas</p>
                            </div>
                        </div>
                    </a>
                </div>
                
                <!-- Unread Messages Card -->
                <div class="col-md-6 col-lg-3 mb-3">
                    {% if admin_condominiums|length > 0 %}
                    <a href="{{ BASE_URL }}condominiums/{{ admin_condominiums[0].id }}/messages" class="text-decoration-none">
                    {% else %}
                    <a href="#" class="text-decoration-none" onclick="return false;">
                    {% endif %}
                        <div class="card border-success h-100 card-hover">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="text-muted mb-0"><i class="bi bi-envelope"></i> Mensagens</h6>
                                    {% if unread_messages_count > 0 %}
                                    <span class="badge bg-danger">{{ unread_messages_count }}</span>
                                    {% endif %}
                                </div>
                                <h3 class="mb-0 {% if unread_messages_count > 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {{ unread_messages_count }}
                                </h3>
                                <p class="text-muted small mb-0">Não lidas</p>
                            </div>
                        </div>
                    </a>
                </div>
                
                <!-- Open Questionnaires Card -->
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card border-warning h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-muted mb-0"><i class="bi bi-clipboard-check"></i> Questionários</h6>
                                {% if open_votes|length > 0 %}
                                <span class="badge bg-warning">{{ open_votes|length }}</span>
                                {% endif %}
                            </div>
                            <h3 class="mb-0 {% if open_votes|length > 0 %}text-warning{% else %}text-muted{% endif %}">
                                {{ open_votes|length }}
                            </h3>
                            <p class="text-muted small mb-0">Em aberto</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Open Questionnaires List -->
            {% if open_votes|length > 0 %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Questionários em Aberto</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for vote in open_votes %}
                        <a href="{{ BASE_URL }}condominiums/{{ vote.condominium_id }}/votes/{{ vote.id }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ vote.title }}</h6>
                                    {% if vote.description %}
                                    <p class="mb-1 text-muted small">{{ vote.description|slice(0, 100) }}{% if vote.description|length > 100 %}...{% endif %}</p>
                                    {% endif %}
                                    <small class="text-muted">
                                        <i class="bi bi-building"></i> {{ vote.condominium_name }}
                                        {% if vote.voting_started_at %}
                                        | <i class="bi bi-calendar"></i> Iniciada: {{ vote.voting_started_at|date('d/m/Y H:i') }}
                                        {% endif %}
                                    </small>
                                </div>
                                <span class="badge bg-warning ms-2">Aberto</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>

