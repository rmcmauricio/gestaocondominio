<div class="container py-4">
    {% set page_actions %}
        {% if is_admin %}
        <div class="page-header-actions">
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#liquidateQuotasModal">
                <i class="bi bi-cash-coin"></i> <span class="d-none d-sm-inline">Liquidar Quotas</span>
            </button>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#generateFeesModal">
                <i class="bi bi-calculator"></i> <span class="d-none d-sm-inline">Gerar Quotas</span>
            </button>
        </div>
        {% endif %}
    {% endset %}
    {% include 'blocks/page-header.html.twig' with {
        'title': 'Quotas',
        'help_section': 'finances-fees',
        'help_title': 'Ajuda com Quotas',
        'actions': page_actions
    } %}

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {% if "Orçamento não encontrado" in error and "Crie um orçamento primeiro" in error %}
            {% set error_year = error_budget_year ?: (selected_year ?: current_year) %}
            {{ error|replace({"Crie um orçamento primeiro.": ""})|trim }}
            <br>
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/budgets/create?year={{ error_year }}" class="btn btn-sm btn-primary mt-2">
                <i class="bi bi-calendar-check"></i> Criar Orçamento {{ error_year }}
            </a>
        {% else %}
            {{ error }}
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Mapa de Quotas - Primeiro Item -->
    <div class="row g-3 mb-4">
        {% include 'blocks/fees-map.html.twig' %}
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/fees" class="row g-3" id="filtersForm" onsubmit="event.preventDefault(); filterFees(); return false;">
                <div class="col-12 col-sm-6 col-md-2">
                    <label for="year" class="form-label">Ano</label>
                    <select class="form-select form-select-sm" id="year" name="year">
                        <option value="" {% if selected_year is null or selected_year == '' %}selected{% endif %}>Todos</option>
                        {% for y in available_filter_years|default([])|sort|reverse %}
                        <option value="{{ y }}" {% if selected_year is not null and selected_year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-2">
                    <label for="month" class="form-label">Mês</label>
                    <select class="form-select form-select-sm" id="month" name="month">
                        <option value="">Todos</option>
                        <option value="1" {% if selected_month == 1 %}selected{% endif %}>Janeiro</option>
                        <option value="2" {% if selected_month == 2 %}selected{% endif %}>Fevereiro</option>
                        <option value="3" {% if selected_month == 3 %}selected{% endif %}>Março</option>
                        <option value="4" {% if selected_month == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if selected_month == 5 %}selected{% endif %}>Maio</option>
                        <option value="6" {% if selected_month == 6 %}selected{% endif %}>Junho</option>
                        <option value="7" {% if selected_month == 7 %}selected{% endif %}>Julho</option>
                        <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if selected_month == 9 %}selected{% endif %}>Setembro</option>
                        <option value="10" {% if selected_month == 10 %}selected{% endif %}>Outubro</option>
                        <option value="11" {% if selected_month == 11 %}selected{% endif %}>Novembro</option>
                        <option value="12" {% if selected_month == 12 %}selected{% endif %}>Dezembro</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select form-select-sm" id="status" name="status">
                        <option value="">Todos</option>
                        <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pendentes</option>
                        <option value="paid" {% if selected_status == 'paid' %}selected{% endif %}>Pagas</option>
                        <option value="overdue" {% if selected_status == 'overdue' %}selected{% endif %}>Em Atraso</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-2">
                    <label for="fraction_id" class="form-label">Fração</label>
                    <select class="form-select form-select-sm" id="fraction_id" name="fraction_id">
                        {% if is_admin %}
                        <option value="">Todas</option>
                        {% endif %}
                        {% for fraction in fractions %}
                        <option value="{{ fraction.id }}" {% if selected_fraction == fraction.id %}selected{% endif %}>
                            {{ fraction.identifier }}
                            {% if not is_admin and fraction.id not in user_fraction_ids %}(Outras){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-2 d-flex align-items-end">
                    <div class="form-check form-switch w-100">
                        <input class="form-check-input" type="checkbox" id="show_historical" name="show_historical" value="1" {% if show_historical %}checked{% endif %} onchange="filterFees()">
                        <label class="form-check-label" for="show_historical">Incluir Dívidas</label>
                    </div>
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary w-100 btn-sm">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumo - Logo após os filtros -->
    {% if summary %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="mb-3">Resumo</h5>
            <div class="row g-3">
                <div class="col-6 col-sm-4 col-md-3">
                    <div class="text-muted small">Total</div>
                    <div class="fw-bold">€{{ summary.total|number_format(2, ',', '.') }}</div>
                </div>
                <div class="col-6 col-sm-4 col-md-3">
                    <div class="text-muted small">Pagas</div>
                    <div class="fw-bold text-success">€{{ summary.paid|number_format(2, ',', '.') }}</div>
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <div class="text-muted small">Pendentes</div>
                    <div class="fw-bold text-warning">€{{ summary.pending|number_format(2, ',', '.') }}</div>
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <div class="text-muted small">Parciais</div>
                    <div class="fw-bold text-info">€{{ summary.partial|default(0)|number_format(2, ',', '.') }}</div>
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <div class="text-muted small">Em Atraso</div>
                    <div class="fw-bold text-danger">€{{ summary.overdue|number_format(2, ',', '.') }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if fees %}
    <!-- Desktop Table View -->
    <div class="card shadow-sm d-none d-md-block">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Fração</th>
                            <th>Período</th>
                            <th>Valor Total</th>
                            <th>Pago</th>
                            <th>Pendente</th>
                            <th>Vencimento</th>
                            <th class="text-center">Status</th>
                            {% if is_admin %}
                            <th style="width: 80px;">Ações</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee in fees %}
                        {% set paid_amount = fee.paid_amount|default(0) %}
                        {% set pending_amount = fee.pending_amount|default(fee.amount) %}
                        {% set calculated_status = fee.calculated_status|default(fee.status) %}
                        <tr id="fee-row-{{ fee.id }}" style="cursor: pointer;" onclick="showFeeDetails({{ fee.id }})" title="Clique para ver detalhes" data-fee-id="{{ fee.id }}">
                            <td><strong>{% include 'blocks/fraction-popover.html.twig' with { identifier: fee.fraction_identifier, owner_name: fee.owner_name, floor: fee.fraction_floor, stop_propagation: true } only %}</strong></td>
                            <td>{{ fee.period_display|default(fee.period_year) }}</td>
                            <td><strong>€{{ fee.amount|number_format(2, ',', '.') }}</strong></td>
                            <td>
                                {% if paid_amount > 0 %}
                                    <span class="text-success">€{{ paid_amount|number_format(2, ',', '.') }}</span>
                                {% else %}
                                    <span class="text-muted">€0,00</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pending_amount > 0 %}
                                    <strong class="text-danger">€{{ pending_amount|number_format(2, ',', '.') }}</strong>
                                {% else %}
                                    <span class="text-success">€0,00</span>
                                {% endif %}
                            </td>
                            <td>{{ fee.due_date|date('d/m/Y') }}</td>
                            <td class="text-center">
                                {% if calculated_status == 'paid' %}
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;" title="Pago"></i>
                                {% elseif calculated_status == 'overdue' %}
                                    <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 1.2rem;" title="Em Atraso"></i>
                                {% elseif calculated_status == 'partial' %}
                                    <i class="bi bi-circle-half text-info" style="font-size: 1.2rem;" title="Parcial"></i>
                                {% else %}
                                    <i class="bi bi-clock-history text-warning" style="font-size: 1.2rem;" title="Pendente"></i>
                                {% endif %}
                            </td>
                            <td onclick="event.stopPropagation();">
                                {% if is_admin %}
                                    <div class="d-flex gap-1">
                                        {% if calculated_status != 'paid' %}
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="event.stopPropagation(); showPaymentModal({{ fee.id }})" 
                                                title="Registar Pagamento">
                                            <i class="bi bi-cash-coin"></i>
                                        </button>
                                        {% endif %}
                                        {% if (fee.fee_type|default('regular')) == 'extra' and paid_amount == 0 %}
                                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/{{ fee.id }}/edit" 
                                           class="btn btn-sm btn-outline-warning" 
                                           onclick="event.stopPropagation();"
                                           title="Editar Quota Extra">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="event.stopPropagation(); showDeleteFeeModal({{ fee.id }}, '{{ fee.fraction_identifier|e('js') }}', '{{ (fee.period_display|default(fee.period_year))|e('js') }}', {{ fee.amount|number_format(2, '.', '') }});"
                                                title="Eliminar Quota Extra">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mobile/Tablet Card View -->
    <div class="d-md-none">
        {% for fee in fees %}
        {% set paid_amount = fee.paid_amount|default(0) %}
        {% set pending_amount = fee.pending_amount|default(fee.amount) %}
        {% set calculated_status = fee.calculated_status|default(fee.status) %}
        <div id="fee-card-{{ fee.id }}" class="card shadow-sm mb-3" style="cursor: pointer;" onclick="showFeeDetails({{ fee.id }})" title="Clique para ver detalhes" data-fee-id="{{ fee.id }}">
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="mb-1 d-flex align-items-center gap-2">
                        {% include 'blocks/fraction-popover.html.twig' with { identifier: fee.fraction_identifier, owner_name: fee.owner_name, floor: fee.fraction_floor, extra_class: 'badge bg-secondary', stop_propagation: true } only %}
                        {% if calculated_status == 'paid' %}
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;" title="Pago"></i>
                        {% elseif calculated_status == 'overdue' %}
                            <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 1.2rem;" title="Em Atraso"></i>
                        {% elseif calculated_status == 'partial' %}
                            <i class="bi bi-circle-half text-info" style="font-size: 1.2rem;" title="Parcial"></i>
                        {% else %}
                            <i class="bi bi-clock-history text-warning" style="font-size: 1.2rem;" title="Pendente"></i>
                        {% endif %}
                        <span class="ms-auto">{{ fee.period_display|default(fee.period_year) }}</span>
                    </h6>
                    <small class="text-muted">Vencimento: {{ fee.due_date|date('d/m/Y') }}</small>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="text-muted small">Total</div>
                        <div class="fw-bold">€{{ fee.amount|number_format(2, ',', '.') }}</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted small">Pago</div>
                        <div class="{% if paid_amount > 0 %}text-success fw-bold{% else %}text-muted{% endif %}">
                            €{{ paid_amount|number_format(2, ',', '.') }}
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted small">Pendente</div>
                        <div class="{% if pending_amount > 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
                            €{{ pending_amount|number_format(2, ',', '.') }}
                        </div>
                    </div>
                </div>
                
                {% if is_admin %}
                <div class="d-flex gap-2">
                    {% if calculated_status != 'paid' %}
                    <button type="button" class="btn btn-sm btn-outline-primary {% if (fee.fee_type|default('regular')) == 'extra' and paid_amount == 0 %}flex-fill{% else %}w-100{% endif %}" 
                            onclick="event.stopPropagation(); showPaymentModal({{ fee.id }})" 
                            title="Registar Pagamento">
                        <i class="bi bi-cash-coin"></i> Pagar
                    </button>
                    {% endif %}
                    {% if (fee.fee_type|default('regular')) == 'extra' and paid_amount == 0 %}
                    <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/{{ fee.id }}/edit" 
                       class="btn btn-sm btn-outline-warning flex-fill" 
                       onclick="event.stopPropagation();"
                       title="Editar Quota Extra">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger w-100 flex-fill" 
                            onclick="event.stopPropagation(); showDeleteFeeModal({{ fee.id }}, '{{ fee.fraction_identifier|e('js') }}', '{{ (fee.period_display|default(fee.period_year))|e('js') }}', {{ fee.amount|number_format(2, '.', '') }});"
                            title="Eliminar Quota Extra">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if pagination is defined and pagination.total_count > 0 %}
    <nav aria-label="Paginação das quotas" class="mt-4">
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <span class="text-muted small">
                    Mostrando {{ pagination.from }}-{{ pagination.to }} de {{ pagination.total_count }} quotas
                    {% if pagination.total_pages > 1 %}
                    | Página {{ pagination.current_page }} de {{ pagination.total_pages }}
                    {% endif %}
                </span>
                <label class="d-flex align-items-center gap-1 small mb-0">
                    <span class="text-muted">Por página:</span>
                    <select class="form-select form-select-sm" id="per_page" name="per_page" style="width: auto;" onchange="changePerPage(this.value)">
                        <option value="25" {% if pagination.per_page|default(25) == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if pagination.per_page|default(25) == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if pagination.per_page|default(25) == 100 %}selected{% endif %}>100</option>
                    </select>
                </label>
            </div>
            {% if pagination.total_pages > 1 %}
            <ul class="pagination pagination-sm mb-0">
                {% if pagination.current_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.current_page - 1 }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}" aria-label="Anterior">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                {% set startPage = max(1, pagination.current_page - 2) %}
                {% set endPage = min(pagination.total_pages, pagination.current_page + 2) %}
                {% for i in range(startPage, endPage) %}
                <li class="page-item {% if i == pagination.current_page %}active{% endif %}">
                    <a class="page-link" href="?page={{ i }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">{{ i }}</a>
                </li>
                {% endfor %}
                {% if pagination.current_page < pagination.total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.current_page + 1 }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}" aria-label="Próximo">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
            {% endif %}
        </div>
    </nav>
    {% endif %}
    {% else %}
    <div class="card shadow">
        <div class="card-body text-center py-5">
            <i class="bi bi-receipt display-1 text-muted"></i>
            <h4 class="mt-3">Nenhuma quota encontrada</h4>
            <p class="text-muted">Gere as quotas mensais para começar</p>
        </div>
    </div>
    {% endif %}

    <!-- Modal para Gerar Quotas -->
    <div class="modal fade" id="generateFeesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/generate" id="generateFeesForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="fee_mode" id="fee_mode" value="annual">
                    <input type="hidden" name="annual_type" id="annual_type" value="">
                    <input type="hidden" name="manual_use_permillage" id="manual_use_permillage" value="0">
                    <input type="hidden" name="extra_use_permillage" id="extra_use_permillage" value="0">
                    
                    <div class="modal-header">
                        <h5 class="modal-title">Gerar Quotas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    
                    <div class="modal-body">
                        <!-- Progress Steps Indicator -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center" style="width: 100%;">
                                <div class="step-indicator active" data-step="1">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Ano</div>
                                </div>
                                <div class="step-line"></div>
                                <div class="step-indicator" data-step="2">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Tipo</div>
                                </div>
                                <div class="step-line"></div>
                                <div class="step-indicator" data-step="3">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Configuração</div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 1: Year Selection -->
                        <div class="step-content" id="step1">
                            <div class="mb-3">
                                <label for="generate_fee_year" class="form-label">Ano <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="generate_fee_year" name="year" value="{{ current_year }}" min="2020" max="2100" required>
                                <small class="text-muted">Selecione o ano para o qual deseja gerar as quotas</small>
                            </div>
                        </div>

                        <!-- Step 2: Fee Type Selection -->
                        <div class="step-content" id="step2" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Quota <span class="text-danger">*</span></label>
                                <!-- Alert shown when annual fees already generated -->
                                <div class="alert alert-info mb-3" id="annual_fees_already_generated_alert" style="display: none;">
                                    <i class="bi bi-info-circle"></i> As quotas anuais já foram geradas para este ano. Apenas quotas extras podem ser criadas.
                                </div>
                                <!-- Annual fees option - disabled when already generated -->
                                <div class="form-check mb-2" id="fee_type_annual_container">
                                    <input class="form-check-input" type="radio" name="fee_type_radio" id="fee_type_annual" value="annual" checked>
                                    <label class="form-check-label" for="fee_type_annual" id="fee_type_annual_label">
                                        <strong>Quotas Anuais</strong> - Gerar para todos os 12 meses
                                    </label>
                                </div>
                                <div class="form-check" id="fee_type_extra_container">
                                    <input class="form-check-input" type="radio" name="fee_type_radio" id="fee_type_extra" value="extra">
                                    <label class="form-check-label" for="fee_type_extra">
                                        <strong>Quotas Extras</strong> - Para obras ou outros motivos específicos
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3A: Annual Fees Configuration -->
                        <div class="step-content" id="step3_annual" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Período das quotas <span class="text-danger">*</span></label>
                                <select class="form-select" id="period_type" name="period_type">
                                    <option value="monthly">Mensal (12 quotas)</option>
                                    <option value="bimonthly">Bimensal (6 quotas)</option>
                                    <option value="quarterly">Trimestral (4 quotas)</option>
                                    <option value="semiannual">Semestral (2 quotas)</option>
                                    <option value="annual">Anual (1 quota)</option>
                                </select>
                                <small class="text-muted">O valor anual será dividido conforme o período escolhido</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Método de Geração <span class="text-danger">*</span></label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="annual_type_radio" id="annual_type_budget" value="budget">
                                    <label class="form-check-label" for="annual_type_budget">
                                        <strong>Com base no orçamento e permilagem</strong>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="annual_type_radio" id="annual_type_manual" value="manual">
                                    <label class="form-check-label" for="annual_type_manual">
                                        <strong>Manual</strong>
                                    </label>
                                </div>
                            </div>

                            <!-- Budget-based generation -->
                            <div id="annual_budget_section" style="display: none;">
                                <div id="budget_status_info" class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> <span id="budget_status_text">A verificar status do orçamento...</span>
                                </div>
                                <div id="budget_generate_button" style="display: none;">
                                    <button type="button" class="btn btn-success w-100" id="generateFromBudgetBtn">
                                        <i class="bi bi-calculator"></i> Gerar Automaticamente para Todos os Meses
                                    </button>
                                </div>
                            </div>

                            <!-- Manual generation -->
                            <div id="annual_manual_section" style="display: none;">
                                <div class="mb-3">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="manual_use_permillage_check" value="1">
                                        <label class="form-check-label" for="manual_use_permillage_check">
                                            Aplicar permilagem
                                        </label>
                                    </div>
                                </div>

                                <!-- Manual with permillage -->
                                <div id="manual_with_permillage" style="display: none;">
                                    <div class="mb-3">
                                        <label for="total_amount" class="form-label">Valor Total da Quota Anual (€) <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="total_amount" name="total_amount" step="0.01" min="0.01" placeholder="0.00">
                                        <small class="text-muted">Valor total anual que será distribuído mensalmente e por permilagem</small>
                                    </div>
                                </div>

                                <!-- Manual without permillage -->
                                <div id="manual_without_permillage" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Valor Anual por Fração (€) <span class="text-danger">*</span></label>
                                        <div style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                                            <table class="table table-sm mb-0">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 30%;">Fração</th>
                                                        <th style="width: 70%;">Valor Anual (€)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for fraction in fractions %}
                                                    <tr>
                                                        <td>{{ fraction.identifier }}</td>
                                                        <td>
                                                            <input type="number" 
                                                                   class="form-control form-control-sm fraction-amount-input" 
                                                                   name="fraction_amounts[{{ fraction.id }}]" 
                                                                   id="fraction_amount_{{ fraction.id }}"
                                                                   step="0.01" 
                                                                   min="0" 
                                                                   placeholder="0.00"
                                                                   style="max-width: 200px;">
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <small class="text-muted">Defina o valor anual para cada fração. O valor será dividido conforme o período selecionado.</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3B: Extra Fees Configuration -->
                        <div class="step-content" id="step3_extra" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Método de Geração <span class="text-danger">*</span></label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="extra_type_radio" id="extra_type_permillage" value="permillage">
                                    <label class="form-check-label" for="extra_type_permillage">
                                        <strong>À permilagem</strong>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="extra_type_radio" id="extra_type_manual" value="manual">
                                    <label class="form-check-label" for="extra_type_manual">
                                        <strong>Manual</strong>
                                    </label>
                                </div>
                            </div>

                            <!-- Extra months selection -->
                            <div class="mb-3">
                                <label class="form-label">Meses <span class="text-danger">*</span></label>
                                <div class="row g-2">
                                    {% set month_names = {
                                        1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
                                        5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                                        9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
                                    } %}
                                    {% for month_num in 1..12 %}
                                    <div class="col-6 col-md-4 col-lg-3">
                                        <div class="form-check">
                                            <input class="form-check-input extra-month-checkbox" type="checkbox" name="months[]" value="{{ month_num }}" id="extra_month_{{ month_num }}">
                                            <label class="form-check-label" for="extra_month_{{ month_num }}">
                                                {{ month_num }} - {{ month_names[month_num] }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted d-block mt-1">Selecione um ou mais meses para gerar as quotas extras</small>
                            </div>

                            <!-- Extra description -->
                            <div class="mb-3">
                                <label for="extra_description" class="form-label">Motivo/Descrição</label>
                                <textarea class="form-control" id="extra_description" name="extra_description" rows="2" placeholder="Ex: Obras no telhado, Reparação do elevador, etc."></textarea>
                                <small class="text-muted">Descrição do motivo da quota extra</small>
                            </div>

                            <!-- Extra with permillage -->
                            <div id="extra_with_permillage" style="display: none;">
                                <div class="mb-3">
                                    <label for="extra_total_amount" class="form-label">Valor Total da Quota Anual (€) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="extra_total_amount" name="extra_total_amount" step="0.01" min="0.01" placeholder="0.00">
                                    <small class="text-muted">Valor total anual que será distribuído por permilagem</small>
                                </div>
                            </div>

                            <!-- Extra manual -->
                            <div id="extra_manual" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Valor Anual por Fração (€) <span class="text-danger">*</span></label>
                                    <div style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 30%;">Fração</th>
                                                    <th style="width: 70%;">Valor Anual (€)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for fraction in fractions %}
                                                <tr>
                                                    <td>{{ fraction.identifier }}</td>
                                                    <td>
                                                        <input type="number" 
                                                               class="form-control form-control-sm extra-fraction-amount-input" 
                                                               name="extra_fraction_amounts[{{ fraction.id }}]" 
                                                               id="extra_fraction_amount_{{ fraction.id }}"
                                                               step="0.01" 
                                                               min="0" 
                                                               placeholder="0.00"
                                                               style="max-width: 200px;">
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <small class="text-muted">Defina o valor anual para cada fração</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="btnCancel" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-secondary" id="btnBack" style="display: none;">Voltar</button>
                        <button type="button" class="btn btn-primary" id="btnNext">Continuar</button>
                        <button type="submit" class="btn btn-primary" id="btnSubmit" style="display: none;">Gerar Quotas</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Liquidar Quotas -->
    <div class="modal fade" id="liquidateQuotasModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Liquidar Quotas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% include 'blocks/liquidate-quotas-form.html.twig' with {
                        'condominium': condominium,
                        'fractions': fractions,
                        'bank_accounts': bank_accounts,
                        'csrf_token': csrf_token,
                        'form_id_prefix': 'lq_',
                        'is_modal': true
                    } %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="lq_form" class="btn btn-primary"><i class="bi bi-cash-coin"></i> Liquidar Quotas</button>
                </div>
                
                {% include 'blocks/liquidate-quotas-script.html.twig' with {
                    'condominium_id': condominium.id,
                    'form_id_prefix': 'lq_',
                    'modal_id': 'liquidateQuotasModal'
                } %}
            </div>
        </div>
    </div>

    <style>
        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 0 auto;
            min-width: 80px;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 5px;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .step-indicator.active .step-number {
            background-color: #0d6efd;
            color: white;
        }
        .step-indicator.completed .step-number {
            background-color: #198754;
            color: white;
        }
        .step-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }
        .step-indicator.active .step-label {
            color: #0d6efd;
            font-weight: 600;
        }
        .step-indicator.completed .step-label {
            color: #198754;
        }
        .step-line {
            flex: 1 1 auto;
            height: 2px;
            background-color: #e9ecef;
            margin: 0 10px;
            margin-top: -20px;
            align-self: center;
            min-width: 20px;
            max-width: 100%;
        }
        .step-content {
            min-height: 300px;
        }
        .form-check input[type="radio"]:disabled + label {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .form-check input[type="radio"]:disabled {
            cursor: not-allowed;
        }
        .form-check:has(input[type="radio"]:disabled) {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>

    <script>
        // Function to filter fees and scroll to filters
        function filterFees() {
            const form = document.getElementById('filtersForm');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            // Add all form fields to params (incluir year, month e per_page mesmo vazios)
            for (const [key, value] of formData.entries()) {
                if (value || ['year', 'month', 'per_page'].includes(key)) {
                    params.append(key, value);
                }
            }
            params.set('page', '1');  // Ao filtrar, voltar à primeira página
            
            // Build URL with filters
            const url = form.action + (params.toString() ? '?' + params.toString() : '');
            
            // Submit form normally but scroll to filters after load
            window.location.href = url + '#filtersForm';
        }

        function changePerPage(perPage) {
            const form = document.getElementById('filtersForm');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                if (value || ['year', 'month'].includes(key)) params.append(key, value);
            }
            params.set('per_page', perPage);
            params.set('page', '1');
            const url = form.action + (params.toString() ? '?' + params.toString() : '');
            window.location.href = url;
        }
        
        // Scroll to filters if hash is present
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash === '#filtersForm') {
                setTimeout(function() {
                    const filtersForm = document.getElementById('filtersForm');
                    if (filtersForm) {
                        filtersForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        });
        
        // Multi-step wizard for fee generation
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 1;
            const form = document.getElementById('generateFeesForm');
            const yearInput = document.getElementById('generate_fee_year');
            let selectedFeeMode = 'annual';
            let selectedAnnualType = '';
            let selectedExtraType = '';
            let budgetStatus = null;
            let annualFeesGeneratedFlag = false; // Track if annual fees are already generated

            // Step indicators
            const stepIndicators = document.querySelectorAll('.step-indicator');
            const stepContents = document.querySelectorAll('.step-content');
            const btnNext = document.getElementById('btnNext');
            const btnBack = document.getElementById('btnBack');
            const btnSubmit = document.getElementById('btnSubmit');
            const btnCancel = document.getElementById('btnCancel');

            // Update step indicators
            function updateStepIndicators(step) {
                stepIndicators.forEach((indicator, index) => {
                    if (index + 1 < step) {
                        indicator.classList.add('completed');
                        indicator.classList.remove('active');
                    } else if (index + 1 === step) {
                        indicator.classList.add('active');
                        indicator.classList.remove('completed');
                    } else {
                        indicator.classList.remove('active', 'completed');
                    }
                });
            }

            // Show step
            function showStep(step) {
                stepContents.forEach(content => {
                    content.style.display = 'none';
                });

                if (step === 1) {
                    document.getElementById('step1').style.display = 'block';
                } else if (step === 2) {
                    document.getElementById('step2').style.display = 'block';
                    
                    // If flag is already true, immediately show annual option as disabled
                    if (annualFeesGeneratedFlag) {
                        const annualContainerImmediate = document.getElementById('fee_type_annual_container');
                        const annualFeesAlertImmediate = document.getElementById('annual_fees_already_generated_alert');
                        const feeTypeAnnualRadioImmediate = document.getElementById('fee_type_annual');
                        const annualLabelImmediate = document.getElementById('fee_type_annual_label');
                        const feeTypeExtraRadioImmediate = document.getElementById('fee_type_extra');
                        
                        if (annualContainerImmediate) {
                            annualContainerImmediate.style.display = 'block';
                            annualContainerImmediate.style.opacity = '0.6';
                            annualContainerImmediate.style.cursor = 'not-allowed';
                            annualContainerImmediate.style.pointerEvents = 'none';
                        }
                        if (annualFeesAlertImmediate) {
                            annualFeesAlertImmediate.style.display = 'block';
                        }
                        if (feeTypeAnnualRadioImmediate) {
                            feeTypeAnnualRadioImmediate.disabled = true;
                            feeTypeAnnualRadioImmediate.checked = false;
                        }
                        if (annualLabelImmediate) {
                            annualLabelImmediate.style.pointerEvents = 'none';
                            annualLabelImmediate.style.cursor = 'not-allowed';
                        }
                        if (feeTypeExtraRadioImmediate) {
                            feeTypeExtraRadioImmediate.checked = true;
                            selectedFeeMode = 'extra';
                            document.getElementById('fee_mode').value = 'extra';
                        }
                    }
                    
                    // Always check budget status when showing step 2 - this will update the UI
                    const year = parseInt(yearInput.value);
                    if (year && year >= 2020 && year <= 2100) {
                        // Reset to enabled state while checking (will be updated based on response)
                        if (!annualFeesGeneratedFlag) {
                            const annualContainerCheck = document.getElementById('fee_type_annual_container');
                            const annualFeesAlertCheck = document.getElementById('annual_fees_already_generated_alert');
                            const feeTypeAnnualRadioCheck = document.getElementById('fee_type_annual');
                            const annualLabelCheck = document.getElementById('fee_type_annual_label');
                            
                            if (annualContainerCheck) {
                                annualContainerCheck.style.display = 'block';
                                annualContainerCheck.style.opacity = '1';
                                annualContainerCheck.style.cursor = 'pointer';
                                annualContainerCheck.style.pointerEvents = 'auto';
                            }
                            if (annualFeesAlertCheck) {
                                annualFeesAlertCheck.style.display = 'none';
                            }
                            if (feeTypeAnnualRadioCheck) {
                                feeTypeAnnualRadioCheck.disabled = false;
                            }
                            if (annualLabelCheck) {
                                annualLabelCheck.style.pointerEvents = 'auto';
                                annualLabelCheck.style.cursor = 'pointer';
                            }
                        }
                        
                        checkBudgetStatus(year, true);
                    } else {
                        // If no valid year, ensure annual option is visible and enabled
                        const annualContainerNoYear = document.getElementById('fee_type_annual_container');
                        const annualFeesAlertNoYear = document.getElementById('annual_fees_already_generated_alert');
                        const feeTypeAnnualRadioNoYear = document.getElementById('fee_type_annual');
                        const annualLabelNoYear = document.getElementById('fee_type_annual_label');
                        
                        if (annualContainerNoYear) {
                            annualContainerNoYear.style.display = 'block';
                            annualContainerNoYear.style.opacity = '1';
                            annualContainerNoYear.style.cursor = 'pointer';
                            annualContainerNoYear.style.pointerEvents = 'auto';
                        }
                        if (annualFeesAlertNoYear) {
                            annualFeesAlertNoYear.style.display = 'none';
                        }
                        if (feeTypeAnnualRadioNoYear) {
                            feeTypeAnnualRadioNoYear.disabled = false;
                        }
                        if (annualLabelNoYear) {
                            annualLabelNoYear.style.pointerEvents = 'auto';
                            annualLabelNoYear.style.cursor = 'pointer';
                        }
                    }
                } else if (step === 3) {
                    if (selectedFeeMode === 'annual') {
                        document.getElementById('step3_annual').style.display = 'block';
                    } else {
                        document.getElementById('step3_extra').style.display = 'block';
                    }
                }

                updateStepIndicators(step);
                updateButtons();
            }

            // Update button visibility
            function updateButtons() {
                btnBack.style.display = currentStep > 1 ? 'inline-block' : 'none';
                btnNext.style.display = currentStep < 3 ? 'inline-block' : 'none';
                btnSubmit.style.display = currentStep === 3 ? 'inline-block' : 'none';
            }

            // Check budget status via AJAX
            function checkBudgetStatus(year, showInStep2 = false) {
                const condominiumId = {{ condominium.id }};
                const statusInfo = document.getElementById('budget_status_info');
                const statusText = document.getElementById('budget_status_text');
                const generateButton = document.getElementById('budget_generate_button');
                const annualFeesAlert = document.getElementById('annual_fees_already_generated_alert');
                const feeTypeExtraRadio = document.getElementById('fee_type_extra');
                const annualContainer = document.getElementById('fee_type_annual_container');

                // If flag is already true, immediately show annual option as disabled before AJAX
                if (annualFeesGeneratedFlag && (showInStep2 || currentStep === 2)) {
                    const annualLabel = document.getElementById('fee_type_annual_label');
                    const feeTypeAnnualRadio = document.getElementById('fee_type_annual');
                    
                    if (annualContainer) {
                        annualContainer.style.display = 'block';
                        annualContainer.style.opacity = '0.6';
                        annualContainer.style.cursor = 'not-allowed';
                        annualContainer.style.pointerEvents = 'none';
                    }
                    if (annualFeesAlert) {
                        annualFeesAlert.style.display = 'block';
                    }
                    if (feeTypeAnnualRadio) {
                        feeTypeAnnualRadio.disabled = true;
                        feeTypeAnnualRadio.checked = false;
                    }
                    if (annualLabel) {
                        annualLabel.style.pointerEvents = 'none';
                        annualLabel.style.cursor = 'not-allowed';
                    }
                    if (feeTypeExtraRadio) {
                        feeTypeExtraRadio.checked = true;
                        selectedFeeMode = 'extra';
                        document.getElementById('fee_mode').value = 'extra';
                    }
                }

                if (statusInfo && statusText) {
                    statusText.textContent = 'A verificar status do orçamento...';
                    statusInfo.className = 'alert alert-info';
                }

                fetch(`{{ BASE_URL }}condominiums/${condominiumId}/budgets/${year}/check-status`)
                    .then(response => response.json())
                    .then(data => {
                        budgetStatus = data;
                        
                        // Update the global flag - ensure boolean conversion
                        annualFeesGeneratedFlag = Boolean(data.annual_fees_generated);
                        
                        // Always update step 2 options if we're on step 2 or if explicitly requested
                        if (showInStep2 || currentStep === 2) {
                            // Re-fetch elements to ensure they exist
                            const annualContainerEl = document.getElementById('fee_type_annual_container');
                            const annualFeesAlertEl = document.getElementById('annual_fees_already_generated_alert');
                            const feeTypeExtraRadioEl = document.getElementById('fee_type_extra');
                            const feeTypeAnnualRadioEl = document.getElementById('fee_type_annual');
                            const annualLabelEl = document.getElementById('fee_type_annual_label');
                            
                            if (annualFeesGeneratedFlag) {
                                // Show annual fees option as disabled with message
                                if (annualContainerEl) {
                                    annualContainerEl.style.display = 'block';
                                    annualContainerEl.style.opacity = '0.6';
                                    annualContainerEl.style.cursor = 'not-allowed';
                                    annualContainerEl.style.pointerEvents = 'none';
                                }
                                if (annualFeesAlertEl) {
                                    annualFeesAlertEl.style.display = 'block';
                                }
                                if (feeTypeAnnualRadioEl) {
                                    feeTypeAnnualRadioEl.disabled = true;
                                    feeTypeAnnualRadioEl.checked = false;
                                }
                                if (annualLabelEl) {
                                    annualLabelEl.style.pointerEvents = 'none';
                                    annualLabelEl.style.cursor = 'not-allowed';
                                }
                                if (feeTypeExtraRadioEl) {
                                    feeTypeExtraRadioEl.checked = true;
                                    selectedFeeMode = 'extra';
                                    const feeModeInput = document.getElementById('fee_mode');
                                    if (feeModeInput) {
                                        feeModeInput.value = 'extra';
                                    }
                                }
                            } else {
                                // Show annual fees option as enabled and hide message
                                if (annualContainerEl) {
                                    annualContainerEl.style.display = 'block';
                                    annualContainerEl.style.opacity = '1';
                                    annualContainerEl.style.cursor = 'pointer';
                                    annualContainerEl.style.pointerEvents = 'auto';
                                }
                                if (annualFeesAlertEl) {
                                    annualFeesAlertEl.style.display = 'none';
                                }
                                if (feeTypeAnnualRadioEl) {
                                    feeTypeAnnualRadioEl.disabled = false;
                                }
                                if (annualLabelEl) {
                                    annualLabelEl.style.pointerEvents = 'auto';
                                    annualLabelEl.style.cursor = 'pointer';
                                }
                            }
                        }
                        
                        // Update budget status info (for step 3)
                        if (statusInfo && statusText) {
                            if (data.exists) {
                                if (data.annual_fees_generated) {
                                    statusInfo.className = 'alert alert-warning';
                                    statusText.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + data.message;
                                    if (generateButton) {
                                        generateButton.style.display = 'none';
                                    }
                                } else if (data.approved) {
                                    statusInfo.className = 'alert alert-success';
                                    statusText.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                                    if (generateButton) {
                                        generateButton.style.display = 'block';
                                    }
                                } else {
                                    statusInfo.className = 'alert alert-danger';
                                    statusText.innerHTML = '<i class="bi bi-x-circle"></i> ' + data.message;
                                    if (generateButton) {
                                        generateButton.style.display = 'none';
                                    }
                                }
                            } else {
                                statusInfo.className = 'alert alert-warning';
                                statusText.innerHTML = '<i class="bi bi-info-circle"></i> ' + data.message;
                                if (generateButton) {
                                    generateButton.style.display = 'none';
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao verificar orçamento:', error);
                        if (statusInfo && statusText) {
                            statusInfo.className = 'alert alert-danger';
                            statusText.innerHTML = '<i class="bi bi-x-circle"></i> Erro ao verificar status do orçamento.';
                        }
                        if (generateButton) {
                            generateButton.style.display = 'none';
                        }
                        // If we're on step 2 and flag is true, keep annual option disabled
                        if ((showInStep2 || currentStep === 2) && annualFeesGeneratedFlag) {
                            const annualContainerError = document.getElementById('fee_type_annual_container');
                            const annualFeesAlertError = document.getElementById('annual_fees_already_generated_alert');
                            const feeTypeExtraRadioError = document.getElementById('fee_type_extra');
                            const feeTypeAnnualRadioError = document.getElementById('fee_type_annual');
                            const annualLabelError = document.getElementById('fee_type_annual_label');
                            
                            if (annualContainerError) {
                                annualContainerError.style.display = 'block';
                                annualContainerError.style.opacity = '0.6';
                                annualContainerError.style.cursor = 'not-allowed';
                                annualContainerError.style.pointerEvents = 'none';
                            }
                            if (annualFeesAlertError) {
                                annualFeesAlertError.style.display = 'block';
                            }
                            if (feeTypeAnnualRadioError) {
                                feeTypeAnnualRadioError.disabled = true;
                                feeTypeAnnualRadioError.checked = false;
                            }
                            if (annualLabelError) {
                                annualLabelError.style.pointerEvents = 'none';
                                annualLabelError.style.cursor = 'not-allowed';
                            }
                            if (feeTypeExtraRadioError) {
                                feeTypeExtraRadioError.checked = true;
                                selectedFeeMode = 'extra';
                                document.getElementById('fee_mode').value = 'extra';
                            }
                        }
                    });
            }

            // Validate step
            function validateStep(step) {
                if (step === 1) {
                    const year = parseInt(yearInput.value);
                    if (!year || year < 2020 || year > 2100) {
                        alert('Por favor, selecione um ano válido.');
                        return false;
                    }
                    return true;
                } else if (step === 2) {
                    const feeTypeRadio = document.querySelector('input[name="fee_type_radio"]:checked');
                    if (!feeTypeRadio) {
                        alert('Por favor, selecione o tipo de quota.');
                        return false;
                    }
                    
                    // If annual fees already generated, ensure extra is selected (annual should be hidden)
                    if (annualFeesGeneratedFlag && feeTypeRadio.value === 'annual') {
                        const extraRadio = document.getElementById('fee_type_extra');
                        if (extraRadio) {
                            extraRadio.checked = true;
                            selectedFeeMode = 'extra';
                            document.getElementById('fee_mode').value = 'extra';
                        }
                        return false;
                    }
                    
                    selectedFeeMode = feeTypeRadio.value;
                    document.getElementById('fee_mode').value = selectedFeeMode;
                    return true;
                } else if (step === 3) {
                    if (selectedFeeMode === 'annual') {
                        const annualTypeRadio = document.querySelector('input[name="annual_type_radio"]:checked');
                        if (!annualTypeRadio) {
                            alert('Por favor, selecione o método de geração.');
                            return false;
                        }
                        selectedAnnualType = annualTypeRadio.value;
                        document.getElementById('annual_type').value = selectedAnnualType;

                        if (selectedAnnualType === 'budget') {
                            // Budget-based: check if can generate
                            if (!budgetStatus || !budgetStatus.approved || budgetStatus.annual_fees_generated) {
                                alert('Não é possível gerar quotas automaticamente. Verifique o status do orçamento.');
                                return false;
                            }
                            return true;
                        } else {
                            // Manual
                            const usePermillage = document.getElementById('manual_use_permillage_check').checked;
                            document.getElementById('manual_use_permillage').value = usePermillage ? '1' : '0';

                            if (usePermillage) {
                                const totalAmount = parseFloat(document.getElementById('total_amount').value);
                                if (!totalAmount || totalAmount <= 0) {
                                    alert('Por favor, insira um valor total válido.');
                                    return false;
                                }
                            } else {
                                const fractionInputs = document.querySelectorAll('.fraction-amount-input');
                                let hasValue = false;
                                fractionInputs.forEach(input => {
                                    if (parseFloat(input.value) > 0) {
                                        hasValue = true;
                                    }
                                });
                                if (!hasValue) {
                                    alert('Por favor, insira valores para pelo menos uma fração.');
                                    return false;
                                }
                            }
                            return true;
                        }
                    } else {
                        // Extra fees
                        const extraTypeRadio = document.querySelector('input[name="extra_type_radio"]:checked');
                        if (!extraTypeRadio) {
                            alert('Por favor, selecione o método de geração.');
                            return false;
                        }
                        selectedExtraType = extraTypeRadio.value;
                        document.getElementById('extra_use_permillage').value = selectedExtraType === 'permillage' ? '1' : '0';

                        const monthsChecked = document.querySelectorAll('.extra-month-checkbox:checked');
                        if (monthsChecked.length === 0) {
                            alert('Por favor, selecione pelo menos um mês.');
                            return false;
                        }

                        if (selectedExtraType === 'permillage') {
                            const totalAmount = parseFloat(document.getElementById('extra_total_amount').value);
                            if (!totalAmount || totalAmount <= 0) {
                                alert('Por favor, insira um valor total válido.');
                                return false;
                            }
                        } else {
                            const fractionInputs = document.querySelectorAll('.extra-fraction-amount-input');
                            let hasValue = false;
                            fractionInputs.forEach(input => {
                                if (parseFloat(input.value) > 0) {
                                    hasValue = true;
                                }
                            });
                            if (!hasValue) {
                                alert('Por favor, insira valores para pelo menos uma fração.');
                                return false;
                            }
                        }
                        return true;
                    }
                }
                return true;
            }

            // Next button
            btnNext.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    if (currentStep === 1) {
                        // Check budget status BEFORE moving to step 2
                        const year = parseInt(yearInput.value);
                        
                        // Show step 2 first
                        currentStep = 2;
                        showStep(currentStep);
                        
                        // Then check and update options (this will hide annual option if needed)
                        checkBudgetStatus(year, true); // Pass true to update step 2 options
                    } else if (currentStep === 2) {
                        currentStep = 3;
                        showStep(currentStep);
                        // Show appropriate sections based on selections
                        if (selectedFeeMode === 'annual') {
                            const annualTypeRadio = document.querySelector('input[name="annual_type_radio"]:checked');
                            if (annualTypeRadio) {
                                selectedAnnualType = annualTypeRadio.value;
                                if (selectedAnnualType === 'budget') {
                                    document.getElementById('annual_budget_section').style.display = 'block';
                                    document.getElementById('annual_manual_section').style.display = 'none';
                                } else {
                                    document.getElementById('annual_budget_section').style.display = 'none';
                                    document.getElementById('annual_manual_section').style.display = 'block';
                                    
                                    // Initialize manual section display based on checkbox state
                                    const manualPermillageCheck = document.getElementById('manual_use_permillage_check');
                                    if (manualPermillageCheck) {
                                        if (manualPermillageCheck.checked) {
                                            document.getElementById('manual_with_permillage').style.display = 'block';
                                            document.getElementById('manual_without_permillage').style.display = 'none';
                                        } else {
                                            document.getElementById('manual_with_permillage').style.display = 'none';
                                            document.getElementById('manual_without_permillage').style.display = 'block';
                                        }
                                    } else {
                                        // Default: show without permillage
                                        document.getElementById('manual_with_permillage').style.display = 'none';
                                        document.getElementById('manual_without_permillage').style.display = 'block';
                                    }
                                }
                            }
                        }
                    }
                }
            });

            // Back button
            btnBack.addEventListener('click', function() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            });

            // Fee type radio change
            document.querySelectorAll('input[name="fee_type_radio"]').forEach(radio => {
                radio.addEventListener('change', function(e) {
                    // If annual fees already generated, prevent selecting annual (shouldn't happen as it's hidden)
                    if (this.value === 'annual' && annualFeesGeneratedFlag) {
                        e.preventDefault();
                        e.stopPropagation();
                        const extraRadio = document.getElementById('fee_type_extra');
                        if (extraRadio) {
                            extraRadio.checked = true;
                            selectedFeeMode = 'extra';
                            document.getElementById('fee_mode').value = 'extra';
                        }
                        this.checked = false;
                        return false;
                    }
                    
                    selectedFeeMode = this.value;
                    document.getElementById('fee_mode').value = selectedFeeMode;
                });
            });

            // Annual type radio change
            document.querySelectorAll('input[name="annual_type_radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedAnnualType = this.value;
                    if (this.value === 'budget') {
                        document.getElementById('annual_budget_section').style.display = 'block';
                        document.getElementById('annual_manual_section').style.display = 'none';
                    } else {
                        document.getElementById('annual_budget_section').style.display = 'none';
                        document.getElementById('annual_manual_section').style.display = 'block';
                        
                        // Initialize manual section display based on checkbox state
                        const manualPermillageCheck = document.getElementById('manual_use_permillage_check');
                        if (manualPermillageCheck) {
                            if (manualPermillageCheck.checked) {
                                document.getElementById('manual_with_permillage').style.display = 'block';
                                document.getElementById('manual_without_permillage').style.display = 'none';
                            } else {
                                document.getElementById('manual_with_permillage').style.display = 'none';
                                document.getElementById('manual_without_permillage').style.display = 'block';
                            }
                        } else {
                            // Default: show without permillage if checkbox doesn't exist
                            document.getElementById('manual_with_permillage').style.display = 'none';
                            document.getElementById('manual_without_permillage').style.display = 'block';
                        }
                    }
                });
            });

            // Manual use permillage checkbox
            const manualPermillageCheck = document.getElementById('manual_use_permillage_check');
            if (manualPermillageCheck) {
                manualPermillageCheck.addEventListener('change', function() {
                    if (this.checked) {
                        document.getElementById('manual_with_permillage').style.display = 'block';
                        document.getElementById('manual_without_permillage').style.display = 'none';
                    } else {
                        document.getElementById('manual_with_permillage').style.display = 'none';
                        document.getElementById('manual_without_permillage').style.display = 'block';
                    }
                });
            }

            // Extra type radio change
            document.querySelectorAll('input[name="extra_type_radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedExtraType = this.value;
                    if (this.value === 'permillage') {
                        document.getElementById('extra_with_permillage').style.display = 'block';
                        document.getElementById('extra_manual').style.display = 'none';
                    } else {
                        document.getElementById('extra_with_permillage').style.display = 'none';
                        document.getElementById('extra_manual').style.display = 'block';
                    }
                });
            });

            // Generate from budget button
            const generateFromBudgetBtn = document.getElementById('generateFromBudgetBtn');
            if (generateFromBudgetBtn) {
                generateFromBudgetBtn.addEventListener('click', function() {
                    if (validateStep(3)) {
                        form.submit();
                    }
                });
            }

            // Form submit
            form.addEventListener('submit', function(e) {
                if (!validateStep(currentStep)) {
                    e.preventDefault();
                    return false;
                }
            });

            // Reset modal on close
            const modal = document.getElementById('generateFeesModal');
            if (modal) {
                // Reset flag when modal opens
                modal.addEventListener('show.bs.modal', function() {
                    annualFeesGeneratedFlag = false;
                    budgetStatus = null;
                });
                
                modal.addEventListener('hidden.bs.modal', function() {
                    currentStep = 1;
                    selectedFeeMode = 'annual';
                    selectedAnnualType = '';
                    selectedExtraType = '';
                    budgetStatus = null;
                    annualFeesGeneratedFlag = false; // Reset flag when modal closes
                    form.reset();
                    
                    // Reset fee type radio buttons
                    const feeTypeAnnualRadio = document.getElementById('fee_type_annual');
                    const feeTypeExtraRadio = document.getElementById('fee_type_extra');
                    const annualContainerReset = document.getElementById('fee_type_annual_container');
                    const annualFeesAlertReset = document.getElementById('annual_fees_already_generated_alert');
                    const annualLabelReset = document.getElementById('fee_type_annual_label');
                    
                    // Show annual option as enabled and hide alert
                    if (annualContainerReset) {
                        annualContainerReset.style.display = 'block';
                        annualContainerReset.style.opacity = '1';
                        annualContainerReset.style.cursor = 'pointer';
                        annualContainerReset.style.pointerEvents = 'auto';
                    }
                    if (annualFeesAlertReset) {
                        annualFeesAlertReset.style.display = 'none';
                    }
                    if (feeTypeAnnualRadio) {
                        feeTypeAnnualRadio.disabled = false;
                        feeTypeAnnualRadio.checked = true;
                    }
                    if (annualLabelReset) {
                        annualLabelReset.style.pointerEvents = 'auto';
                        annualLabelReset.style.cursor = 'pointer';
                    }
                    if (feeTypeExtraRadio) {
                        feeTypeExtraRadio.checked = false;
                    }
                    
                    // Reset all sections to hidden
                    document.getElementById('annual_budget_section').style.display = 'none';
                    document.getElementById('annual_manual_section').style.display = 'none';
                    document.getElementById('manual_with_permillage').style.display = 'none';
                    document.getElementById('manual_without_permillage').style.display = 'none';
                    document.getElementById('extra_with_permillage').style.display = 'none';
                    document.getElementById('extra_manual').style.display = 'none';
                    
                    showStep(1);
                });
            }

            // Year input change - check status when year changes
            yearInput.addEventListener('change', function() {
                const year = parseInt(this.value);
                if (year && year >= 2020 && year <= 2100) {
                    // Reset flag when year changes (will be updated by checkBudgetStatus)
                    annualFeesGeneratedFlag = false;
                    
                    // Reset annual option to enabled state (will be updated if needed after AJAX response)
                    const annualContainerTemp = document.getElementById('fee_type_annual_container');
                    const annualFeesAlertTemp = document.getElementById('annual_fees_already_generated_alert');
                    const feeTypeAnnualRadioTemp = document.getElementById('fee_type_annual');
                    const annualLabelTemp = document.getElementById('fee_type_annual_label');
                    
                    if (annualContainerTemp) {
                        annualContainerTemp.style.display = 'block';
                        annualContainerTemp.style.opacity = '1';
                        annualContainerTemp.style.cursor = 'pointer';
                        annualContainerTemp.style.pointerEvents = 'auto';
                    }
                    if (annualFeesAlertTemp) {
                        annualFeesAlertTemp.style.display = 'none';
                    }
                    if (feeTypeAnnualRadioTemp) {
                        feeTypeAnnualRadioTemp.disabled = false;
                    }
                    if (annualLabelTemp) {
                        annualLabelTemp.style.pointerEvents = 'auto';
                        annualLabelTemp.style.cursor = 'pointer';
                    }
                    
                    // If we're on step 2, update the options
                    const isStep2 = currentStep === 2;
                    checkBudgetStatus(year, isStep2);
                }
            });

            // Initialize
            showStep(1);
        });
    </script>

    <div class="mt-3">
        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/finances" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar às Finanças
        </a>
    </div>
</div>

<!-- Modal para Registar Pagamento -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="paymentForm" onsubmit="syncPaymentMethodBeforeSubmit(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="payment_method" id="payment_method_hidden" value="">
                {% if selected_year is defined %}<input type="hidden" name="redirect_year" value="{{ selected_year }}">{% endif %}
                {% if selected_month is defined %}<input type="hidden" name="redirect_month" value="{{ selected_month }}">{% endif %}
                {% if selected_status is defined %}<input type="hidden" name="redirect_status" value="{{ selected_status }}">{% endif %}
                {% if selected_fraction is defined %}<input type="hidden" name="redirect_fraction_id" value="{{ selected_fraction }}">{% endif %}
                {% if show_historical is defined and show_historical %}<input type="hidden" name="redirect_show_historical" value="1">{% endif %}
                {% if selected_fees_year is defined %}<input type="hidden" name="redirect_fees_year" value="{{ selected_fees_year }}">{% endif %}
                <div class="modal-body">
                    <div id="feeInfo" class="alert alert-info mb-3" style="display: block !important;">
                        <small>Carregando informações...</small>
                    </div>

                    {# Movimento Financeiro - no topo para definir fluxo (criar vs associar) #}
                    <div class="mb-3">
                        <label class="form-label">Movimento Financeiro <span class="text-danger">*</span></label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="transaction_action" id="transaction_create" value="create" checked onchange="toggleTransactionFields()">
                            <label class="form-check-label" for="transaction_create">
                                Criar novo movimento financeiro
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="transaction_action" id="transaction_associate" value="associate" onchange="toggleTransactionFields()">
                            <label class="form-check-label" for="transaction_associate">
                                Associar a movimento existente
                            </label>
                        </div>
                    </div>

                    <div id="create-transaction-fields">
                        <div class="mb-3">
                            <label for="bank_account_id" class="form-label">Conta Bancária</label>
                            <select class="form-select" id="bank_account_id" name="bank_account_id">
                                <option value="">Selecione...</option>
                                {% if bank_accounts %}
                                {% set main_bank_account = null %}
                                {% set cash_account = null %}
                                {% for account in bank_accounts %}
                                    {% if account.account_type == 'bank' and main_bank_account == null %}
                                        {% set main_bank_account = account %}
                                    {% endif %}
                                    {% if account.account_type == 'cash' and cash_account == null %}
                                        {% set cash_account = account %}
                                    {% endif %}
                                {% endfor %}
                                {% for account in bank_accounts %}
                                <option value="{{ account.id }}" 
                                        {% if account.account_type == 'bank' and main_bank_account and account.id == main_bank_account.id %}data-is-main-bank="true"{% endif %}
                                        {% if account.account_type == 'cash' %}data-is-cash="true"{% endif %}>
                                    {{ account.name }} {% if account.account_type == 'cash' %}(Caixa){% endif %}
                                </option>
                                {% endfor %}
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">Selecionada automaticamente conforme o método de pagamento</small>
                        </div>
                    </div>

                    <div id="associate-transaction-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="payment_method_associate" class="form-label">Método de Pagamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="payment_method_associate" required onchange="handleAssociateMethodChange(); syncPaymentMethodHidden();">
                                <option value="">Selecione o método (transferência ou dinheiro)...</option>
                                <option value="transfer">Transferência (banco)</option>
                                <option value="cash">Dinheiro (caixa)</option>
                            </select>
                            <small class="form-text text-muted">Selecione primeiro para filtrar os movimentos por conta bancária ou caixa</small>
                        </div>
                        <div class="mb-3">
                            <label for="existing_transaction_id" class="form-label">Movimento Existente <span class="text-danger">*</span></label>
                            <select class="form-select" id="existing_transaction_id" name="existing_transaction_id" onchange="handleExistingTransactionChange()" disabled>
                                <option value="">Selecione um movimento...</option>
                                {% if available_transactions %}
                                {% for transaction in available_transactions %}
                                {% if transaction.transaction_type == 'income' and not transaction.related_id %}
                                <option value="{{ transaction.id }}" data-transaction-date="{{ transaction.transaction_date|date('Y-m-d') }}" data-account-type="{{ transaction.account_type|default('bank') }}" data-amount="{{ transaction.amount }}">
                                    {{ transaction.transaction_date|date('d/m/Y') }} - 
                                    {{ transaction.description|slice(0, 50) }}{% if transaction.description|length > 50 %}...{% endif %} - 
                                    €{{ transaction.amount|number_format(2, ',', '.') }} 
                                    ({{ transaction.account_name }})
                                </option>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                            </select>
                            <small class="form-text text-muted" id="associateTransactionHint">Selecione o método de pagamento para ver os movimentos disponíveis</small>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3" id="payment-method-create-wrapper">
                        <label for="payment_method" class="form-label">Método de Pagamento <span class="text-danger">*</span></label>
                        <select class="form-select" id="payment_method" required onchange="handlePaymentMethodChange(); syncPaymentMethodHidden();">
                            <option value="">Selecione...</option>
                            <option value="transfer">Transferência</option>
                            <option value="cash">Dinheiro</option>
                        </select>
                        <small class="form-text text-muted">Selecionada automaticamente conforme o método de pagamento</small>
                    </div>

                    <div class="mb-3">
                        <label for="payment_amount" class="form-label">Valor do Pagamento (€) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="number" class="form-control" id="payment_amount" name="amount" 
                                   step="0.01" min="0.01" required placeholder="0.00">
                        </div>
                        <small class="text-muted" id="maxAmountHint">Valor máximo: €0,00</small>
                    </div>

                    <div class="mb-3">
                        <label for="payment_date" class="form-label">Data do Pagamento <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date" 
                               value="{{ "now"|date("Y-m-d") }}" required>
                        <small class="form-text text-muted" id="paymentDateHint" style="display: none;">Com "Associar existente", a data é preenchida pela data do movimento selecionado</small>
                    </div>

                    <div class="mb-3">
                        <label for="payment_reference" class="form-label">Referência</label>
                        <input type="text" class="form-control" id="payment_reference" name="reference" 
                               readonly style="background-color: #e9ecef; cursor: not-allowed;">
                        <small class="form-text text-muted">Referência gerada automaticamente</small>
                    </div>

                    <div class="mb-3">
                        <label for="payment_notes" class="form-label">Notas</label>
                        <textarea class="form-control" id="payment_notes" name="notes" rows="2" 
                                  placeholder="Informações adicionais sobre o pagamento"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnRegistarPagamento">Registar Pagamento</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
let currentFeeId = null;

function toggleTransactionFields() {
    const createRadio = document.getElementById('transaction_create');
    const createFields = document.getElementById('create-transaction-fields');
    const associateFields = document.getElementById('associate-transaction-fields');
    const paymentMethodCreateWrapper = document.getElementById('payment-method-create-wrapper');
    const bankAccountSelect = document.getElementById('bank_account_id');
    const transactionSelect = document.getElementById('existing_transaction_id');
    const paymentMethodAssociate = document.getElementById('payment_method_associate');
    const paymentDateInput = document.getElementById('payment_date');
    const paymentDateHint = document.getElementById('paymentDateHint');
    
    if (createRadio.checked) {
        createFields.style.display = 'block';
        associateFields.style.display = 'none';
        if (paymentMethodCreateWrapper) paymentMethodCreateWrapper.style.display = 'block';
        const methodCreate = document.getElementById('payment_method');
        if (methodCreate) methodCreate.setAttribute('required', 'required');
        bankAccountSelect.removeAttribute('required');
        transactionSelect.removeAttribute('required');
        transactionSelect.value = '';
        if (paymentMethodAssociate) {
            paymentMethodAssociate.value = '';
            paymentMethodAssociate.removeAttribute('required');
        }
        if (transactionSelect) transactionSelect.disabled = true;
        if (paymentDateInput) paymentDateInput.value = new Date().toISOString().slice(0, 10);
        if (paymentDateHint) paymentDateHint.style.display = 'none';
        handlePaymentMethodChange();
        syncPaymentMethodHidden();
    } else {
        createFields.style.display = 'none';
        if (paymentMethodCreateWrapper) paymentMethodCreateWrapper.style.display = 'none';
        associateFields.style.display = 'block';
        const methodCreate = document.getElementById('payment_method');
        if (methodCreate) methodCreate.removeAttribute('required');
        bankAccountSelect.removeAttribute('required');
        bankAccountSelect.value = '';
        transactionSelect.setAttribute('required', 'required');
        if (paymentMethodAssociate) paymentMethodAssociate.setAttribute('required', 'required');
        if (paymentDateInput) paymentDateInput.value = '';
        if (paymentDateHint) paymentDateHint.style.display = 'block';
        transactionSelect.value = '';
        if (transactionSelect) transactionSelect.disabled = true;
        handleAssociateMethodChange();
        syncPaymentMethodHidden();
    }
}

function syncPaymentMethodHidden() {
    const hidden = document.getElementById('payment_method_hidden');
    const createRadio = document.getElementById('transaction_create');
    const methodCreate = document.getElementById('payment_method');
    const methodAssociate = document.getElementById('payment_method_associate');
    if (!hidden) return;
    const source = createRadio && createRadio.checked ? methodCreate : methodAssociate;
    hidden.value = source && source.value ? source.value : '';
}

function syncPaymentMethodBeforeSubmit(e) {
    syncPaymentMethodHidden();
}

function handleAssociateMethodChange() {
    const methodSelect = document.getElementById('payment_method_associate');
    const transactionSelect = document.getElementById('existing_transaction_id');
    const hintEl = document.getElementById('associateTransactionHint');
    if (!methodSelect || !transactionSelect) return;
    
    const method = methodSelect.value;
    const targetAccountType = method === 'cash' ? 'cash' : (method === 'transfer' ? 'bank' : null);
    
    if (!targetAccountType) {
        transactionSelect.disabled = true;
        transactionSelect.value = '';
        transactionSelect.querySelectorAll('option[data-account-type]').forEach(opt => { opt.hidden = false; });
        if (hintEl) hintEl.textContent = 'Selecione o método de pagamento para ver os movimentos disponíveis';
        return;
    }
    
    // Filter options by account type (options with data-account-type)
    const options = transactionSelect.querySelectorAll('option[data-account-type]');
    let visibleCount = 0;
    options.forEach(opt => {
        const accountType = opt.getAttribute('data-account-type') || 'bank';
        const match = (targetAccountType === 'cash' && accountType === 'cash') || (targetAccountType === 'bank' && accountType === 'bank');
        opt.hidden = !match;
        if (match) visibleCount++;
    });
    
    transactionSelect.disabled = false;
    transactionSelect.value = '';
    if (hintEl) {
        hintEl.textContent = visibleCount > 0 
            ? `Mostrando movimentos de ${targetAccountType === 'cash' ? 'caixa' : 'banco'} (${visibleCount} disponíveis)`
            : 'Nenhum movimento disponível para este método';
    }
    handleExistingTransactionChange();
}

function handleExistingTransactionChange() {
    const transactionSelect = document.getElementById('existing_transaction_id');
    const paymentDateInput = document.getElementById('payment_date');
    const paymentAmountInput = document.getElementById('payment_amount');
    if (!transactionSelect || !paymentDateInput) return;
    
    const selectedOption = transactionSelect.options[transactionSelect.selectedIndex];
    const transactionDate = selectedOption && selectedOption.value ? selectedOption.getAttribute('data-transaction-date') : null;
    const movementAmount = selectedOption && selectedOption.value ? parseFloat(selectedOption.getAttribute('data-amount') || '0') : null;
    
    if (transactionDate) {
        paymentDateInput.value = transactionDate;
    } else if (document.getElementById('transaction_associate').checked) {
        paymentDateInput.value = '';
    }
    
    // Ao associar a movimento existente: se o valor do movimento for menor que o pendente, usar o valor do movimento no pagamento
    if (paymentAmountInput && movementAmount != null && document.getElementById('transaction_associate').checked) {
        const maxPending = parseFloat(paymentAmountInput.getAttribute('max')) || 0;
        const amountToSet = maxPending > 0 ? Math.min(movementAmount, maxPending) : movementAmount;
        paymentAmountInput.value = amountToSet.toFixed(2);
    }
}

function handlePaymentMethodChange() {
    const paymentMethod = document.getElementById('payment_method');
    const bankAccountSelect = document.getElementById('bank_account_id');
    
    if (!paymentMethod || !bankAccountSelect) {
        return;
    }
    
    const selectedMethod = paymentMethod.value;
    
    if (selectedMethod === 'transfer') {
        // Select main bank account (first bank account that is not cash)
        const mainBankOption = bankAccountSelect.querySelector('option[data-is-main-bank="true"]');
        if (mainBankOption) {
            bankAccountSelect.value = mainBankOption.value;
        } else {
            // Fallback: select first bank account
            const bankOptions = Array.from(bankAccountSelect.options).filter(opt => {
                const option = bankAccountSelect.querySelector(`option[value="${opt.value}"]`);
                return option && !option.hasAttribute('data-is-cash');
            });
            if (bankOptions.length > 0) {
                bankAccountSelect.value = bankOptions[0].value;
            }
        }
    } else if (selectedMethod === 'cash') {
        // Select cash account
        const cashOption = bankAccountSelect.querySelector('option[data-is-cash="true"]');
        if (cashOption) {
            bankAccountSelect.value = cashOption.value;
        }
    }
}

function showPaymentModal(feeId) {
    currentFeeId = feeId;
    const modalElement = document.getElementById('paymentModal');
    if (!modalElement) {
        console.error('Modal element not found');
        return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    
    // Reset form
    const transactionCreate = document.getElementById('transaction_create');
    if (transactionCreate) {
        transactionCreate.checked = true;
    }
    toggleTransactionFields();
    
    // Open modal first to ensure elements are available
    modal.show();
    
    // Wait for modal to be shown, then update elements
    modalElement.addEventListener('shown.bs.modal', function onModalShown() {
        // Remove listener after first use
        modalElement.removeEventListener('shown.bs.modal', onModalShown);
        
        // Show loading state
        const feeInfoElement = document.getElementById('feeInfo');
        if (feeInfoElement) {
            feeInfoElement.style.display = 'block';
            feeInfoElement.innerHTML = '<small>Carregando informações...</small>';
        }
        
        // Load fee info
        fetch(`{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${feeId}/details`)
            .then(response => response.json())
            .then(data => {
                const totalAmount = data.total_amount;
                const paidAmount = data.total_paid;
                const pendingAmount = data.pending_amount;
                // Valor máximo = pendente total do período (regular + todas as extras). O backend distribui o pagamento pelas quotas.
                const maxPaymentAmount = parseFloat(pendingAmount);
                
                // Update fee info - keep it visible permanently
                if (feeInfoElement) {
                    feeInfoElement.innerHTML = `
                        <strong>Fração:</strong> ${data.fraction.identifier}<br>
                        <strong>Valor Total:</strong> €${parseFloat(totalAmount).toFixed(2).replace('.', ',')}<br>
                        <strong>Já Pago:</strong> €${parseFloat(paidAmount).toFixed(2).replace('.', ',')}<br>
                        <strong>Pendente:</strong> <span class="text-danger">€${parseFloat(pendingAmount).toFixed(2).replace('.', ',')}</span>
                    `;
                    feeInfoElement.style.display = 'block';
                }
                
                const paymentAmountInput = document.getElementById('payment_amount');
                if (paymentAmountInput) {
                    paymentAmountInput.setAttribute('max', maxPaymentAmount);
                    paymentAmountInput.max = maxPaymentAmount;
                    paymentAmountInput.value = parseFloat(maxPaymentAmount).toFixed(2);
                }
                
                const maxAmountHint = document.getElementById('maxAmountHint');
                if (maxAmountHint) {
                    maxAmountHint.textContent = `Valor máximo (período): €${parseFloat(maxPaymentAmount).toFixed(2).replace('.', ',')}`;
                }
                
                const paymentForm = document.getElementById('paymentForm');
                if (paymentForm) {
                    paymentForm.action = `{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${feeId}/add-payment`;
                }
                
                // Generate automatic reference: REF + condominium_id + fraction_id + fee_id
                const paymentReferenceInput = document.getElementById('payment_reference');
                if (paymentReferenceInput) {
                    const condominiumId = {{ condominium.id }};
                    const fractionId = data.fraction.id;
                    const reference = `REF${condominiumId}${fractionId}${feeId}`;
                    paymentReferenceInput.value = reference;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar informações:', error);
                if (feeInfoElement) {
                    feeInfoElement.innerHTML = '<div class="alert alert-danger">Erro ao carregar informações</div>';
                    feeInfoElement.style.display = 'block';
                }
            });
    }, { once: true });
}


// Update max amount when input changes
document.getElementById('payment_amount')?.addEventListener('input', function() {
    const maxAmount = parseFloat(this.max);
    const currentAmount = parseFloat(this.value);
    if (currentAmount > maxAmount) {
        this.value = maxAmount.toFixed(2);
        alert(`O valor máximo é €${maxAmount.toFixed(2).replace('.', ',')}`);
    }
});

// Bulk actions functions

// Delete Fee Modal and AJAX
let currentDeleteFeeId = null;
let currentDeleteFeeRow = null;

function showDeleteFeeModal(feeId, fractionIdentifier, periodDisplay, amount) {
    currentDeleteFeeId = feeId;
    
    // Find the row element using ID (more reliable)
    let row = document.getElementById(`fee-row-${feeId}`);
    if (row) {
        currentDeleteFeeRow = row;
    } else {
        // Try mobile card view
        const card = document.getElementById(`fee-card-${feeId}`);
        if (card) {
            currentDeleteFeeRow = card;
        } else {
            // Fallback: try data attribute
            row = document.querySelector(`tr[data-fee-id="${feeId}"]`);
            if (row) {
                currentDeleteFeeRow = row;
            } else {
                const cardFallback = document.querySelector(`div[data-fee-id="${feeId}"]`);
                if (cardFallback) {
                    currentDeleteFeeRow = cardFallback;
                }
            }
        }
    }
    
    // Set modal content
    document.getElementById('deleteFeeDetails').innerHTML = `
        <div><strong>Fração:</strong> ${fractionIdentifier}</div>
        <div><strong>Período:</strong> ${periodDisplay}</div>
        <div><strong>Valor:</strong> €${parseFloat(amount).toFixed(2).replace('.', ',')}</div>
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteFeeModal'));
    modal.show();
}

// Confirm delete button handler
let isDeleting = false; // Flag to prevent multiple simultaneous deletions

function handleDeleteFee() {
    // Prevent multiple simultaneous deletions
    if (isDeleting) {
        return;
    }
    
    if (!currentDeleteFeeId) {
        alert('Erro: ID da quota não encontrado.');
        return;
    }
    
    isDeleting = true;
    
    const btn = document.getElementById('confirmDeleteFeeBtn');
    if (!btn) {
        isDeleting = false;
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>A eliminar...';
    
    const formData = new FormData();
    formData.append('csrf_token', '{{ csrf_token }}');
    
    fetch(`{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${currentDeleteFeeId}/delete`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Erro: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            isDeleting = false;
            return;
        }
        
        // Success - remove row/card from DOM
        if (currentDeleteFeeRow) {
            const rowToRemove = currentDeleteFeeRow; // Store reference
            
            // Add fade out animation
            rowToRemove.style.transition = 'opacity 0.3s, height 0.3s, margin 0.3s, padding 0.3s';
            rowToRemove.style.opacity = '0';
            
            // If it's a table row, also animate height
            if (rowToRemove.tagName === 'TR') {
                const originalHeight = rowToRemove.offsetHeight;
                rowToRemove.style.height = originalHeight + 'px';
                setTimeout(() => {
                    rowToRemove.style.height = '0';
                    rowToRemove.style.margin = '0';
                    rowToRemove.style.padding = '0';
                }, 10);
            }
            
            setTimeout(() => {
                // Remove the element completely
                if (rowToRemove && rowToRemove.parentNode) {
                    rowToRemove.remove();
                }
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>${data.message || 'Quota extra eliminada com sucesso!'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    
                    // Insert at the top of the fees table/cards
                    const feesTable = document.querySelector('.table-responsive') || document.querySelector('.d-md-none');
                    if (feesTable) {
                        feesTable.parentNode.insertBefore(alertDiv, feesTable);
                    } else {
                        // Fallback: insert at top of page
                        const container = document.querySelector('.container-fluid') || document.querySelector('.container');
                        if (container) {
                            container.insertBefore(alertDiv, container.firstChild);
                        }
                    }
                    
                    // Auto-dismiss alert after 5 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.classList.remove('show');
                            setTimeout(() => alertDiv.remove(), 150);
                        }
                    }, 5000);
                }, 300);
            } else {
                // Still show success message even if element not found
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>${data.message || 'Quota extra eliminada com sucesso!'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                const container = document.querySelector('.container-fluid') || document.querySelector('.container');
                if (container) {
                    container.insertBefore(alertDiv, container.firstChild);
                }
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteFeeModal'));
            if (modal) {
                modal.hide();
            }
            
            currentDeleteFeeId = null;
            currentDeleteFeeRow = null;
            isDeleting = false; // Reset flag
        })
        .catch(error => {
            alert('Erro ao eliminar a quota: ' + (error.message || 'Por favor, tente novamente.'));
            btn.disabled = false;
            btn.innerHTML = originalText;
            isDeleting = false; // Reset flag on error
        });
}

// Wait for DOM to be ready and attach event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Use event delegation to avoid multiple listeners
    // Attach a single listener to the modal that handles clicks on the delete button
    const deleteModal = document.getElementById('deleteFeeModal');
    if (deleteModal) {
        // Use event delegation - attach listener to modal, not button
        deleteModal.addEventListener('click', function(e) {
            // Check if the clicked element is the delete button or inside it
            const deleteBtn = e.target.closest('#confirmDeleteFeeBtn');
            if (deleteBtn && !deleteBtn.disabled && !isDeleting) {
                e.preventDefault();
                e.stopPropagation();
                handleDeleteFee();
            }
        });
        
        // Reset modal when closed
        deleteModal.addEventListener('hidden.bs.modal', function() {
            currentDeleteFeeId = null;
            currentDeleteFeeRow = null;
            isDeleting = false;
            const btn = document.getElementById('confirmDeleteFeeBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-trash me-1"></i>Eliminar';
            }
        });
    }
});
</script>

<!-- Modal e Script para Detalhes da Quota (Mapa) -->
{% include 'blocks/fees-map-modal.html.twig' with {
    'is_admin': is_admin,
    'csrf_token': csrf_token,
    'fees_redirect_params': {
        'year': selected_year|default(null),
        'month': selected_month|default(null),
        'status': selected_status|default(null),
        'fraction_id': selected_fraction|default(null),
        'show_historical': show_historical|default(false),
        'fees_year': selected_fees_year|default(null)
    }
} %}

<!-- Modal para Eliminar Quota Extra -->
<div class="modal fade" id="deleteFeeModal" tabindex="-1" aria-labelledby="deleteFeeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteFeeModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Eliminar Quota Extra
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja eliminar esta quota extra?</p>
                <div class="alert alert-info mb-0">
                    <div class="fw-bold mb-2">Detalhes da quota:</div>
                    <div id="deleteFeeDetails"></div>
                </div>
                <div class="alert alert-warning mt-3 mb-0">
                    <small><i class="bi bi-exclamation-triangle"></i> Esta ação não pode ser desfeita. Apenas quotas extras sem pagamentos podem ser eliminadas.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteFeeBtn">
                    <i class="bi bi-trash me-1"></i>Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Pagamento -->
<div class="modal fade" id="editPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editPaymentForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" id="edit_payment_id" name="payment_id">
                <input type="hidden" id="edit_payment_fee_id" name="fee_id">
                {% if selected_year is defined %}<input type="hidden" name="redirect_year" value="{{ selected_year }}">{% endif %}
                {% if selected_month is defined %}<input type="hidden" name="redirect_month" value="{{ selected_month }}">{% endif %}
                {% if selected_status is defined %}<input type="hidden" name="redirect_status" value="{{ selected_status }}">{% endif %}
                {% if selected_fraction is defined %}<input type="hidden" name="redirect_fraction_id" value="{{ selected_fraction }}">{% endif %}
                {% if show_historical is defined and show_historical %}<input type="hidden" name="redirect_show_historical" value="1">{% endif %}
                {% if selected_fees_year is defined %}<input type="hidden" name="redirect_fees_year" value="{{ selected_fees_year }}">{% endif %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_payment_amount" class="form-label">Valor do Pagamento (€) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="number" class="form-control" id="edit_payment_amount" name="amount" 
                                   step="0.01" min="0.01" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_payment_method" class="form-label">Método de Pagamento <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_payment_method" name="payment_method" required>
                            <option value="">Selecione...</option>
                            <option value="transfer">Transferência</option>
                            <option value="cash">Dinheiro</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_payment_date" class="form-label">Data do Pagamento <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="edit_payment_date" name="payment_date" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_payment_reference" class="form-label">Referência</label>
                        <input type="text" class="form-control" id="edit_payment_reference" name="reference" readonly 
                               style="background-color: #e9ecef; cursor: not-allowed;">
                        <small class="form-text text-muted">Referência não pode ser alterada</small>
                    </div>

                    <div class="mb-3">
                        <label for="edit_payment_notes" class="form-label">Notas</label>
                        <textarea class="form-control" id="edit_payment_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Set form action when modal is shown
document.getElementById('editPaymentModal')?.addEventListener('show.bs.modal', function() {
    const feeId = document.getElementById('edit_payment_fee_id').value;
    const paymentId = document.getElementById('edit_payment_id').value;
    document.getElementById('editPaymentForm').action = `{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${feeId}/payments/${paymentId}/update`;
});

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.fraction-popover').forEach(function(el) { new bootstrap.Popover(el, { trigger: 'focus' }); });
});
</script>


