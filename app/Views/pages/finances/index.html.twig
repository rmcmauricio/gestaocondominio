<div class="container py-4">
    {% include 'blocks/page-header.html.twig' with {
        'title': 'Finanças',
        'help_section': 'finances',
        'help_title': 'Ajuda com Finanças'
    } %}

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Seletor de ano -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <span class="text-muted small fw-bold me-2">Ano:</span>
        {% for y in available_years|default([current_year]) %}
        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/finances?year={{ y }}" class="btn btn-sm py-1 px-2 {{ y == selected_year ? 'btn-warning' : 'btn-outline-secondary' }}" style="font-size: 0.75rem;">
            <i class="bi bi-calendar3"></i> {{ y }}
        </a>
        {% endfor %}
    </div>

    <div class="row g-3 mb-4 row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-6">
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Orçamento {{ selected_year }}</h6>
                    <h3 class="mb-0">€{{ budget.total_amount|default(0)|number_format(2, ',', '.') }}</h3>
                    {% if not budget %}
                        <small class="text-muted">Nenhum orçamento definido</small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Receitas {{ selected_year }}</h6>
                    <h3 class="mb-0 text-success">€{{ total_revenues|default(0)|number_format(2, ',', '.') }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Despesas {{ selected_year }}</h6>
                    <h3 class="mb-0 text-danger">€{{ total_expenses|default(0)|number_format(2, ',', '.') }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Saldo Orçamental</h6>
                    <h3 class="mb-0 {% if (total_revenues|default(0) - total_expenses|default(0)) < 0 %}text-danger{% else %}text-success{% endif %}">
                        €{{ (total_revenues|default(0) - total_expenses|default(0))|number_format(2, ',', '.') }}
                    </h3>
                    {% if budget and budget.total_amount|default(0) != 0 %}
                    {% set saldo = total_revenues|default(0) - total_expenses|default(0) %}
                    {% set desvio = saldo - budget.total_amount %}
                    {% set pct = (desvio / budget.total_amount) * 100 %}
                    <small class="text-muted" style="font-size: 0.75rem;">
                        Desvio: €{{ desvio|number_format(2, ',', '.') }} ({{ pct|number_format(1, ',', '.') }}%)
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card shadow-sm border-primary h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Saldo Total Contas{% if is_viewing_past_year %} (31/12/{{ selected_year }}){% endif %}</h6>
                    <h3 class="mb-0 {% if total_balance < 0 %}text-danger{% else %}text-success{% endif %}">
                        €{{ total_balance|number_format(2, ',', '.') }}
                    </h3>
                    <small class="text-muted">
                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/bank-accounts" class="text-decoration-none">
                            Ver contas <i class="bi bi-arrow-right"></i>
                        </a>
                    </small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Dívidas</h6>
                    <h3 class="mb-0 {% if total_debts|default(0) > 0 %}text-warning{% else %}text-success{% endif %}">
                        €{{ total_debts|default(0)|number_format(2, ',', '.') }}
                    </h3>
                    <small class="text-muted">
                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/fraction-accounts" class="text-decoration-none">
                            Ver contas por fração <i class="bi bi-arrow-right"></i>
                        </a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    {% if bank_accounts %}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-bank"></i> Saldos das Contas{% if is_viewing_past_year %} (31/12/{{ selected_year }}){% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                {% for account in bank_accounts %}
                <div class="col-12 col-sm-6 col-lg-4">
                    <div class="card account-card {% if account.account_type == 'cash' %}border-info border-2{% else %}border-primary border-2{% endif %} h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <div class="mb-3">
                                <h6 class="mb-2 fw-bold text-break">
                                    {{ account.name }}
                                </h6>
                                <div class="mb-2">
                                    {% if account.account_type == 'cash' %}
                                    <span class="badge bg-info">Caixa</span>
                                    {% else %}
                                    <span class="badge bg-primary">Bancária</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if account.account_type == 'bank' %}
                            <div class="mb-3">
                                {% if account.bank_name %}
                                <div class="mb-2">
                                    <small class="text-muted d-block"><strong>Banco:</strong> {{ account.bank_name }}</small>
                                </div>
                                {% endif %}
                                {% if account.iban %}
                                <div class="mb-2">
                                    <small class="text-muted d-block"><strong>IBAN:</strong></small>
                                    <code class="text-muted text-break d-block" style="font-size: 0.7rem; word-break: break-all;">{{ account.iban }}</code>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="mt-auto pt-3 border-top">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted flex-shrink-0">Saldo{% if is_viewing_past_year %} (31/12/{{ selected_year }}){% endif %}:</small>
                                    <h4 class="mb-0 fw-bold {% if (account.balance_for_year|default(account.current_balance)) >= 0 %}text-success{% else %}text-danger{% endif %} text-end flex-shrink-0" style="white-space: nowrap;">
                                        €{{ (account.balance_for_year|default(account.current_balance))|number_format(2, ',', '.') }}
                                    </h4>
                                </div>
                                <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions?bank_account_id={{ account.id }}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-list-ul"></i> Ver Movimentos
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-3">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <h5 class="mb-2 mb-md-0">Últimas Despesas</h5>
                    {% if is_admin %}
                    <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/create?transaction_type=expense" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Adicionar
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if expenses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Categoria</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                <tr>
                                    <td>{{ expense.transaction_date|date('d/m/Y') }}</td>
                                    <td>{{ expense.description|default('-') }}</td>
                                    <td>{% if expense.category %}<span class="badge bg-secondary">{{ expense.category }}</span>{% else %}-{% endif %}</td>
                                    <td><strong>€{{ expense.amount|number_format(2, ',', '.') }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">Nenhuma saída registada em {{ selected_year }}.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Condomínio
        </a>
    </div>
</div>

