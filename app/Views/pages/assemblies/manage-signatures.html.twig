<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gerir Assinaturas de Atas</h2>
        <a href="{{ BASE_URL }}condominiums/{{ assembly.condominium_id }}/assemblies/{{ assembly.id }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-file-text"></i> Assinaturas: {{ assembly.title }}
            </h5>
        </div>
        <div class="card-body">
            {% if stats %}
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h3 class="mb-0">{{ stats.total }}</h3>
                            <small class="text-muted">Total de Frações Presentes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-0">{{ stats.signed }}</h3>
                            <small>Assinaturas Registadas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning">
                        <div class="card-body text-center">
                            <h3 class="mb-0">{{ stats.pending }}</h3>
                            <small class="text-muted">Pendentes</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Instruções:</strong> Marque as frações que já assinaram fisicamente a ata em papel. 
                Apenas após todas as frações presentes terem assinado será possível aprovar e gerar o PDF final.
            </div>

            <form method="POST" action="{{ BASE_URL }}condominiums/{{ assembly.condominium_id }}/assemblies/{{ assembly.id }}/minutes-template/signatures/mark">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Assinado</th>
                                <th>Fração</th>
                                <th>Condómino</th>
                                <th>Permilagem</th>
                                <th>Data de Assinatura</th>
                                <th style="width: 120px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in fractions %}
                            {% set fraction = item.fraction %}
                            {% set user = item.user %}
                            {% set signature = item.signature %}
                            {% set userId = user ? user.id : 'null' %}
                            <tr class="{% if item.signed %}table-success{% endif %}">
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input signature-checkbox" 
                                               type="checkbox" 
                                               id="sign_{{ fraction.id }}"
                                               {% if item.signed %}checked disabled{% endif %}
                                               onchange="toggleSignature({{ fraction.id }}, {{ userId }})">
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ fraction.identifier }}</strong>
                                </td>
                                <td>
                                    {% if user %}
                                        {{ user.name }}
                                        <br><small class="text-muted">{{ user.email }}</small>
                                    {% else %}
                                        <span class="text-muted">Sem utilizador associado</span>
                                    {% endif %}
                                </td>
                                <td>{{ fraction.permillage }}‰</td>
                                <td>
                                    {% if signature %}
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i>
                                            {{ signature.signed_at|date('d/m/Y H:i') }}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.signed %}
                                        <form method="POST" action="{{ BASE_URL }}condominiums/{{ assembly.condominium_id }}/assemblies/{{ assembly.id }}/minutes-template/signatures/mark" class="d-inline" onsubmit="return confirm('Tem certeza que deseja remover esta assinatura?');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <input type="hidden" name="fraction_id" value="{{ fraction.id }}">
                                            <input type="hidden" name="action" value="unsign">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-x-circle"></i> Remover
                                            </button>
                                        </form>
                                    {% else %}
                                        <form method="POST" action="{{ BASE_URL }}condominiums/{{ assembly.condominium_id }}/assemblies/{{ assembly.id }}/minutes-template/signatures/mark" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <input type="hidden" name="fraction_id" value="{{ fraction.id }}">
                                            <input type="hidden" name="user_id" value="{% if user %}{{ user.id }}{% endif %}">
                                            <input type="hidden" name="action" value="sign">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="bi bi-check-circle"></i> Marcar
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

            {% if stats and stats.pending == 0 %}
            <div class="alert alert-success mt-4">
                <i class="bi bi-check-circle"></i>
                <strong>Todas as frações presentes já assinaram!</strong> 
                Pode agora aprovar a ata e gerar o PDF final.
                <a href="{{ BASE_URL }}condominiums/{{ assembly.condominium_id }}/assemblies/{{ assembly.id }}/minutes-template/edit" class="btn btn-success ms-2">
                    <i class="bi bi-check-circle"></i> Aprovar e Gerar PDF
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleSignature(fractionId, userId) {
    const checkbox = document.getElementById('sign_' + fractionId);
    const form = checkbox.closest('form');
    
    if (checkbox.checked) {
        // Create form to mark signature
        const formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token }}');
        formData.append('fraction_id', fractionId);
        formData.append('action', 'sign');
        if (userId) {
            formData.append('user_id', userId);
        }
        
        fetch('{{ BASE_URL }}condominiums/{{ assembly.condominium_id }}/assemblies/{{ assembly.id }}/minutes-template/signatures/mark', {
            method: 'POST',
            body: formData
        }).then(() => {
            location.reload();
        });
    }
}
</script>
