<style>
th.sortable {
    user-select: none;
    position: relative;
}

th.sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

th.sortable .sort-icon {
    margin-left: 5px;
    font-size: 0.8em;
    opacity: 0.5;
}

th.sortable:hover .sort-icon {
    opacity: 1;
}

th.sortable[style*="color: rgb(13, 110, 253)"] .sort-icon {
    opacity: 1;
}

tr.user-row {
    cursor: pointer;
}

tr.user-row:hover {
    background-color: rgba(0, 123, 255, 0.05) !important;
}

/* Scroll horizontal para dispositivos pequenos */
@media (max-width: 768px) {
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .table-responsive table {
        min-width: 600px;
    }
}
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Gestão de Utilizadores</h2>
            <p class="text-muted mb-0">Visualizar e gerir todos os utilizadores do sistema</p>
        </div>
        <a href="{{ BASE_URL }}dashboard" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Search and Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Pesquisar</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Nome ou Email...">
                </div>
                <div class="col-md-2">
                    <label for="filterRole" class="form-label">Role</label>
                    <select class="form-select" id="filterRole">
                        <option value="">Todos</option>
                        {% for role in roles %}
                        <option value="{{ role }}">{{ role|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filterStatus" class="form-label">Status</label>
                    <select class="form-select" id="filterStatus">
                        <option value="">Todos</option>
                        {% for status in statuses %}
                        <option value="{{ status }}">{{ status|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filterPlan" class="form-label">Plano</label>
                    <select class="form-select" id="filterPlan">
                        <option value="">Todos</option>
                        <option value="none">Sem plano</option>
                        {% for plan in plans %}
                        <option value="{{ plan.name }}">{{ plan.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filterAdvanced" class="form-label">Filtros Avançados</label>
                    <select class="form-select" id="filterAdvanced">
                        <option value="">Nenhum</option>
                        <option value="trial_only">Só Trial</option>
                        <option value="no_active_plan">Sem Plano Ativo</option>
                        <option value="no_condominium">Sem Condomínio</option>
                        <option value="email_not_verified">Email Não Verificado</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary w-100" id="clearFilters">
                        <i class="bi bi-x-circle"></i> Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-people"></i> Utilizadores</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="usersTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="id" style="cursor: pointer;">
                                ID <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="name" style="cursor: pointer;">
                                Nome <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="email" style="cursor: pointer;">
                                Email <i class="bi bi-arrow-down-up sort-icon"></i>
                            </th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Plano</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="user-row" 
                            data-user-id="{{ user.id }}"
                            data-role="{{ user.role }}" 
                            data-status="{{ user.status }}" 
                            data-plan="{{ user.plan_name|default('none') }}" 
                            data-name="{{ user.name|lower }}" 
                            data-email="{{ user.email|lower }}" 
                            data-has-only-trial="{{ user.has_only_trial ? 'true' : 'false' }}"
                            data-has-no-active-plan="{{ user.has_no_active_plan ? 'true' : 'false' }}"
                            data-has-no-condominium="{{ user.has_no_condominium ? 'true' : 'false' }}"
                            data-email-not-verified="{{ user.email_not_verified ? 'true' : 'false' }}"
                            data-plan-name="{{ user.plan_name|default('') }}"
                            data-subscription-status="{{ user.subscription_status|default('') }}"
                            data-total-condominiums="{{ user.total_condominiums|default(0) }}"
                            data-created-at="{{ user.created_at }}"
                            data-is-current-user="{{ user.id == current_user_id ? 'true' : 'false' }}"
                            data-condominiums="{{ user.condominiums|default([])|json_encode|escape('html_attr') }}">
                            <td data-sort-value="{{ user.id }}">{{ user.id }}</td>
                            <td data-sort-value="{{ user.name|lower }}">
                                <strong>{{ user.name }}</strong>
                            </td>
                            <td data-sort-value="{{ user.email|lower }}">
                                {{ user.email }}
                                {% if user.email_not_verified %}
                                    <i class="bi bi-exclamation-triangle-fill text-danger ms-1" title="Email não verificado"></i>
                                {% else %}
                                    <i class="bi bi-check-circle-fill text-success ms-1" title="Email verificado"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.role == 'super_admin' %}
                                    <span class="badge bg-danger"><i class="bi bi-shield-check"></i> Super Admin</span>
                                {% else %}
                                    <span class="badge bg-info">{{ user.role }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.status == 'active' %}
                                    <span class="badge bg-success">Ativo</span>
                                {% elseif user.status == 'suspended' %}
                                    <span class="badge bg-warning">Suspenso</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.plan_name %}
                                    <span class="badge bg-primary">{{ user.plan_name }}</span>
                                {% else %}
                                    <span class="text-muted">Sem plano</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                Nenhum utilizador encontrado.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="d-flex align-items-center">
                    <label for="itemsPerPage" class="me-2 mb-0">Itens por página:</label>
                    <select id="itemsPerPage" class="form-select form-select-sm" style="width: auto;">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="0">Todos</option>
                    </select>
                </div>
                <div class="d-flex align-items-center">
                    <span id="paginationInfo" class="text-muted me-3"></span>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="paginationControls">
                            <!-- Pagination buttons will be inserted here by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Principal de Detalhes do Utilizador -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="userDetailsModalLabel">
                    <i class="bi bi-person-circle"></i> Detalhes do Utilizador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modais de Ações -->
<!-- Modal para Atribuir Super Admin -->
<div class="modal fade" id="assignSuperAdminModal" tabindex="-1" aria-labelledby="assignSuperAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="assignSuperAdminModalLabel">
                    <i class="bi bi-shield-check"></i> Atribuir Cargo de Super Admin
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ BASE_URL }}admin/users/assign-super-admin">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="user_id" id="assign_user_id">
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Atenção!</strong>
                        <p class="mb-0 mt-2">Tem a certeza que deseja atribuir o cargo de Super Admin ao utilizador:</p>
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <p class="mb-1"><strong>Nome:</strong> <span id="assign_user_name"></span></p>
                            <p class="mb-0"><strong>Email:</strong> <span id="assign_user_email"></span></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> O utilizador terá acesso completo a todas as funcionalidades administrativas do sistema.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-shield-check"></i> Confirmar Atribuição
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Remover Super Admin -->
<div class="modal fade" id="removeSuperAdminModal" tabindex="-1" aria-labelledby="removeSuperAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="removeSuperAdminModalLabel">
                    <i class="bi bi-person-x"></i> Remover Cargo de Super Admin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ BASE_URL }}admin/users/remove-super-admin">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="user_id" id="remove_user_id">
                    
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Atenção!</strong>
                        <p class="mb-0 mt-2">Tem a certeza que deseja remover o cargo de Super Admin do utilizador:</p>
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <p class="mb-1"><strong>Nome:</strong> <span id="remove_user_name"></span></p>
                            <p class="mb-0"><strong>Email:</strong> <span id="remove_user_email"></span></p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_role" class="form-label">Atribuir novo role:</label>
                        <select class="form-select" id="new_role" name="new_role" required>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                            <option value="condomino">Condomino</option>
                        </select>
                        <small class="form-text text-muted">Escolha o novo role que o utilizador terá após remover o cargo de Super Admin.</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-shield-check"></i> <strong>Nota de Segurança:</strong>
                        <p class="mb-0 mt-2">Não é possível remover o seu próprio cargo de Super Admin. Esta proteção garante que sempre exista pelo menos um Super Admin no sistema.</p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> O utilizador perderá acesso a todas as funcionalidades administrativas do sistema.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-person-x"></i> Confirmar Remoção
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Apagar Admin Trial -->
<div class="modal fade" id="deleteTrialAdminModal" tabindex="-1" aria-labelledby="deleteTrialAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTrialAdminModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Apagar Admin Trial
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ BASE_URL }}admin/users/delete-trial-admin">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="user_id" id="delete_trial_user_id">
                    
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Atenção!</strong>
                        <p class="mb-0 mt-2">Esta ação irá <strong>remover permanentemente</strong>:</p>
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <p class="mb-1"><strong>Utilizador:</strong> <span id="delete_trial_user_name"></span></p>
                            <p class="mb-1"><strong>Email:</strong> <span id="delete_trial_user_email"></span></p>
                            <p class="mb-0"><strong>Condomínios a remover:</strong> <span id="delete_trial_condominium_count" class="badge bg-danger">0</span></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> <strong>Será removido:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Todos os condomínios criados pelo utilizador</li>
                            <li>Todos os dados relacionados (frações, quotas, documentos, etc.)</li>
                            <li>Todas as subscrições do utilizador</li>
                            <li>O próprio utilizador</li>
                        </ul>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirm_delete_trial" required>
                        <label class="form-check-label" for="confirm_delete_trial">
                            Confirmo que desejo apagar permanentemente este utilizador e todos os seus dados
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" id="submit_delete_trial" disabled>
                        <i class="bi bi-trash"></i> Confirmar Remoção
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Apagar User Sem Plano Ativo -->
<div class="modal fade" id="deleteUserNoActivePlanModal" tabindex="-1" aria-labelledby="deleteUserNoActivePlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserNoActivePlanModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Apagar Utilizador Sem Plano Ativo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ BASE_URL }}admin/users/delete-user-no-active-plan">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="user_id" id="delete_no_plan_user_id">
                    
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Atenção Crítica!</strong>
                        <p class="mb-0 mt-2">Esta ação irá <strong>remover permanentemente</strong>:</p>
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <p class="mb-1"><strong>Utilizador:</strong> <span id="delete_no_plan_user_name"></span></p>
                            <p class="mb-1"><strong>Email:</strong> <span id="delete_no_plan_user_email"></span></p>
                            <p class="mb-0"><strong>Condomínios a remover:</strong> <span id="delete_no_plan_condominium_count" class="badge bg-danger">0</span></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> <strong>Será removido:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Todos os condomínios criados pelo utilizador</li>
                            <li>Todos os dados relacionados (frações, quotas, documentos, etc.)</li>
                            <li>Todas as subscrições do utilizador</li>
                            <li>O próprio utilizador</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-shield-check"></i> <strong>Verificação de Segurança:</strong>
                        <p class="mb-0 mt-2">Este utilizador não possui planos ativos no momento. Esta ação é irreversível.</p>
                    </div>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="confirm_delete_no_plan_1" required>
                        <label class="form-check-label" for="confirm_delete_no_plan_1">
                            Confirmo que verifiquei que este utilizador não possui planos ativos
                        </label>
                    </div>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="confirm_delete_no_plan_2" required>
                        <label class="form-check-label" for="confirm_delete_no_plan_2">
                            Entendo que todos os condomínios e dados relacionados serão removidos permanentemente
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirm_delete_no_plan_3" required>
                        <label class="form-check-label" for="confirm_delete_no_plan_3">
                            Confirmo que desejo prosseguir com a remoção completa deste utilizador
                        </label>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="delete_no_plan_reason" class="form-label">Motivo da remoção (obrigatório):</label>
                        <textarea class="form-control" id="delete_no_plan_reason" name="reason" rows="3" required placeholder="Descreva o motivo da remoção deste utilizador..."></textarea>
                        <small class="form-text text-muted">Este motivo será registado no log de auditoria.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" id="submit_delete_no_plan" disabled>
                        <i class="bi bi-trash"></i> Confirmar Remoção Completa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Apagar User Sem Condomínio -->
<div class="modal fade" id="deleteUserNoCondominiumModal" tabindex="-1" aria-labelledby="deleteUserNoCondominiumModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserNoCondominiumModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Apagar Utilizador Sem Condomínio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ BASE_URL }}admin/users/delete-user-no-condominium">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="user_id" id="delete_no_condo_user_id">
                    
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Atenção!</strong>
                        <p class="mb-0 mt-2">Esta ação irá <strong>remover permanentemente</strong> o utilizador:</p>
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <p class="mb-1"><strong>Nome:</strong> <span id="delete_no_condo_user_name"></span></p>
                            <p class="mb-0"><strong>Email:</strong> <span id="delete_no_condo_user_email"></span></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> <strong>Será removido:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Todas as subscrições do utilizador</li>
                            <li>Todas as notificações</li>
                            <li>Preferências de email</li>
                            <li>Outros dados relacionados</li>
                            <li>O próprio utilizador</li>
                        </ul>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirm_delete_no_condo" required>
                        <label class="form-check-label" for="confirm_delete_no_condo">
                            Confirmo que desejo apagar permanentemente este utilizador
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" id="submit_delete_no_condo" disabled>
                        <i class="bi bi-trash"></i> Confirmar Remoção
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Estatísticas do Condomínio -->
<div class="modal fade" id="condominiumStatsModal" tabindex="-1" aria-labelledby="condominiumStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="condominiumStatsModalLabel">
                    <i class="bi bi-graph-up"></i> Estatísticas do Condomínio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="statsIframe" src="" style="width: 100%; height: 80vh; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <a id="openInNewTab" href="#" target="_blank" class="btn btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Abrir em Nova Aba
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('usersTable');
    if (!table) return;
    
    const sortableHeaders = table.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };
    let currentPage = 1;
    let itemsPerPage = 25;
    let allRows = [];
    let filteredRows = [];
    
    // Initialize: store all rows
    const tbody = table.querySelector('tbody');
    const allTableRows = Array.from(tbody.querySelectorAll('tr.user-row'));
    
    // Filter out empty row
    allRows = allTableRows.filter(row => !row.querySelector('td[colspan]'));
    
    if (allRows.length === 0) {
        const paginationContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mt-3');
        if (paginationContainer) paginationContainer.style.display = 'none';
        return;
    }
    
    filteredRows = [...allRows];
    
    // Get column index from header
    function getColumnIndex(sortType) {
        const headers = Array.from(table.querySelectorAll('thead th'));
        return headers.findIndex(h => h.dataset.sort === sortType);
    }
    
    // Filter function
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const roleFilter = document.getElementById('filterRole').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const planFilter = document.getElementById('filterPlan').value;
        const advancedFilter = document.getElementById('filterAdvanced').value;
        
        filteredRows = allRows.filter(row => {
            // Search filter
            if (searchTerm) {
                const name = row.dataset.name || '';
                const email = row.dataset.email || '';
                if (!name.includes(searchTerm) && !email.includes(searchTerm)) {
                    return false;
                }
            }
            
            // Role filter
            if (roleFilter && row.dataset.role !== roleFilter) {
                return false;
            }
            
            // Status filter
            if (statusFilter && row.dataset.status !== statusFilter) {
                return false;
            }
            
            // Plan filter
            if (planFilter) {
                const plan = row.dataset.plan || 'none';
                if (planFilter === 'none' && plan !== 'none') {
                    return false;
                } else if (planFilter !== 'none' && plan !== planFilter) {
                    return false;
                }
            }
            
            // Advanced filters
            if (advancedFilter) {
                if (advancedFilter === 'trial_only' && row.dataset.hasOnlyTrial !== 'true') {
                    return false;
                }
                if (advancedFilter === 'no_active_plan' && row.dataset.hasNoActivePlan !== 'true') {
                    return false;
                }
                if (advancedFilter === 'no_condominium' && row.dataset.hasNoCondominium !== 'true') {
                    return false;
                }
                if (advancedFilter === 'email_not_verified' && row.dataset.emailNotVerified !== 'true') {
                    return false;
                }
            }
            
            return true;
        });
        
        currentPage = 1;
        displayRows();
        updatePagination();
    }
    
    // Pagination functions
    function updatePagination() {
        const totalItems = filteredRows.length;
        const paginationContainer = document.querySelector('.d-flex.justify-content-between.align-items-center.mt-3');
        
        if (totalItems === 0) {
            if (paginationContainer) paginationContainer.style.display = 'none';
            return;
        }
        
        if (paginationContainer) paginationContainer.style.display = 'flex';
        
        const totalPages = itemsPerPage === 0 ? 1 : Math.ceil(totalItems / itemsPerPage);
        
        const infoEl = document.getElementById('paginationInfo');
        if (itemsPerPage === 0) {
            infoEl.textContent = `Mostrando todos os ${totalItems} utilizadores`;
        } else {
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, totalItems);
            infoEl.textContent = `Mostrando ${start}-${end} de ${totalItems} utilizadores`;
        }
        
        const controlsEl = document.getElementById('paginationControls');
        controlsEl.innerHTML = '';
        
        if (itemsPerPage === 0 || totalPages <= 1) {
            return;
        }
        
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>`;
        controlsEl.appendChild(prevLi);
        
        const maxVisible = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);
        
        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
            controlsEl.appendChild(firstLi);
            
            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                controlsEl.appendChild(ellipsisLi);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            controlsEl.appendChild(li);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                controlsEl.appendChild(ellipsisLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
            controlsEl.appendChild(lastLi);
        }
        
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Próximo</a>`;
        controlsEl.appendChild(nextLi);
        
        controlsEl.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    currentPage = page;
                    displayRows();
                    updatePagination();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        });
    }
    
    function displayRows() {
        tbody.innerHTML = '';
        
        if (filteredRows.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="6" class="text-center text-muted">Nenhum utilizador encontrado.</td>';
            tbody.appendChild(emptyRow);
            return;
        }
        
        const rowsToDisplay = itemsPerPage === 0 
            ? filteredRows 
            : filteredRows.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
        
        rowsToDisplay.forEach(row => {
            const clonedRow = row.cloneNode(true);
            tbody.appendChild(clonedRow);
        });
        
        // Setup click handlers for modal
        setupModalHandlers();
    }
    
    // Search and filter event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('filterRole').addEventListener('change', applyFilters);
    document.getElementById('filterStatus').addEventListener('change', applyFilters);
    document.getElementById('filterPlan').addEventListener('change', applyFilters);
    document.getElementById('filterAdvanced').addEventListener('change', applyFilters);
    
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterRole').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterPlan').value = '';
        document.getElementById('filterAdvanced').value = '';
        applyFilters();
    });
    
    document.getElementById('itemsPerPage').addEventListener('change', function() {
        itemsPerPage = parseInt(this.value);
        currentPage = 1;
        displayRows();
        updatePagination();
    });
    
    // Sorting functionality
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortType = this.dataset.sort;
            
            if (filteredRows.length === 0) return;
            
            if (currentSort.column === sortType) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortType;
                currentSort.direction = 'asc';
            }
            
            const columnIndex = getColumnIndex(sortType);
            
            filteredRows.sort((a, b) => {
                const aCells = a.querySelectorAll('td');
                const bCells = b.querySelectorAll('td');
                
                if (!aCells[columnIndex] || !bCells[columnIndex]) return 0;
                
                let aValue, bValue;
                const aCell = aCells[columnIndex];
                const bCell = bCells[columnIndex];
                
                if (sortType === 'id') {
                    aValue = parseFloat(aCell.dataset.sortValue || aCell.textContent.trim()) || 0;
                    bValue = parseFloat(bCell.dataset.sortValue || bCell.textContent.trim()) || 0;
                } else if (sortType === 'name' || sortType === 'email') {
                    aValue = (aCell.dataset.sortValue || aCell.textContent.trim()).toLowerCase();
                    bValue = (bCell.dataset.sortValue || bCell.textContent.trim()).toLowerCase();
                }
                
                if (typeof aValue === 'string') {
                    return currentSort.direction === 'asc' 
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                } else {
                    return currentSort.direction === 'asc' 
                        ? aValue - bValue
                        : bValue - aValue;
                }
            });
            
            currentPage = 1;
            displayRows();
            updatePagination();
            
            sortableHeaders.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (h.dataset.sort === sortType) {
                    icon.className = currentSort.direction === 'asc' 
                        ? 'bi bi-arrow-up sort-icon' 
                        : 'bi bi-arrow-down sort-icon';
                    h.style.color = '#0d6efd';
                } else {
                    icon.className = 'bi bi-arrow-down-up sort-icon';
                    h.style.color = '';
                }
            });
        });
        
        header.style.transition = 'color 0.2s';
        header.addEventListener('mouseenter', function() {
            if (this.dataset.sort !== currentSort.column) {
                this.style.color = '#0d6efd';
            }
        });
        header.addEventListener('mouseleave', function() {
            if (this.dataset.sort !== currentSort.column) {
                this.style.color = '';
            }
        });
    });
    
    // Modal functionality
    const userDetailsModal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    
    function setupModalHandlers() {
        document.querySelectorAll('tr.user-row').forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't open modal if clicking on a badge or icon
                if (e.target.closest('.badge') || e.target.closest('i')) {
                    return;
                }
                
                openUserDetailsModal(this);
            });
        });
    }
    
    function openUserDetailsModal(row) {
        const content = document.getElementById('userDetailsContent');
        const modalTitle = document.getElementById('userDetailsModalLabel');
        
        // Get data from row attributes
        const userId = row.dataset.userId;
        const userName = row.querySelector('td:nth-child(2) strong').textContent.trim();
        const userEmail = row.dataset.email;
        const userRole = row.dataset.role;
        const userStatus = row.dataset.status;
        const planName = row.dataset.planName || '';
        const subscriptionStatus = row.dataset.subscriptionStatus || '';
        const totalCondominiums = parseInt(row.dataset.totalCondominiums) || 0;
        const createdAt = row.dataset.createdAt;
        const hasOnlyTrial = row.dataset.hasOnlyTrial === 'true';
        const hasNoActivePlan = row.dataset.hasNoActivePlan === 'true';
        const hasNoCondominium = row.dataset.hasNoCondominium === 'true';
        const emailNotVerified = row.dataset.emailNotVerified === 'true';
        const isCurrentUser = row.dataset.isCurrentUser === 'true';
        
        // Parse condominiums
        let condominiums = [];
        try {
            condominiums = JSON.parse(row.dataset.condominiums || '[]');
        } catch (e) {
            condominiums = [];
        }
        
        modalTitle.innerHTML = `<i class="bi bi-person-circle"></i> ${userName || 'Detalhes do Utilizador'}`;
        
        // Format created_at date
        const createdDate = createdAt ? new Date(createdAt).toLocaleString('pt-PT') : 'N/A';
        
        // Build badges HTML
        let badgesHtml = '';
        if (hasOnlyTrial) {
            badgesHtml += '<span class="badge bg-warning ms-1"><i class="bi bi-clock-history"></i> Trial</span>';
        }
        if (hasNoActivePlan) {
            badgesHtml += '<span class="badge bg-danger ms-1"><i class="bi bi-x-circle"></i> Sem Plano Ativo</span>';
        }
        if (hasNoCondominium) {
            badgesHtml += '<span class="badge bg-secondary ms-1"><i class="bi bi-building-x"></i> Sem Condomínio</span>';
        }
        if (emailNotVerified) {
            badgesHtml += '<span class="badge bg-danger ms-1"><i class="bi bi-envelope-x"></i> Não Verificado</span>';
        }
        
        // Build condominiums HTML
        let condominiumsHtml = '';
        if (condominiums && condominiums.length > 0) {
            condominiumsHtml = '<div class="mt-3"><h6><i class="bi bi-building"></i> Condomínios Administrados (' + condominiums.length + ')</h6><div class="d-flex flex-wrap gap-2">';
            condominiums.forEach(condo => {
                condominiumsHtml += `<button type="button" class="badge bg-info text-decoration-none p-2 border-0 btn-stats" data-condo-id="${condo.id}" data-condo-name="${condo.name}" title="Ver estatísticas de ${condo.name}"><i class="bi bi-building"></i> ${condo.name}${!condo.is_active ? ' <span class="badge bg-secondary ms-1">Inativo</span>' : ''}</button>`;
            });
            condominiumsHtml += '</div></div>';
        }
        
        // Build actions HTML
        let actionsHtml = '<div class="mt-4"><h6>Ações</h6><div class="d-flex flex-wrap gap-2">';
        
        if (userRole === 'super_admin') {
            if (!isCurrentUser) {
                actionsHtml += `<button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#removeSuperAdminModal" data-user-id="${userId}" data-user-name="${userName}" data-user-email="${userEmail}"><i class="bi bi-person-x"></i> Remover Super Admin</button>`;
            } else {
                actionsHtml += '<span class="badge bg-info"><i class="bi bi-shield-check"></i> Utilizador atual (Super Admin)</span>';
            }
        } else {
            actionsHtml += `<button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#assignSuperAdminModal" data-user-id="${userId}" data-user-name="${userName}" data-user-email="${userEmail}"><i class="bi bi-shield-check"></i> Tornar Super Admin</button>`;
        }
        
        if (userRole === 'admin' && hasOnlyTrial && !isCurrentUser) {
            actionsHtml += `<button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteTrialAdminModal" data-user-id="${userId}" data-user-name="${userName}" data-user-email="${userEmail}" data-condominium-count="${condominiums.length}"><i class="bi bi-trash"></i> Apagar Trial</button>`;
        }
        
        if (userRole === 'admin' && hasNoActivePlan && !isCurrentUser) {
            actionsHtml += `<button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteUserNoActivePlanModal" data-user-id="${userId}" data-user-name="${userName}" data-user-email="${userEmail}" data-condominium-count="${condominiums.length}"><i class="bi bi-trash"></i> Apagar Sem Plano</button>`;
        }
        
        if (hasNoCondominium && userRole !== 'super_admin' && !isCurrentUser) {
            actionsHtml += `<button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteUserNoCondominiumModal" data-user-id="${userId}" data-user-name="${userName}" data-user-email="${userEmail}"><i class="bi bi-trash"></i> Apagar</button>`;
        }
        
        actionsHtml += '</div></div>';
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações Básicas</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">ID:</th>
                            <td>${userId}</td>
                        </tr>
                        <tr>
                            <th>Nome:</th>
                            <td><strong>${userName || 'N/A'}</strong>${badgesHtml}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>
                                ${userEmail || 'N/A'}
                                ${emailNotVerified 
                                    ? '<i class="bi bi-exclamation-triangle-fill text-danger ms-1" title="Email não verificado"></i>' 
                                    : '<i class="bi bi-check-circle-fill text-success ms-1" title="Email verificado"></i>'}
                            </td>
                        </tr>
                        <tr>
                            <th>Role:</th>
                            <td>
                                ${userRole === 'super_admin' 
                                    ? '<span class="badge bg-danger"><i class="bi bi-shield-check"></i> Super Admin</span>' 
                                    : '<span class="badge bg-info">' + userRole + '</span>'}
                            </td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                ${userStatus === 'active' 
                                    ? '<span class="badge bg-success">Ativo</span>' 
                                    : userStatus === 'suspended' 
                                        ? '<span class="badge bg-warning">Suspenso</span>' 
                                        : '<span class="badge bg-secondary">Inativo</span>'}
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Subscrição e Condomínios</h6>
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">Plano:</th>
                            <td>
                                ${planName 
                                    ? '<span class="badge bg-primary">' + planName + '</span>' 
                                    : '<span class="text-muted">Sem plano</span>'}
                                ${subscriptionStatus ? '<br><small class="text-muted">' + subscriptionStatus + '</small>' : ''}
                            </td>
                        </tr>
                        <tr>
                            <th>Condomínios:</th>
                            <td>${totalCondominiums}</td>
                        </tr>
                        <tr>
                            <th>Registado em:</th>
                            <td>${createdDate}</td>
                        </tr>
                    </table>
                </div>
            </div>
            ${condominiumsHtml}
            ${actionsHtml}
        `;
        
        userDetailsModal.show();
        
        // Setup stats buttons after modal is shown
        setTimeout(() => {
            document.querySelectorAll('.btn-stats').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const condoId = this.dataset.condoId;
                    const condoName = this.dataset.condoName;
                    const statsUrl = '{{ BASE_URL }}admin/condominiums/' + condoId + '/stats?modal=1';
                    
                    // Close user details modal
                    userDetailsModal.hide();
                    
                    // Open stats modal
                    setTimeout(() => {
                        const statsModal = new bootstrap.Modal(document.getElementById('condominiumStatsModal'));
                        document.getElementById('condominiumStatsModalLabel').innerHTML = '<i class="bi bi-graph-up"></i> Estatísticas: ' + condoName;
                        document.getElementById('statsIframe').src = statsUrl;
                        document.getElementById('openInNewTab').href = statsUrl;
                        statsModal.show();
                    }, 300);
                });
            });
        }, 100);
    }
    
    // Initialize modals for actions
    function initActionModals() {
        // Assign Super Admin Modal
        const assignModal = document.getElementById('assignSuperAdminModal');
        if (assignModal) {
            assignModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                document.getElementById('assign_user_id').value = button.getAttribute('data-user-id');
                document.getElementById('assign_user_name').textContent = button.getAttribute('data-user-name');
                document.getElementById('assign_user_email').textContent = button.getAttribute('data-user-email');
            });
        }
        
        // Remove Super Admin Modal
        const removeModal = document.getElementById('removeSuperAdminModal');
        if (removeModal) {
            removeModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                document.getElementById('remove_user_id').value = button.getAttribute('data-user-id');
                document.getElementById('remove_user_name').textContent = button.getAttribute('data-user-name');
                document.getElementById('remove_user_email').textContent = button.getAttribute('data-user-email');
            });
        }
        
        // Delete Trial Admin Modal
        const deleteTrialModal = document.getElementById('deleteTrialAdminModal');
        if (deleteTrialModal) {
            deleteTrialModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                document.getElementById('delete_trial_user_id').value = button.getAttribute('data-user-id');
                document.getElementById('delete_trial_user_name').textContent = button.getAttribute('data-user-name');
                document.getElementById('delete_trial_user_email').textContent = button.getAttribute('data-user-email');
                document.getElementById('delete_trial_condominium_count').textContent = button.getAttribute('data-condominium-count') || '0';
                document.getElementById('confirm_delete_trial').checked = false;
                document.getElementById('submit_delete_trial').disabled = true;
            });
            
            const confirmTrialCheckbox = document.getElementById('confirm_delete_trial');
            if (confirmTrialCheckbox) {
                confirmTrialCheckbox.addEventListener('change', function() {
                    document.getElementById('submit_delete_trial').disabled = !this.checked;
                });
            }
        }
        
        // Delete User No Active Plan Modal
        const deleteNoPlanModal = document.getElementById('deleteUserNoActivePlanModal');
        if (deleteNoPlanModal) {
            deleteNoPlanModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                document.getElementById('delete_no_plan_user_id').value = button.getAttribute('data-user-id');
                document.getElementById('delete_no_plan_user_name').textContent = button.getAttribute('data-user-name');
                document.getElementById('delete_no_plan_user_email').textContent = button.getAttribute('data-user-email');
                document.getElementById('delete_no_plan_condominium_count').textContent = button.getAttribute('data-condominium-count') || '0';
                document.getElementById('confirm_delete_no_plan_1').checked = false;
                document.getElementById('confirm_delete_no_plan_2').checked = false;
                document.getElementById('confirm_delete_no_plan_3').checked = false;
                document.getElementById('delete_no_plan_reason').value = '';
                document.getElementById('submit_delete_no_plan').disabled = true;
            });
            
            function checkDeleteNoPlanForm() {
                const check1 = document.getElementById('confirm_delete_no_plan_1').checked;
                const check2 = document.getElementById('confirm_delete_no_plan_2').checked;
                const check3 = document.getElementById('confirm_delete_no_plan_3').checked;
                const reason = document.getElementById('delete_no_plan_reason').value.trim();
                document.getElementById('submit_delete_no_plan').disabled = !(check1 && check2 && check3 && reason.length > 0);
            }
            
            const check1 = document.getElementById('confirm_delete_no_plan_1');
            const check2 = document.getElementById('confirm_delete_no_plan_2');
            const check3 = document.getElementById('confirm_delete_no_plan_3');
            const reason = document.getElementById('delete_no_plan_reason');
            
            if (check1) check1.addEventListener('change', checkDeleteNoPlanForm);
            if (check2) check2.addEventListener('change', checkDeleteNoPlanForm);
            if (check3) check3.addEventListener('change', checkDeleteNoPlanForm);
            if (reason) reason.addEventListener('input', checkDeleteNoPlanForm);
        }
        
        // Delete User No Condominium Modal
        const deleteNoCondoModal = document.getElementById('deleteUserNoCondominiumModal');
        if (deleteNoCondoModal) {
            deleteNoCondoModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                document.getElementById('delete_no_condo_user_id').value = button.getAttribute('data-user-id');
                document.getElementById('delete_no_condo_user_name').textContent = button.getAttribute('data-user-name');
                document.getElementById('delete_no_condo_user_email').textContent = button.getAttribute('data-user-email');
                document.getElementById('confirm_delete_no_condo').checked = false;
                document.getElementById('submit_delete_no_condo').disabled = true;
            });
            
            const confirmNoCondoCheckbox = document.getElementById('confirm_delete_no_condo');
            if (confirmNoCondoCheckbox) {
                confirmNoCondoCheckbox.addEventListener('change', function() {
                    document.getElementById('submit_delete_no_condo').disabled = !this.checked;
                });
            }
        }
        
        // Condominium Stats Modal
        const statsModalEl = document.getElementById('condominiumStatsModal');
        if (statsModalEl) {
            statsModalEl.addEventListener('hidden.bs.modal', function() {
                document.getElementById('statsIframe').src = '';
            });
        }
    }
    
    // Initialize
    initActionModals();
    setupModalHandlers();
    displayRows();
    updatePagination();
});
</script>
