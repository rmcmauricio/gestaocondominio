<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="mb-2 mb-md-0">Movimentos Financeiros</h2>
        <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/finances" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            {% if is_admin %}
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Novo Movimento
            </a>
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/import" class="btn btn-success">
                <i class="bi bi-upload"></i> Importar
            </a>
            {% endif %}
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> Filtros
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" class="row g-3">
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="bank_account_id" class="form-label">Conta</label>
                    <select class="form-select" id="bank_account_id" name="bank_account_id">
                        <option value="">Todas</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {% if filters.bank_account_id == account.id %}selected{% endif %}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="transaction_type" class="form-label">Tipo</label>
                    <select class="form-select" id="transaction_type" name="transaction_type">
                        <option value="">Todos</option>
                        <option value="income" {% if filters.transaction_type == 'income' %}selected{% endif %}>Entrada</option>
                        <option value="expense" {% if filters.transaction_type == 'expense' %}selected{% endif %}>Saída</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="from_date" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="from_date" name="from_date" value="{{ filters.from_date }}">
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="to_date" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="to_date" name="to_date" value="{{ filters.to_date }}">
                </div>
                <div class="col-12">
                    <div class="d-flex flex-column flex-sm-row gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> Movimentos
            </h5>
        </div>
        <div class="card-body">
            {% if transactions %}
            <!-- Desktop Table View -->
            <div class="table-responsive d-none d-lg-block" id="financial-transactions-table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="table table-excel" id="financial-transactions-table" style="min-width: 100%; width: max-content;">
                    <thead>
                        <tr>
                            <th style="width: 60px; text-align: center;" title="ID">ID</th>
                            <th style="width: 50px; text-align: center;" title="Tipo">Tipo</th>
                            <th style="width: 100px;">Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Referência</th>
                            <th class="text-end" style="width: 120px;">Valor</th>
                            <th class="text-end" style="width: 120px;">Saldo</th>
                            {% if is_admin %}
                            <th style="width: 80px; text-align: center;" title="Liquidação de Quotas">
                                <i class="bi bi-cash-coin"></i>
                            </th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr class="transaction-row" style="cursor: pointer;" data-transaction-id="{{ transaction.id }}" data-transaction-type="{{ transaction.transaction_type }}" data-bank-account-id="{{ transaction.bank_account_id }}" title="Clique para ver detalhes">
                            <td style="text-align: center;"><span class="text-muted">#{{ transaction.id }}</span></td>
                            <td style="text-align: center;">
                                {% if transaction.transaction_type == 'income' %}
                                <i class="bi bi-arrow-up-circle-fill text-success" style="font-size: 0.9rem;" title="Entrada"></i>
                                {% else %}
                                <i class="bi bi-arrow-down-circle-fill text-danger" style="font-size: 0.9rem;" title="Saída"></i>
                                {% endif %}
                            </td>
                            <td>{{ transaction.transaction_date|date('d/m/Y') }}</td>
                            <td>
                                {{ transaction.description|slice(0, 50) }}{% if transaction.description|length > 50 %}...{% endif %}
                                {% if transaction.related_type == 'transfer' and transaction.transfer_account_name %}
                                    <br><small class="text-muted">
                                        {% if transaction.transaction_type == 'expense' %}
                                        → Para: {{ transaction.transfer_account_name }}
                                        {% else %}
                                        ← De: {{ transaction.account_name }}
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </td>
                            <td class="{% if is_admin and not transaction.category %}no-row-click{% endif %}">
                                {% if transaction.category %}
                                {{ transaction.category }}
                                {% elseif is_admin %}
                                <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/set-category" class="d-inline form-set-category-mov" id="form-cat-mov-{{ transaction.id }}" data-transaction-id="{{ transaction.id }}" data-transaction-type="{{ transaction.transaction_type }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <select name="category" class="form-select form-select-sm set-category-mov-select" style="min-width: 140px;" data-form-id="form-cat-mov-{{ transaction.id }}">
                                        <option value="__none__">— Sem categoria —</option>
                                        {% if transaction.transaction_type == 'income' %}
                                        {% for cat in revenue_categories|default([]) %}
                                        <option value="{{ cat.name|e('html_attr') }}">{{ cat.name }}</option>
                                        {% endfor %}
                                        {% else %}
                                        {% for cat in expense_categories|default([]) %}
                                        <option value="{{ cat.name|e('html_attr') }}">{{ cat.name }}</option>
                                        {% endfor %}
                                        {% endif %}
                                        <option value="__new__">+ Criar nova...</option>
                                    </select>
                                </form>
                                {% else %}
                                —
                                {% endif %}
                            </td>
                            <td>{{ transaction.reference ?: '-' }}</td>
                            <td class="text-end">
                                <strong class="{% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                    {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}€{{ transaction.amount|number_format(2, ',', '.') }}
                                </strong>
                            </td>
                            <td class="text-end">
                                <strong class="{% if runningBalance[transaction.id] >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    €{{ runningBalance[transaction.id]|number_format(2, ',', '.') }}
                                </strong>
                            </td>
                            {% if is_admin %}
                            <td class="no-row-click" style="text-align: left; font-size: 0.75rem; max-width: 200px;">
                                {% set hasLiquidatedFees = liquidatedFeesByTransaction[transaction.id] is defined and liquidatedFeesByTransaction[transaction.id]|length > 0 %}
                                {% if hasLiquidatedFees %}
                                    {# Show liquidated fees #}
                                    <div class="liquidated-quotas-list">
                                        {% for fee in liquidatedFeesByTransaction[transaction.id] %}
                                        <div class="mb-1" style="line-height: 1.3;">
                                            <i class="bi bi-check-circle-fill text-success" style="font-size: 0.7rem;"></i>
                                            <span title="{{ fee.label }} - €{{ fee.amount|number_format(2, ',', '.') }}" style="margin-left: 0.25rem;">
                                                {{ fee.label }}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% elseif transaction.transaction_type == 'income' and transaction.related_type != 'fee_payment' and transaction.related_type != 'fraction_account' and transaction.related_type != 'transfer' %}
                                <div style="text-align: center;">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary quota-liquidation-btn"
                                            data-transaction-id="{{ transaction.id }}"
                                            data-amount="{{ transaction.amount }}">
                                        <i class="bi bi-cash-coin"></i> Liquidar
                                    </button>
                                </div>
                                {% endif %}
                                {% if accounts|length >= 2 and transaction.related_type != 'transfer' and not hasLiquidatedFees and not transaction.category %}
                                <div class="mt-1" style="text-align: center;">
                                    <button type="button" class="btn btn-sm btn-outline-secondary mark-transfer-list-btn no-row-click" title="Marcar como transferência" data-transaction-id="{{ transaction.id }}" data-transaction-type="{{ transaction.transaction_type }}" data-bank-account-id="{{ transaction.bank_account_id }}" data-description="{{ transaction.description|default('')|e('html_attr') }}">
                                        <i class="bi bi-arrow-left-right"></i> Transferência
                                    </button>
                                </div>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile/Tablet Card View -->
            <div class="d-lg-none">
                <div class="row g-3">
                    {% for transaction in transactions %}
                    <div class="col-12">
                        <div class="card shadow-sm transaction-card {% if transaction.transaction_type == 'income' %}border-success border-2{% else %}border-danger border-2{% endif %}" style="cursor: pointer;" data-transaction-id="{{ transaction.id }}" data-transaction-type="{{ transaction.transaction_type }}" data-bank-account-id="{{ transaction.bank_account_id }}" title="Clique para ver detalhes">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span class="text-muted small">#{{ transaction.id }}</span>
                                            <strong class="text-muted">{{ transaction.transaction_date|date('d/m/Y') }}</strong>
                                            {% if transaction.related_type == 'transfer' %}
                                                {% if transaction.transaction_type == 'income' %}
                                                <span class="badge bg-info">Transferência Recebida</span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">Transferência Enviada</span>
                                                {% endif %}
                                            {% elseif transaction.transaction_type == 'income' %}
                                            <span class="badge bg-success">Entrada</span>
                                            {% else %}
                                            <span class="badge bg-danger">Saída</span>
                                            {% endif %}
                                        </div>
                                        <h6 class="mb-1 fw-bold">{{ transaction.account_name }}</h6>
                                        {% if transaction.account_type == 'cash' %}
                                        <span class="badge bg-info">Caixa</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <strong class="h5 mb-0 {% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                            {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}€{{ transaction.amount|number_format(2, ',', '.') }}
                                        </strong>
                                    </div>
                                </div>

                                <div class="mb-2 transaction-card-desc-wrap">
                                    <strong>Descrição:</strong>
                                    <p class="mb-1 transaction-card-desc">{{ transaction.description }}</p>
                                    {% if transaction.related_type == 'transfer' and transaction.transfer_account_name %}
                                    <small class="text-muted d-block transaction-card-transfer-info">
                                        {% if transaction.transaction_type == 'expense' %}
                                        <i class="bi bi-arrow-right"></i> Para: {{ transaction.transfer_account_name }}
                                        {% else %}
                                        <i class="bi bi-arrow-left"></i> De: {{ transaction.account_name }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block"><strong>Categoria:</strong></small>
                                        {% if transaction.category %}
                                        <span class="transaction-card-category">{{ transaction.category }}</span>
                                        {% elseif is_admin %}
                                        <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/set-category" class="d-inline form-set-category-mov" id="form-cat-mov-card-{{ transaction.id }}" data-transaction-id="{{ transaction.id }}" data-transaction-type="{{ transaction.transaction_type }}">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <select name="category" class="form-select form-select-sm set-category-mov-select" style="min-width: 120px;" data-form-id="form-cat-mov-card-{{ transaction.id }}">
                                                <option value="__none__">— Sem categoria —</option>
                                                {% if transaction.transaction_type == 'income' %}
                                                {% for cat in revenue_categories|default([]) %}
                                                <option value="{{ cat.name|e('html_attr') }}">{{ cat.name }}</option>
                                                {% endfor %}
                                                {% else %}
                                                {% for cat in expense_categories|default([]) %}
                                                <option value="{{ cat.name|e('html_attr') }}">{{ cat.name }}</option>
                                                {% endfor %}
                                                {% endif %}
                                                <option value="__new__">+ Criar nova...</option>
                                            </select>
                                        </form>
                                        {% else %}
                                        <span class="transaction-card-category">—</span>
                                        {% endif %}
                                    </div>
                                    {% if transaction.reference %}
                                    <div class="col-6">
                                        <small class="text-muted d-block"><strong>Referência:</strong></small>
                                        <span>{{ transaction.reference }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="col-12">
                                        <small class="text-muted d-block"><strong>Saldo Acumulado:</strong></small>
                                        <strong class="{% if runningBalance[transaction.id] >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            €{{ runningBalance[transaction.id]|number_format(2, ',', '.') }}
                                        </strong>
                                    </div>
                                    {% set hasLiquidatedFeesCard = liquidatedFeesByTransaction[transaction.id] is defined and liquidatedFeesByTransaction[transaction.id]|length > 0 %}
                                    {% if is_admin and accounts|length >= 2 and transaction.related_type != 'transfer' and not hasLiquidatedFeesCard and not transaction.category %}
                                    <div class="col-12 pt-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary mark-transfer-list-btn w-100" title="Marcar como transferência" data-transaction-id="{{ transaction.id }}" data-transaction-type="{{ transaction.transaction_type }}" data-bank-account-id="{{ transaction.bank_account_id }}" data-description="{{ transaction.description|default('')|e('html_attr') }}">
                                            <i class="bi bi-arrow-left-right"></i> Marcar como transferência
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>

                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Nenhum movimento financeiro encontrado.
            </div>
            {% endif %}

            {% if pagination and pagination.total_pages > 1 %}
            <nav aria-label="Paginação" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if pagination.current_page > 1 %}
                        {% set prevPage = pagination.current_page - 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ prevPage }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </span>
                        </li>
                    {% endif %}

                    {% set startPage = max(1, pagination.current_page - 2) %}
                    {% set endPage = min(pagination.total_pages, pagination.current_page + 2) %}

                    {% if startPage > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">1</a>
                        </li>
                        {% if startPage > 2 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endif %}

                    {% for i in startPage..endPage %}
                        <li class="page-item {% if i == pagination.current_page %}active{% endif %}">
                            <a class="page-link" href="?page={{ i }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">{{ i }}</a>
                        </li>
                    {% endfor %}

                    {% if endPage < pagination.total_pages %}
                        {% if endPage < pagination.total_pages - 1 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pagination.total_pages }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">{{ pagination.total_pages }}</a>
                        </li>
                    {% endif %}

                    {% if pagination.current_page < pagination.total_pages %}
                        {% set nextPage = pagination.current_page + 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ nextPage }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}" aria-label="Próximo">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-label="Próximo">
                                <span aria-hidden="true">&raquo;</span>
                            </span>
                        </li>
                    {% endif %}
                </ul>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        Mostrando {{ ((pagination.current_page - 1) * pagination.per_page) + 1 }}-{{ min(pagination.current_page * pagination.per_page, pagination.total_items) }} de {{ pagination.total_items }} movimentos
                    </small>
                </div>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Zebra striping simples - linhas pares cinzento claro, ímpares branco */
body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(even) td {
    background-color: #e9ecef !important;
}

body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(odd) td {
    background-color: #ffffff !important;
}

/* Hover effect - amarelo pastel claro para todas as linhas */
body #financial-transactions-table-container #financial-transactions-table tbody tr:hover td {
    background-color: #fff9e6 !important;
}

/* Cursor pointer */
body #financial-transactions-table-container #financial-transactions-table tbody tr {
    cursor: pointer !important;
}

/* Scroll horizontal sempre visível em todos os dispositivos */
#financial-transactions-table-container {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    width: 100%;
}

#financial-transactions-table {
    width: max-content;
    min-width: 100%;
}

#financial-transactions-table th,
#financial-transactions-table td {
    white-space: nowrap;
}

/* Permitir quebra de linha apenas em descrição */
#financial-transactions-table td:nth-child(4) {
    white-space: normal;
    min-width: 150px;
    max-width: 200px;
}

/* Resizable columns */
#financial-transactions-table th {
    position: relative;
    user-select: none;
}

#financial-transactions-table th .resize-handle {
    position: absolute;
    top: 0;
    right: -2px;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    background: transparent;
    z-index: 10;
    transition: background 0.2s;
}

#financial-transactions-table th .resize-handle:hover {
    background: #007bff;
    opacity: 0.7;
}

#financial-transactions-table th .resize-handle.resizing {
    background: #0056b3;
    opacity: 1;
}
</style>

<script>
// Column resizing functionality
(function() {
    const table = document.getElementById('financial-transactions-table');
    if (!table) return;

    const storageKey = 'financial-transactions-table-column-widths';

    // Load saved widths
    function loadColumnWidths() {
        try {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                const widths = JSON.parse(saved);
                const headers = table.querySelectorAll('thead th');
                headers.forEach((th, index) => {
                    if (widths[index]) {
                        th.style.width = widths[index] + 'px';
                        th.style.minWidth = widths[index] + 'px';
                    }
                });
            }
        } catch (e) {
            console.error('Error loading column widths:', e);
        }
    }

    // Save column widths
    function saveColumnWidths() {
        try {
            const headers = table.querySelectorAll('thead th');
            const widths = Array.from(headers).map(th => {
                const width = th.style.width || th.getAttribute('data-original-width') || 'auto';
                return width === 'auto' ? null : parseInt(width);
            });
            localStorage.setItem(storageKey, JSON.stringify(widths));
        } catch (e) {
            console.error('Error saving column widths:', e);
        }
    }

    // Initialize resize handles
    function initResizeHandles() {
        const headers = table.querySelectorAll('thead th');

        headers.forEach((th, index) => {
            // Skip last column (actions) - don't make it resizable
            if (index === headers.length - 1) return;

            // Store original width
            const originalWidth = th.style.width || window.getComputedStyle(th).width;
            th.setAttribute('data-original-width', originalWidth);

            // Create resize handle
            const handle = document.createElement('div');
            handle.className = 'resize-handle';
            handle.setAttribute('data-column-index', index);
            th.appendChild(handle);

            // Make header position relative if not already
            if (window.getComputedStyle(th).position === 'static') {
                th.style.position = 'relative';
            }

            // Resize functionality
            let startX, startWidth, columnIndex;

            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();

                startX = e.pageX;
                startWidth = parseInt(window.getComputedStyle(th).width);
                columnIndex = index;

                handle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                function onMouseMove(e) {
                    const diff = e.pageX - startX;
                    const newWidth = Math.max(50, startWidth + diff); // Minimum 50px

                    th.style.width = newWidth + 'px';
                    th.style.minWidth = newWidth + 'px';
                    th.style.maxWidth = newWidth + 'px';

                    // Update corresponding cells
                    const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
                    cells.forEach(cell => {
                        cell.style.width = newWidth + 'px';
                        cell.style.minWidth = newWidth + 'px';
                        cell.style.maxWidth = newWidth + 'px';
                    });
                }

                function onMouseUp() {
                    handle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    saveColumnWidths();
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            loadColumnWidths();
            initResizeHandles();
        });
    } else {
        loadColumnWidths();
        initResizeHandles();
    }
})();
</script>

<!-- Modal Marcar como transferência (lista de movimentos) -->
{% if is_admin and accounts|length >= 2 %}
<div class="modal fade" id="modalMarkTransferList" tabindex="-1" aria-labelledby="modalMarkTransferListLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formMarkTransferList" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMarkTransferListLabel"><i class="bi bi-arrow-left-right"></i> Marcar como transferência</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2" id="modalMarkTransferListDesc">—</p>
                    <p class="mb-2" id="modalMarkTransferListPrompt">Selecione a conta:</p>
                    <select name="transfer_account_id" class="form-select" required id="modalMarkTransferListSelect">
                        <option value="">— Selecionar conta —</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}">{{ account.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Marcar como transferência</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para Liquidação de Quotas -->
<div class="modal fade" id="quotaLiquidationModal" tabindex="-1" aria-labelledby="quotaLiquidationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quotaLiquidationModalLabel">Liquidação de Quotas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="modal_quota_liquidation_checkbox">
                        <label class="form-check-label" for="modal_quota_liquidation_checkbox">
                            <strong>Liquidar quotas para este movimento</strong>
                        </label>
                    </div>
                </div>

                <div id="modal_quota_config" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Liquidação automática:</strong> O valor será aplicado às quotas mais antigas primeiro, sequencialmente.
                        Se selecionar quotas específicas abaixo, essas serão liquidadas primeiro e o valor restante será aplicado às mais antigas.
                    </div>

                    <div class="mb-3">
                        <label for="modal_quota_fraction" class="form-label">Fração <span class="text-danger">*</span></label>
                        <select class="form-select" id="modal_quota_fraction">
                            <option value="">Selecione fração...</option>
                            {% for fraction in fractions|default([]) %}
                            <option value="{{ fraction.id }}">{{ fraction.identifier }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="modal_fraction_balance_info" style="display: none;" class="mb-3">
                        <div class="alert alert-success">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="modal_use_fraction_balance">
                                <label class="form-check-label" for="modal_use_fraction_balance">
                                    <strong>Usar saldo da fração</strong>
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">
                                Saldo disponível: <strong id="modal_fraction_balance_amount">0.00</strong> €
                            </small>
                        </div>
                    </div>

                    <div id="modal_quota_list" style="display: none;">
                        <label class="form-label"><strong>Selecione quotas específicas (opcional):</strong></label>
                        <div class="quota-checkboxes-modal" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.75rem; margin-top: 0.5rem;"></div>
                        <div class="quota-summary-modal mt-2" style="display: none;">
                            <small class="text-muted">
                                <span class="quota-selected-total-modal">0.00</span> € selecionado |
                                Restante: <span class="quota-remaining-modal">0.00</span> € <span class="quota-remaining-dest-text">será aplicado às mais antigas</span>
                            </small>
                        </div>
                        <div id="modal_remaining_destination_section" class="mt-2" style="display: none;">
                            <label class="form-label"><strong>Destino do valor restante:</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal_remaining_destination" id="modal_remaining_oldest" value="oldest" checked>
                                <label class="form-check-label" for="modal_remaining_oldest">Aplicar às quotas mais antigas (registadas no sistema)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal_remaining_destination" id="modal_remaining_unregistered" value="unregistered">
                                <label class="form-check-label" for="modal_remaining_unregistered">Referente a quotas antigas não registadas no sistema</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal_remaining_destination" id="modal_remaining_balance" value="balance">
                                <label class="form-check-label" for="modal_remaining_balance">Fica em saldo na fração</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveQuotaLiquidation">Guardar</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal de confirmação deve aparecer acima do modal de detalhes do movimento */
#confirmDeleteQuotaModal { z-index: 1065 !important; }
</style>
<!-- Modal Confirmar Eliminar Associação Quota -->
<div class="modal fade" id="confirmDeleteQuotaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirmar eliminação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Tem certeza que deseja eliminar a associação desta quota ao movimento? O pagamento será removido e o estado da quota será atualizado.</p>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteQuotaBtn">
                    <i class="bi bi-trash me-1"></i>Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Detalhes do Movimento -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Detalhes do Movimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">A carregar...</p>
                </div>
            </div>
            <div class="modal-footer flex-wrap gap-2" id="transactionDetailsFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
const condominiumId = {{ condominium.id }};
const baseUrl = '{{ BASE_URL }}';
const accountsList = {{ accounts|json_encode|raw }};
let quotaModal = null;
let currentTransactionId = null;
let currentTransactionAmount = 0;

// Initialize modal
function initQuotaModal() {
    const modalElement = document.getElementById('quotaLiquidationModal');
    if (modalElement) {
        // Listeners for remaining destination radios (only once)
        if (!modalElement.dataset.remainingDestListeners) {
            modalElement.dataset.remainingDestListeners = '1';
            document.querySelectorAll('input[name="modal_remaining_destination"]').forEach(r => {
                r.addEventListener('change', updateRemainingDestText);
            });
        }
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            quotaModal = new bootstrap.Modal(modalElement);

            // Clear modal when hidden
            modalElement.addEventListener('hidden.bs.modal', function() {
                const checkbox = document.getElementById('modal_quota_liquidation_checkbox');
                const config = document.getElementById('modal_quota_config');
                const fraction = document.getElementById('modal_quota_fraction');
                const list = document.getElementById('modal_quota_list');
                const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
                const summaryDiv = document.querySelector('.quota-summary-modal');
                const balanceInfo = document.getElementById('modal_fraction_balance_info');
                const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
                const remainingDestSection = document.getElementById('modal_remaining_destination_section');
                const oldestRadio = document.getElementById('modal_remaining_oldest');

                if (checkbox) checkbox.checked = false;
                if (config) config.style.display = 'none';
                if (fraction) fraction.value = '';
                if (list) list.style.display = 'none';
                if (checkboxesDiv) checkboxesDiv.innerHTML = '';
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (balanceInfo) balanceInfo.style.display = 'none';
                if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
                if (remainingDestSection) remainingDestSection.style.display = 'none';
                if (oldestRadio) oldestRadio.checked = true;
                currentTransactionId = null;
                currentTransactionAmount = 0;
            });
        }
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQuotaModal);
} else {
    initQuotaModal();
}

// Open transaction details modal (used by click handler and ?view=id URL param)
function openTransactionDetailsModal(tid) {
    if (!tid) return;
    const modalEl = document.getElementById('transactionDetailsModal');
    const contentEl = document.getElementById('transactionDetailsContent');
    if (!modalEl || !contentEl) return;
    contentEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">A carregar...</p></div>';
    const footerEl = document.getElementById('transactionDetailsFooter');
    if (footerEl) footerEl.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    fetch(`{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/${tid}/info`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    contentEl.innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                    return;
                }
                const t = data.transaction;
                const fees = data.liquidated_fees || [];
                let html = '<div class="row g-3">';
                html += '<div class="col-md-6"><strong>Data:</strong><br>' + (t.transaction_date ? new Date(t.transaction_date).toLocaleDateString('pt-PT') : '-') + '</div>';
                html += '<div class="col-md-6"><strong>Tipo:</strong><br>' + (t.transaction_type === 'income' ? '<span class="text-success">Entrada</span>' : '<span class="text-danger">Saída</span>') + '</div>';
                html += '<div class="col-md-6"><strong>Conta:</strong><br>' + (t.account_name || '-') + '</div>';
                html += '<div class="col-md-6"><strong>Valor:</strong><br><strong class="' + (t.transaction_type === 'income' ? 'text-success' : 'text-danger') + '">' + (t.transaction_type === 'income' ? '+' : '-') + '€' + parseFloat(t.amount).toFixed(2).replace('.', ',') + '</strong></div>';
                if (t.fraction_identifier) html += '<div class="col-md-6"><strong>Fração:</strong><br>' + t.fraction_identifier + '</div>';
                if (t.reference) html += '<div class="col-md-6"><strong>Referência:</strong><br><code>' + t.reference + '</code></div>';
                if (t.category) html += '<div class="col-md-6"><strong>Categoria:</strong><br>' + t.category + '</div>';
                if (t.transfer_account_name) html += '<div class="col-12"><strong>Transferência para:</strong><br>' + t.transfer_account_name + '</div>';
                html += '<div class="col-12"><strong>Descrição:</strong><br>' + (t.description || '-') + '</div>';
                if (fees.length > 0) {
                    const isAdmin = {{ is_admin|default(false) ? 'true' : 'false' }};
                    html += '<div class="col-12"><strong>Quotas associadas/liquidadas:</strong><ul class="list-group list-group-flush mt-1">';
                    fees.forEach(f => {
                        const actions = (isAdmin && f.payment_id && f.fee_id) ? ' <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="deletePaymentFromMovementModal(' + f.payment_id + ', ' + f.fee_id + ')" title="Eliminar associação desta quota"><i class="bi bi-trash"></i></button>' : '';
                        html += '<li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">' +
                            '<div class="d-flex align-items-center flex-wrap">' + f.label + actions + '</div>' +
                            '<span class="badge bg-success">€' + f.amount.toFixed(2).replace('.', ',') + '</span></li>';
                    });
                    html += '</ul></div>';
                } else if (t.related_type === 'fee_payment' || t.category === 'Quotas') {
                    html += '<div class="col-12"><div class="alert alert-info mb-0"><i class="bi bi-info-circle me-2"></i>Movimento de pagamento de quotas. As quotas associadas não foram encontradas (pode ter ocorrido uma inconsistência). Pode eliminar o movimento usando o botão abaixo.</div></div>';
                }
                html += '</div>';
                contentEl.innerHTML = html;

                const footerEl = document.getElementById('transactionDetailsFooter');
                if (footerEl) {
                    const isAdmin = {{ is_admin|default(false) ? 'true' : 'false' }};
                    const rt = t.related_type || '';
                    const hasLinkedPayments = fees.length > 0 || rt === 'fee_payment' || rt === 'fraction_account' || t.category === 'Quotas';
                    let footerHtml = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>';
                    if (isAdmin) {
                        if (rt === 'transfer') {
                            footerHtml += '<a href="{{ BASE_URL }}condominiums/' + condominiumId + '/financial-transactions/' + t.id + '/edit" class="btn btn-primary"><i class="bi bi-pencil me-1"></i>Editar</a>';
                            footerHtml += '<form method="POST" action="{{ BASE_URL }}condominiums/' + condominiumId + '/financial-transactions/' + t.id + '/delete" class="d-inline" onsubmit="return confirm(\'Tem certeza que deseja eliminar esta transferência? Ambas as transações serão eliminadas.\');"><input type="hidden" name="csrf_token" value="{{ csrf_token }}"><button type="submit" class="btn btn-danger"><i class="bi bi-trash me-1"></i>Eliminar Transferência</button></form>';
                        } else if (hasLinkedPayments) {
                            footerHtml += '<form method="POST" action="{{ BASE_URL }}condominiums/' + condominiumId + '/financial-transactions/' + t.id + '/delete" class="d-inline" onsubmit="return confirm(\'Tem certeza? Os pagamentos de quotas associados serão eliminados primeiro e o estado das quotas será atualizado.\');"><input type="hidden" name="csrf_token" value="{{ csrf_token }}"><input type="hidden" name="delete_with_payments" value="1"><button type="submit" class="btn btn-danger"><i class="bi bi-trash me-1"></i>Eliminar</button></form>';
                        } else {
                            footerHtml += '<a href="{{ BASE_URL }}condominiums/' + condominiumId + '/financial-transactions/' + t.id + '/edit" class="btn btn-primary"><i class="bi bi-pencil me-1"></i>Editar</a>';
                            footerHtml += '<form method="POST" action="{{ BASE_URL }}condominiums/' + condominiumId + '/financial-transactions/' + t.id + '/delete" class="d-inline" onsubmit="return confirm(\'Tem certeza que deseja eliminar este movimento?\');"><input type="hidden" name="csrf_token" value="{{ csrf_token }}"><button type="submit" class="btn btn-danger"><i class="bi bi-trash me-1"></i>Eliminar</button></form>';
                        }
                    }
                    footerEl.innerHTML = footerHtml;
                }
            })
            .catch(err => {
                contentEl.innerHTML = '<div class="alert alert-danger">Erro ao carregar detalhes: ' + err.message + '</div>';
            });
}

// Delete payment from movement details modal (shows confirmation modal, then redirects to financial-transactions)
let pendingDeletePayment = null;
let pendingDeleteFeeId = null;
function deletePaymentFromMovementModal(paymentId, feeId) {
    pendingDeletePayment = paymentId;
    pendingDeleteFeeId = feeId;
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteQuotaModal'));
    modal.show();
}
function initConfirmDeleteQuotaModal() {
    const modalEl = document.getElementById('confirmDeleteQuotaModal');
    if (modalEl && !modalEl.dataset.listenerAttached) {
        modalEl.dataset.listenerAttached = '1';
        modalEl.addEventListener('shown.bs.modal', function() {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            if (backdrops.length > 0) {
                backdrops[backdrops.length - 1].style.zIndex = '1060';
            }
        });
    }
    const btn = document.getElementById('confirmDeleteQuotaBtn');
    if (btn && !btn.dataset.listenerAttached) {
        btn.dataset.listenerAttached = '1';
        btn.addEventListener('click', function() {
            if (!pendingDeletePayment || !pendingDeleteFeeId) return;
            bootstrap.Modal.getInstance(document.getElementById('confirmDeleteQuotaModal')).hide();
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `{{ BASE_URL }}condominiums/${condominiumId}/fees/${pendingDeleteFeeId}/payments/${pendingDeletePayment}/delete`;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token }}';
            form.appendChild(csrfInput);
            const redirectInput = document.createElement('input');
            redirectInput.type = 'hidden';
            redirectInput.name = 'redirect_to';
            redirectInput.value = 'financial-transactions';
            form.appendChild(redirectInput);
            document.body.appendChild(form);
            form.submit();
            pendingDeletePayment = null;
            pendingDeleteFeeId = null;
        });
    }
}
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initConfirmDeleteQuotaModal);
} else {
    initConfirmDeleteQuotaModal();
}

// Marcar como transferência (lista de movimentos) - abrir modal
document.addEventListener('click', function(e) {
    const markTransferBtn = e.target.closest('.mark-transfer-list-btn');
    if (markTransferBtn) {
        e.preventDefault();
        e.stopPropagation();
        const tid = markTransferBtn.dataset.transactionId;
        const type = markTransferBtn.dataset.transactionType;
        const bankAccountId = parseInt(markTransferBtn.dataset.bankAccountId, 10) || 0;
        const description = markTransferBtn.dataset.description || '';
        const form = document.getElementById('formMarkTransferList');
        const modalEl = document.getElementById('modalMarkTransferList');
        const selectEl = document.getElementById('modalMarkTransferListSelect');
        const descEl = document.getElementById('modalMarkTransferListDesc');
        const promptEl = document.getElementById('modalMarkTransferListPrompt');
        if (!form || !modalEl || !selectEl) return;
        const action = baseUrl + 'condominiums/' + condominiumId + (type === 'income' ? '/finances/revenues/' : '/expenses/') + tid + '/mark-as-transfer';
        form.action = action;
        form.dataset.transactionId = tid;
        form.dataset.transactionType = type;
        if (descEl) descEl.textContent = description ? (description.length > 60 ? description.slice(0, 60) + '...' : description) : '—';
        if (promptEl) promptEl.textContent = type === 'income' ? 'Selecione a conta origem da transferência:' : 'Selecione a conta destino da transferência:';
        selectEl.innerHTML = '<option value="">— Selecionar conta —</option>';
        accountsList.forEach(function(acc) {
            if (acc.id != bankAccountId) {
                const opt = document.createElement('option');
                opt.value = acc.id;
                opt.textContent = acc.name;
                selectEl.appendChild(opt);
            }
        });
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        return;
    }
});

// Marcar como transferência - submit por AJAX
(function() {
    const form = document.getElementById('formMarkTransferList');
    if (!form) return;
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const tid = form.dataset.transactionId;
        const type = form.dataset.transactionType;
        const selectEl = document.getElementById('modalMarkTransferListSelect');
        if (!selectEl || !selectEl.value) return;
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;
        const formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(r) {
            return r.text().then(function(text) {
                try { var data = text ? JSON.parse(text) : {}; } catch(err) { return { ok: false, data: { error: 'Resposta inválida do servidor.' } }; }
                return { ok: r.ok, data: data };
            });
        })
        .then(function(result) {
            if (submitBtn) submitBtn.disabled = false;
            if (result.ok && result.data.success) {
                const modalEl = document.getElementById('modalMarkTransferList');
                if (modalEl && bootstrap.Modal.getInstance(modalEl)) bootstrap.Modal.getInstance(modalEl).hide();
                const transferAccountId = parseInt(selectEl.value, 10);
                const acc = accountsList.find(function(a) { return a.id == transferAccountId; });
                const accountName = acc ? acc.name : '';
                const row = document.querySelector('.transaction-row[data-transaction-id="' + tid + '"]');
                if (row) {
                    const catCell = row.querySelector('td:nth-child(5)');
                    if (catCell) catCell.textContent = 'Transferência';
                    const descCell = row.querySelector('td:nth-child(4)');
                    if (descCell) {
                        let mainText = descCell.textContent.trim().split('\n')[0] || '';
                        if (mainText.length > 50) mainText = mainText.slice(0, 50) + '...';
                        descCell.innerHTML = mainText + (accountName ? '<br><small class="text-muted">' + (type === 'expense' ? '→ Para: ' : '← De: ') + accountName + '</small>' : '');
                    }
                    const transferBtn = row.querySelector('.mark-transfer-list-btn');
                    if (transferBtn && transferBtn.closest('div.mt-1')) transferBtn.closest('div.mt-1').style.display = 'none';
                }
                const card = document.querySelector('.transaction-card[data-transaction-id="' + tid + '"]');
                if (card) {
                    const catSpan = card.querySelector('.transaction-card-category');
                    if (catSpan) catSpan.textContent = 'Transferência';
                    const descWrap = card.querySelector('.transaction-card-desc-wrap');
                    if (descWrap) {
                        let descEl = descWrap.querySelector('.transaction-card-desc');
                        let mainText = descEl ? descEl.textContent.trim() : '';
                        let transferInfo = descWrap.querySelector('.transaction-card-transfer-info');
                        if (!transferInfo) {
                            transferInfo = document.createElement('small');
                            transferInfo.className = 'text-muted d-block transaction-card-transfer-info';
                            descWrap.appendChild(transferInfo);
                        }
                        transferInfo.innerHTML = accountName ? ((type === 'expense' ? '<i class="bi bi-arrow-right"></i> Para: ' : '<i class="bi bi-arrow-left"></i> De: ') + accountName) : '';
                    }
                    const cardTransferBtn = card.querySelector('.mark-transfer-list-btn');
                    if (cardTransferBtn && cardTransferBtn.closest('.col-12')) cardTransferBtn.closest('.col-12').style.display = 'none';
                }
            } else {
                alert(result.data && result.data.error ? result.data.error : 'Erro ao marcar como transferência.');
            }
        })
        .catch(function() {
            if (submitBtn) submitBtn.disabled = false;
            alert('Erro de ligação. Tente novamente.');
        });
    });
})();

// Categorizar movimento por AJAX (entrada = categorias de receitas, saída = categorias de despesas)
document.addEventListener('DOMContentLoaded', function() {
    function hasOptionWithValue(selectEl, value) {
        for (var i = 0; i < selectEl.options.length; i++) {
            if (selectEl.options[i].value === value) return true;
        }
        return false;
    }
    function sendCategoryMovAjax(form, categoryValue, selectEl) {
        var row = form.closest('tr');
        var formData = new FormData();
        formData.append('csrf_token', form.querySelector('input[name="csrf_token"]').value);
        formData.append('category', categoryValue || '__none__');
        var prevValue = selectEl.dataset.prevValue || '';
        selectEl.disabled = true;
        if (row) row.classList.add('opacity-75');
        fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(function(r) {
            return r.text().then(function(text) {
                try { var data = text ? JSON.parse(text) : {}; } catch(err) { return { ok: false, data: { error: 'Resposta inválida do servidor.' } }; }
                return { ok: r.ok, data: data };
            });
        })
        .then(function(result) {
            selectEl.disabled = false;
            if (row) row.classList.remove('opacity-75');
            if (result.ok && result.data.success) {
                var newCat = result.data.category;
                if (newCat && !hasOptionWithValue(selectEl, newCat)) {
                    window.location.reload();
                    return;
                }
                selectEl.value = newCat || '__none__';
                selectEl.dataset.prevValue = newCat || '';
            } else {
                selectEl.value = prevValue || '__none__';
                alert(result.data && result.data.error ? result.data.error : 'Erro ao guardar categoria.');
            }
        })
        .catch(function() {
            selectEl.disabled = false;
            if (row) row.classList.remove('opacity-75');
            selectEl.value = prevValue || '__none__';
            alert('Erro de ligação. Tente novamente.');
        });
    }
    document.querySelectorAll('.set-category-mov-select').forEach(function(sel) {
        sel.dataset.prevValue = sel.value || '';
        sel.addEventListener('change', function(e) {
            var v = this.value;
            var formId = this.getAttribute('data-form-id');
            if (!formId) return;
            var form = document.getElementById(formId);
            if (!form) return;
            if (v === '__new__') {
                var selectEl = this;
                window.openNewCategoryModal(function(name) {
                    sendCategoryMovAjax(form, name, selectEl);
                });
                this.value = this.dataset.prevValue || '__none__';
            } else {
                sendCategoryMovAjax(form, v, this);
            }
        });
    });
});

// View transaction details - click handlers (row click and legacy button)
document.addEventListener('click', function(e) {
    if (e.target.closest('.no-row-click')) return;
    const row = e.target.closest('.transaction-row');
    const card = e.target.closest('.transaction-card');
    const btn = e.target.closest('.view-transaction-details');
    const tid = row?.dataset?.transactionId || card?.dataset?.transactionId || btn?.dataset?.transactionId;
    if (tid) {
        e.preventDefault();
        if (btn) e.stopPropagation();
        openTransactionDetailsModal(tid);
    }
});

// Open modal when URL has ?view=id (ex: link from quota payment history)
(function() {
    const params = new URLSearchParams(window.location.search);
    const viewId = params.get('view');
    if (viewId) {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() { openTransactionDetailsModal(viewId); });
        } else {
            openTransactionDetailsModal(viewId);
        }
        params.delete('view');
        const qs = params.toString();
        history.replaceState({}, '', window.location.pathname + (qs ? '?' + qs : ''));
    }
})();

// Handle quota liquidation button click - open modal
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.quota-liquidation-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();

        currentTransactionId = btn.dataset.transactionId;
        currentTransactionAmount = parseFloat(btn.dataset.amount) || 0;

        // Reset modal
        const modalCheckbox = document.getElementById('modal_quota_liquidation_checkbox');
        const modalConfig = document.getElementById('modal_quota_config');
        const modalFraction = document.getElementById('modal_quota_fraction');
        const modalList = document.getElementById('modal_quota_list');
        const balanceInfo = document.getElementById('modal_fraction_balance_info');
        const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');

        if (modalCheckbox) modalCheckbox.checked = false;
        if (modalFraction) modalFraction.value = '';
        if (modalConfig) modalConfig.style.display = 'none';
        if (modalList) modalList.style.display = 'none';
        if (balanceInfo) balanceInfo.style.display = 'none';
        if (useBalanceCheckbox) useBalanceCheckbox.checked = false;

        const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
        const summaryDiv = document.querySelector('.quota-summary-modal');
        const remainingDestSection = document.getElementById('modal_remaining_destination_section');
        const oldestRadio = document.getElementById('modal_remaining_oldest');
        if (checkboxesDiv) checkboxesDiv.innerHTML = '';
        if (summaryDiv) summaryDiv.style.display = 'none';
        if (remainingDestSection) remainingDestSection.style.display = 'none';
        if (oldestRadio) oldestRadio.checked = true;

        // Show modal
        const modalElement = document.getElementById('quotaLiquidationModal');
        if (modalElement) {
            if (!quotaModal) {
                initQuotaModal();
            }
            if (quotaModal) {
                quotaModal.show();
            } else {
                const bsModal = new bootstrap.Modal(modalElement);
                bsModal.show();
            }
        }
    }
});

// Handle checkbox in modal - show/hide config section
document.getElementById('modal_quota_liquidation_checkbox').addEventListener('change', function() {
    const configSection = document.getElementById('modal_quota_config');
    if (this.checked) {
        configSection.style.display = 'block';
    } else {
        configSection.style.display = 'none';
        const fraction = document.getElementById('modal_quota_fraction');
        const list = document.getElementById('modal_quota_list');
        const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
        const summaryDiv = document.querySelector('.quota-summary-modal');
        if (fraction) fraction.value = '';
        if (list) list.style.display = 'none';
        if (checkboxesDiv) checkboxesDiv.innerHTML = '';
        if (summaryDiv) summaryDiv.style.display = 'none';
    }
});

// Handle fraction selection in modal - load pending fees and balance
document.getElementById('modal_quota_fraction').addEventListener('change', function() {
    const fractionId = this.value;

    if (fractionId) {
        loadFractionBalance(fractionId);
        loadQuotasForModal(fractionId, currentTransactionAmount);
    } else {
        const list = document.getElementById('modal_quota_list');
        const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
        const summaryDiv = document.querySelector('.quota-summary-modal');
        const balanceInfo = document.getElementById('modal_fraction_balance_info');
        const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
        if (list) list.style.display = 'none';
        if (checkboxesDiv) checkboxesDiv.innerHTML = '';
        if (summaryDiv) summaryDiv.style.display = 'none';
        if (balanceInfo) balanceInfo.style.display = 'none';
        if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
    }
});

function loadFractionBalance(fractionId) {
    const balanceInfo = document.getElementById('modal_fraction_balance_info');
    const balanceAmount = document.getElementById('modal_fraction_balance_amount');
    const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');

    fetch(`{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/fraction-balance/${fractionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.has_balance) {
                if (balanceAmount) {
                    balanceAmount.textContent = parseFloat(data.balance).toFixed(2);
                }
                if (balanceInfo) {
                    balanceInfo.style.display = 'block';
                }
                // Add event listener to checkbox to update summary when toggled
                if (useBalanceCheckbox) {
                    useBalanceCheckbox.addEventListener('change', function() {
                        const fractionId = document.getElementById('modal_quota_fraction').value;
                        if (fractionId) {
                            loadQuotasForModal(fractionId, currentTransactionAmount);
                        }
                    });
                }
            } else {
                if (balanceInfo) balanceInfo.style.display = 'none';
                if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
            }
        })
        .catch(error => {
            console.error('Error loading fraction balance:', error);
            if (balanceInfo) balanceInfo.style.display = 'none';
        });
}

function loadQuotasForModal(fractionId, transactionAmount) {
    const quotaListDiv = document.getElementById('modal_quota_list');
    const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
    const summaryDiv = document.querySelector('.quota-summary-modal');

    fetch(`{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/import/pending-fees/${fractionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fees) {
                let html = '';

                data.fees.forEach(fee => {
                    html += `
                        <div class="form-check mb-2">
                            <input class="form-check-input quota-fee-checkbox-modal"
                                   type="checkbox"
                                   value="${fee.id}"
                                   data-pending="${fee.pending_amount}">
                            <label class="form-check-label">
                                ${escapeHtml(fee.label)} - Pendente: €${fee.pending_amount.toFixed(2)}
                            </label>
                        </div>
                    `;
                });
                checkboxesDiv.innerHTML = html;
                quotaListDiv.style.display = 'block';

                // Add event listeners to checkboxes
                document.querySelectorAll('.quota-fee-checkbox-modal').forEach(cb => {
                    cb.addEventListener('change', function() {
                        updateQuotaSummaryModal(transactionAmount);
                    });
                });

                // Add event listener to use balance checkbox
                const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
                if (useBalanceCheckbox) {
                    useBalanceCheckbox.addEventListener('change', function() {
                        updateQuotaSummaryModal(transactionAmount);
                    });
                }

                updateQuotaSummaryModal(transactionAmount);
            } else {
                checkboxesDiv.innerHTML = '<p class="text-muted">Nenhuma quota pendente encontrada.</p>';
                quotaListDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading quotas:', error);
            checkboxesDiv.innerHTML = '<p class="text-danger">Erro ao carregar quotas.</p>';
            quotaListDiv.style.display = 'block';
        });
}

function updateQuotaSummaryModal(transactionAmount) {
    const selectedFees = [];
    let selectedTotal = 0;

    document.querySelectorAll('.quota-fee-checkbox-modal:checked').forEach(cb => {
        const feeId = parseInt(cb.value);
        const pendingAmount = parseFloat(cb.dataset.pending);
        selectedFees.push({ id: feeId, pending: pendingAmount });
        selectedTotal += pendingAmount;
    });

    // Check if using fraction balance
    const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
    const useBalance = useBalanceCheckbox && useBalanceCheckbox.checked;
    let balanceAmount = 0;
    if (useBalance) {
        const balanceText = document.getElementById('modal_fraction_balance_amount');
        if (balanceText) {
            balanceAmount = parseFloat(balanceText.textContent) || 0;
        }
    }

    const totalAvailable = transactionAmount + balanceAmount;
    const remaining = Math.max(0, totalAvailable - selectedTotal);
    const summaryDiv = document.querySelector('.quota-summary-modal');
    const remainingDestSection = document.getElementById('modal_remaining_destination_section');
    const destTextSpan = document.querySelector('.quota-remaining-dest-text');

    if (selectedFees.length > 0 || remaining > 0) {
        document.querySelector('.quota-selected-total-modal').textContent = selectedTotal.toFixed(2);
        document.querySelector('.quota-remaining-modal').textContent = remaining.toFixed(2);
        summaryDiv.style.display = 'block';
        // Show remaining destination when there are selected quotas and remaining > 0
        if (remainingDestSection) {
            remainingDestSection.style.display = (selectedFees.length > 0 && remaining > 0) ? 'block' : 'none';
        }
        updateRemainingDestText();
    } else {
        summaryDiv.style.display = 'none';
        if (remainingDestSection) remainingDestSection.style.display = 'none';
    }
}

function updateRemainingDestText() {
    const destRadio = document.querySelector('input[name="modal_remaining_destination"]:checked');
    const destTextSpan = document.querySelector('.quota-remaining-dest-text');
    if (!destTextSpan) return;
    const dest = destRadio ? destRadio.value : 'oldest';
    const texts = { oldest: 'será aplicado às mais antigas', unregistered: 'para quotas antigas não registadas', balance: 'fica em saldo' };
    destTextSpan.textContent = texts[dest] || texts.oldest;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Save quota liquidation configuration
document.getElementById('saveQuotaLiquidation').addEventListener('click', function() {
    if (!currentTransactionId) return;

    const saveBtn = document.getElementById('saveQuotaLiquidation');
    const isLiquidation = document.getElementById('modal_quota_liquidation_checkbox').checked;

    if (!isLiquidation) {
        alert('Por favor, marque a opção para liquidar quotas.');
        return;
    }

    const fractionId = document.getElementById('modal_quota_fraction').value;
    if (!fractionId) {
        alert('Por favor, selecione uma fração.');
        return;
    }

    // Disable button and show spinner to prevent double-click
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>A guardar...';

    // Get selected fee IDs
    const selectedFees = [];
    document.querySelectorAll('.quota-fee-checkbox-modal:checked').forEach(cb => {
        selectedFees.push(cb.value);
    });

    // Submit form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/${currentTransactionId}/liquidate-quotas`;

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);

    const fractionInput = document.createElement('input');
    fractionInput.type = 'hidden';
    fractionInput.name = 'fraction_id';
    fractionInput.value = fractionId;
    form.appendChild(fractionInput);

    selectedFees.forEach(feeId => {
        const feeInput = document.createElement('input');
        feeInput.type = 'hidden';
        feeInput.name = 'selected_fee_ids[]';
        feeInput.value = feeId;
        form.appendChild(feeInput);
    });

    // Add use_balance flag if checked
    const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
    if (useBalanceCheckbox && useBalanceCheckbox.checked) {
        const useBalanceInput = document.createElement('input');
        useBalanceInput.type = 'hidden';
        useBalanceInput.name = 'use_fraction_balance';
        useBalanceInput.value = '1';
        form.appendChild(useBalanceInput);
    }

    // Add remaining_destination (oldest, unregistered, balance)
    const remainingDestRadio = document.querySelector('input[name="modal_remaining_destination"]:checked');
    const remainingDestInput = document.createElement('input');
    remainingDestInput.type = 'hidden';
    remainingDestInput.name = 'remaining_destination';
    remainingDestInput.value = remainingDestRadio ? remainingDestRadio.value : 'oldest';
    form.appendChild(remainingDestInput);

    document.body.appendChild(form);
    form.submit();
});

// Apply table styles
function initFinancialTransactionsTableStyles() {
    const styleId = 'financial-transactions-table-styles';
    let styleSheet = document.getElementById(styleId);

    if (styleSheet) {
        styleSheet.remove();
    }

    styleSheet = document.createElement('style');
    styleSheet.id = styleId;

    const css = `
        /* Zebra striping simples - linhas pares cinzento claro, ímpares branco */
        body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(even) td {
            background-color: #e9ecef !important;
        }

        body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(odd) td {
            background-color: #ffffff !important;
        }

        /* Hover effect - amarelo pastel claro para todas as linhas */
        body #financial-transactions-table-container #financial-transactions-table tbody tr:hover td {
            background-color: #fff9e6 !important;
        }

        /* Cursor pointer */
        body #financial-transactions-table-container #financial-transactions-table tbody tr {
            cursor: pointer !important;
        }
    `;

    styleSheet.textContent = css;
    document.head.appendChild(styleSheet);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFinancialTransactionsTableStyles);
} else {
    initFinancialTransactionsTableStyles();
}
</script>
