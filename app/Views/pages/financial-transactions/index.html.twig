<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h2 class="mb-2 mb-md-0">Movimentos Financeiros</h2>
        <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/finances" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            {% if is_admin %}
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Novo Movimento
            </a>
            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/import" class="btn btn-success">
                <i class="bi bi-upload"></i> Importar
            </a>
            {% endif %}
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> Filtros
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" class="row g-3">
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="bank_account_id" class="form-label">Conta</label>
                    <select class="form-select" id="bank_account_id" name="bank_account_id">
                        <option value="">Todas</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {% if filters.bank_account_id == account.id %}selected{% endif %}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="transaction_type" class="form-label">Tipo</label>
                    <select class="form-select" id="transaction_type" name="transaction_type">
                        <option value="">Todos</option>
                        <option value="income" {% if filters.transaction_type == 'income' %}selected{% endif %}>Entrada</option>
                        <option value="expense" {% if filters.transaction_type == 'expense' %}selected{% endif %}>Saída</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="from_date" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="from_date" name="from_date" value="{{ filters.from_date }}">
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <label for="to_date" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="to_date" name="to_date" value="{{ filters.to_date }}">
                </div>
                <div class="col-12">
                    <div class="d-flex flex-column flex-sm-row gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> Movimentos
            </h5>
        </div>
        <div class="card-body">
            {% if transactions %}
            <!-- Desktop Table View -->
            <div class="table-responsive d-none d-lg-block" id="financial-transactions-table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table class="table table-excel" id="financial-transactions-table" style="min-width: 100%; width: max-content;">
                    <thead>
                        <tr>
                            <th style="width: 50px; text-align: center;" title="Tipo">Tipo</th>
                            <th style="width: 100px;">Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Referência</th>
                            <th class="text-end" style="width: 120px;">Valor</th>
                            <th class="text-end" style="width: 120px;">Saldo</th>
                            {% if is_admin %}
                            <th style="width: 80px; text-align: center;" title="Liquidação de Quotas">
                                <i class="bi bi-cash-coin"></i>
                            </th>
                            {% endif %}
                            <th style="width: 100px; text-align: center;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td style="text-align: center;">
                                {% if transaction.transaction_type == 'income' %}
                                <i class="bi bi-arrow-up-circle-fill text-success" style="font-size: 0.9rem;" title="Entrada"></i>
                                {% else %}
                                <i class="bi bi-arrow-down-circle-fill text-danger" style="font-size: 0.9rem;" title="Saída"></i>
                                {% endif %}
                            </td>
                            <td>{{ transaction.transaction_date|date('d/m/Y') }}</td>
                            <td>
                                {{ transaction.description|slice(0, 50) }}{% if transaction.description|length > 50 %}...{% endif %}
                                {% if transaction.related_type == 'transfer' and transaction.transfer_to_account_name %}
                                    <br><small class="text-muted">
                                        {% if transaction.transaction_type == 'expense' %}
                                        → Para: {{ transaction.transfer_to_account_name }}
                                        {% else %}
                                        ← De: {{ transaction.account_name }}
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </td>
                            <td>{{ transaction.category ?: '-' }}</td>
                            <td>{{ transaction.reference ?: '-' }}</td>
                            <td class="text-end">
                                <strong class="{% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                    {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}€{{ transaction.amount|number_format(2, ',', '.') }}
                                </strong>
                            </td>
                            <td class="text-end">
                                <strong class="{% if runningBalance[transaction.id] >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    €{{ runningBalance[transaction.id]|number_format(2, ',', '.') }}
                                </strong>
                            </td>
                            {% if is_admin %}
                            <td style="text-align: left; font-size: 0.75rem; max-width: 200px;">
                                {% set hasLiquidatedFees = liquidatedFeesByTransaction[transaction.id] is defined and liquidatedFeesByTransaction[transaction.id]|length > 0 %}
                                {% if hasLiquidatedFees %}
                                    {# Show liquidated fees #}
                                    <div class="liquidated-quotas-list">
                                        {% for fee in liquidatedFeesByTransaction[transaction.id] %}
                                        <div class="mb-1" style="line-height: 1.3;">
                                            <i class="bi bi-check-circle-fill text-success" style="font-size: 0.7rem;"></i>
                                            <span title="{{ fee.label }} - €{{ fee.amount|number_format(2, ',', '.') }}" style="margin-left: 0.25rem;">
                                                {{ fee.label }}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% elseif transaction.transaction_type == 'income' and transaction.related_type != 'fee_payment' and transaction.related_type != 'fraction_account' %}
                                <div style="text-align: center;">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary quota-liquidation-btn" 
                                            data-transaction-id="{{ transaction.id }}"
                                            data-amount="{{ transaction.amount }}">
                                        <i class="bi bi-cash-coin"></i> Liquidar
                                    </button>
                                </div>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td style="text-align: center;">
                                {% if is_admin %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-1 view-transaction-details" title="Ver detalhes" data-transaction-id="{{ transaction.id }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% if transaction.related_type == 'fee_payment' %}
                                    {% elseif transaction.related_type == 'transfer' %}
                                    <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/delete" class="d-inline" onsubmit="return confirm('Tem certeza que deseja eliminar esta transferência? Ambas as transações serão eliminadas.');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar Transferência">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <div class="d-inline-flex gap-1">
                                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/edit" class="btn btn-outline-primary btn-sm" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/delete" class="d-inline" onsubmit="return confirm('Tem certeza que deseja eliminar este movimento?');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary view-transaction-details" title="Ver detalhes" data-transaction-id="{{ transaction.id }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile/Tablet Card View -->
            <div class="d-lg-none">
                <div class="row g-3">
                    {% for transaction in transactions %}
                    <div class="col-12">
                        <div class="card shadow-sm {% if transaction.transaction_type == 'income' %}border-success border-2{% else %}border-danger border-2{% endif %}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <strong class="text-muted">{{ transaction.transaction_date|date('d/m/Y') }}</strong>
                                            {% if transaction.related_type == 'transfer' %}
                                                {% if transaction.transaction_type == 'income' %}
                                                <span class="badge bg-info">Transferência Recebida</span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">Transferência Enviada</span>
                                                {% endif %}
                                            {% elseif transaction.transaction_type == 'income' %}
                                            <span class="badge bg-success">Entrada</span>
                                            {% else %}
                                            <span class="badge bg-danger">Saída</span>
                                            {% endif %}
                                        </div>
                                        <h6 class="mb-1 fw-bold">{{ transaction.account_name }}</h6>
                                        {% if transaction.account_type == 'cash' %}
                                        <span class="badge bg-info">Caixa</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <strong class="h5 mb-0 {% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                            {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}€{{ transaction.amount|number_format(2, ',', '.') }}
                                        </strong>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <strong>Descrição:</strong>
                                    <p class="mb-1">{{ transaction.description }}</p>
                                    {% if transaction.related_type == 'transfer' and transaction.transfer_to_account_name %}
                                    <small class="text-muted d-block">
                                        {% if transaction.transaction_type == 'expense' %}
                                        <i class="bi bi-arrow-right"></i> Para: {{ transaction.transfer_to_account_name }}
                                        {% else %}
                                        <i class="bi bi-arrow-left"></i> De: {{ transaction.account_name }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                </div>

                                <div class="row g-2 mb-3">
                                    {% if transaction.category %}
                                    <div class="col-6">
                                        <small class="text-muted d-block"><strong>Categoria:</strong></small>
                                        <span>{{ transaction.category }}</span>
                                    </div>
                                    {% endif %}
                                    {% if transaction.reference %}
                                    <div class="col-6">
                                        <small class="text-muted d-block"><strong>Referência:</strong></small>
                                        <span>{{ transaction.reference }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="col-12">
                                        <small class="text-muted d-block"><strong>Saldo Acumulado:</strong></small>
                                        <strong class="{% if runningBalance[transaction.id] >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            €{{ runningBalance[transaction.id]|number_format(2, ',', '.') }}
                                        </strong>
                                    </div>
                                </div>

                                {% if is_admin %}
                                <div class="d-flex gap-2 pt-3 border-top flex-wrap align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary view-transaction-details" data-transaction-id="{{ transaction.id }}">
                                        <i class="bi bi-eye"></i> Ver detalhes
                                    </button>
                                    {% if transaction.related_type == 'fee_payment' %}
                                    <span class="text-muted small align-self-center">Associado a pagamento de quota</span>
                                    {% elseif transaction.related_type == 'transfer' %}
                                    <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/delete" class="flex-fill" onsubmit="return confirm('Tem certeza que deseja eliminar esta transferência? Ambas as transações serão eliminadas.');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                            <i class="bi bi-trash"></i> Eliminar Transferência
                                        </button>
                                    </form>
                                    {% else %}
                                    <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/edit" class="btn btn-sm btn-outline-primary flex-fill">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                    <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions/{{ transaction.id }}/delete" class="flex-fill" onsubmit="return confirm('Tem certeza que deseja eliminar este movimento?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div class="pt-3 border-top">
                                    <button type="button" class="btn btn-sm btn-outline-secondary view-transaction-details" data-transaction-id="{{ transaction.id }}">
                                        <i class="bi bi-eye"></i> Ver detalhes
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Nenhum movimento financeiro encontrado.
            </div>
            {% endif %}
            
            {% if pagination and pagination.total_pages > 1 %}
            <nav aria-label="Paginação" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if pagination.current_page > 1 %}
                        {% set prevPage = pagination.current_page - 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ prevPage }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </span>
                        </li>
                    {% endif %}
                    
                    {% set startPage = max(1, pagination.current_page - 2) %}
                    {% set endPage = min(pagination.total_pages, pagination.current_page + 2) %}
                    
                    {% if startPage > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">1</a>
                        </li>
                        {% if startPage > 2 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endif %}
                    
                    {% for i in startPage..endPage %}
                        <li class="page-item {% if i == pagination.current_page %}active{% endif %}">
                            <a class="page-link" href="?page={{ i }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">{{ i }}</a>
                        </li>
                    {% endfor %}
                    
                    {% if endPage < pagination.total_pages %}
                        {% if endPage < pagination.total_pages - 1 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pagination.total_pages }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}">{{ pagination.total_pages }}</a>
                        </li>
                    {% endif %}
                    
                    {% if pagination.current_page < pagination.total_pages %}
                        {% set nextPage = pagination.current_page + 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ nextPage }}{% if pagination.base_query %}&{{ pagination.base_query }}{% endif %}" aria-label="Próximo">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-label="Próximo">
                                <span aria-hidden="true">&raquo;</span>
                            </span>
                        </li>
                    {% endif %}
                </ul>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        Mostrando {{ ((pagination.current_page - 1) * pagination.per_page) + 1 }}-{{ min(pagination.current_page * pagination.per_page, pagination.total_items) }} de {{ pagination.total_items }} movimentos
                    </small>
                </div>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Zebra striping simples - linhas pares cinzento claro, ímpares branco */
body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(even) td {
    background-color: #e9ecef !important;
}

body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(odd) td {
    background-color: #ffffff !important;
}

/* Hover effect - amarelo pastel claro para todas as linhas */
body #financial-transactions-table-container #financial-transactions-table tbody tr:hover td {
    background-color: #fff9e6 !important;
}

/* Cursor pointer */
body #financial-transactions-table-container #financial-transactions-table tbody tr {
    cursor: pointer !important;
}

/* Scroll horizontal sempre visível em todos os dispositivos */
#financial-transactions-table-container {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    width: 100%;
}

#financial-transactions-table {
    width: max-content;
    min-width: 100%;
}

#financial-transactions-table th,
#financial-transactions-table td {
    white-space: nowrap;
}

/* Permitir quebra de linha apenas em descrição */
#financial-transactions-table td:nth-child(3) {
    white-space: normal;
    min-width: 150px;
    max-width: 200px;
}

/* Resizable columns */
#financial-transactions-table th {
    position: relative;
    user-select: none;
}

#financial-transactions-table th .resize-handle {
    position: absolute;
    top: 0;
    right: -2px;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    background: transparent;
    z-index: 10;
    transition: background 0.2s;
}

#financial-transactions-table th .resize-handle:hover {
    background: #007bff;
    opacity: 0.7;
}

#financial-transactions-table th .resize-handle.resizing {
    background: #0056b3;
    opacity: 1;
}
</style>

<script>
// Column resizing functionality
(function() {
    const table = document.getElementById('financial-transactions-table');
    if (!table) return;
    
    const storageKey = 'financial-transactions-table-column-widths';
    
    // Load saved widths
    function loadColumnWidths() {
        try {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                const widths = JSON.parse(saved);
                const headers = table.querySelectorAll('thead th');
                headers.forEach((th, index) => {
                    if (widths[index]) {
                        th.style.width = widths[index] + 'px';
                        th.style.minWidth = widths[index] + 'px';
                    }
                });
            }
        } catch (e) {
            console.error('Error loading column widths:', e);
        }
    }
    
    // Save column widths
    function saveColumnWidths() {
        try {
            const headers = table.querySelectorAll('thead th');
            const widths = Array.from(headers).map(th => {
                const width = th.style.width || th.getAttribute('data-original-width') || 'auto';
                return width === 'auto' ? null : parseInt(width);
            });
            localStorage.setItem(storageKey, JSON.stringify(widths));
        } catch (e) {
            console.error('Error saving column widths:', e);
        }
    }
    
    // Initialize resize handles
    function initResizeHandles() {
        const headers = table.querySelectorAll('thead th');
        
        headers.forEach((th, index) => {
            // Skip last column (actions) - don't make it resizable
            if (index === headers.length - 1) return;
            
            // Store original width
            const originalWidth = th.style.width || window.getComputedStyle(th).width;
            th.setAttribute('data-original-width', originalWidth);
            
            // Create resize handle
            const handle = document.createElement('div');
            handle.className = 'resize-handle';
            handle.setAttribute('data-column-index', index);
            th.appendChild(handle);
            
            // Make header position relative if not already
            if (window.getComputedStyle(th).position === 'static') {
                th.style.position = 'relative';
            }
            
            // Resize functionality
            let startX, startWidth, columnIndex;
            
            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                startX = e.pageX;
                startWidth = parseInt(window.getComputedStyle(th).width);
                columnIndex = index;
                
                handle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                function onMouseMove(e) {
                    const diff = e.pageX - startX;
                    const newWidth = Math.max(50, startWidth + diff); // Minimum 50px
                    
                    th.style.width = newWidth + 'px';
                    th.style.minWidth = newWidth + 'px';
                    th.style.maxWidth = newWidth + 'px';
                    
                    // Update corresponding cells
                    const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
                    cells.forEach(cell => {
                        cell.style.width = newWidth + 'px';
                        cell.style.minWidth = newWidth + 'px';
                        cell.style.maxWidth = newWidth + 'px';
                    });
                }
                
                function onMouseUp() {
                    handle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    saveColumnWidths();
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            loadColumnWidths();
            initResizeHandles();
        });
    } else {
        loadColumnWidths();
        initResizeHandles();
    }
})();
</script>

<!-- Modal para Liquidação de Quotas -->
<div class="modal fade" id="quotaLiquidationModal" tabindex="-1" aria-labelledby="quotaLiquidationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quotaLiquidationModalLabel">Liquidação de Quotas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="modal_quota_liquidation_checkbox">
                        <label class="form-check-label" for="modal_quota_liquidation_checkbox">
                            <strong>Liquidar quotas para este movimento</strong>
                        </label>
                    </div>
                </div>
                
                <div id="modal_quota_config" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Liquidação automática:</strong> O valor será aplicado às quotas mais antigas primeiro, sequencialmente. 
                        Se selecionar quotas específicas abaixo, essas serão liquidadas primeiro e o valor restante será aplicado às mais antigas.
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_quota_fraction" class="form-label">Fração <span class="text-danger">*</span></label>
                        <select class="form-select" id="modal_quota_fraction">
                            <option value="">Selecione fração...</option>
                            {% for fraction in fractions|default([]) %}
                            <option value="{{ fraction.id }}">{{ fraction.identifier }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="modal_fraction_balance_info" style="display: none;" class="mb-3">
                        <div class="alert alert-success">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="modal_use_fraction_balance">
                                <label class="form-check-label" for="modal_use_fraction_balance">
                                    <strong>Usar saldo da fração</strong>
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">
                                Saldo disponível: <strong id="modal_fraction_balance_amount">0.00</strong> €
                            </small>
                        </div>
                    </div>
                
                    <div id="modal_quota_list" style="display: none;">
                        <label class="form-label"><strong>Selecione quotas específicas (opcional):</strong></label>
                        <div class="quota-checkboxes-modal" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.75rem; margin-top: 0.5rem;"></div>
                        <div class="quota-summary-modal mt-2" style="display: none;">
                            <small class="text-muted">
                                <span class="quota-selected-total-modal">0.00</span> € selecionado | 
                                Restante: <span class="quota-remaining-modal">0.00</span> € <span class="quota-remaining-dest-text">será aplicado às mais antigas</span>
                            </small>
                        </div>
                        <div id="modal_remaining_destination_section" class="mt-2" style="display: none;">
                            <label class="form-label"><strong>Destino do valor restante:</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal_remaining_destination" id="modal_remaining_oldest" value="oldest" checked>
                                <label class="form-check-label" for="modal_remaining_oldest">Aplicar às quotas mais antigas (registadas no sistema)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal_remaining_destination" id="modal_remaining_unregistered" value="unregistered">
                                <label class="form-check-label" for="modal_remaining_unregistered">Referente a quotas antigas não registadas no sistema</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal_remaining_destination" id="modal_remaining_balance" value="balance">
                                <label class="form-check-label" for="modal_remaining_balance">Fica em saldo na fração</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveQuotaLiquidation">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Detalhes do Movimento -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Detalhes do Movimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">A carregar...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
const condominiumId = {{ condominium.id }};
let quotaModal = null;
let currentTransactionId = null;
let currentTransactionAmount = 0;

// Initialize modal
function initQuotaModal() {
    const modalElement = document.getElementById('quotaLiquidationModal');
    if (modalElement) {
        // Listeners for remaining destination radios (only once)
        if (!modalElement.dataset.remainingDestListeners) {
            modalElement.dataset.remainingDestListeners = '1';
            document.querySelectorAll('input[name="modal_remaining_destination"]').forEach(r => {
                r.addEventListener('change', updateRemainingDestText);
            });
        }
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            quotaModal = new bootstrap.Modal(modalElement);
            
            // Clear modal when hidden
            modalElement.addEventListener('hidden.bs.modal', function() {
                const checkbox = document.getElementById('modal_quota_liquidation_checkbox');
                const config = document.getElementById('modal_quota_config');
                const fraction = document.getElementById('modal_quota_fraction');
                const list = document.getElementById('modal_quota_list');
                const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
                const summaryDiv = document.querySelector('.quota-summary-modal');
                const balanceInfo = document.getElementById('modal_fraction_balance_info');
                const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
                const remainingDestSection = document.getElementById('modal_remaining_destination_section');
                const oldestRadio = document.getElementById('modal_remaining_oldest');
                
                if (checkbox) checkbox.checked = false;
                if (config) config.style.display = 'none';
                if (fraction) fraction.value = '';
                if (list) list.style.display = 'none';
                if (checkboxesDiv) checkboxesDiv.innerHTML = '';
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (balanceInfo) balanceInfo.style.display = 'none';
                if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
                if (remainingDestSection) remainingDestSection.style.display = 'none';
                if (oldestRadio) oldestRadio.checked = true;
                currentTransactionId = null;
                currentTransactionAmount = 0;
            });
        }
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQuotaModal);
} else {
    initQuotaModal();
}

// View transaction details
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.view-transaction-details');
    if (btn) {
        e.preventDefault();
        const tid = btn.dataset.transactionId;
        if (!tid) return;
        const modalEl = document.getElementById('transactionDetailsModal');
        const contentEl = document.getElementById('transactionDetailsContent');
        if (!modalEl || !contentEl) return;
        contentEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">A carregar...</p></div>';
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        fetch(`{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/${tid}/info`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    contentEl.innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                    return;
                }
                const t = data.transaction;
                const fees = data.liquidated_fees || [];
                let html = '<div class="row g-3">';
                html += '<div class="col-md-6"><strong>Data:</strong><br>' + (t.transaction_date ? new Date(t.transaction_date).toLocaleDateString('pt-PT') : '-') + '</div>';
                html += '<div class="col-md-6"><strong>Tipo:</strong><br>' + (t.transaction_type === 'income' ? '<span class="text-success">Entrada</span>' : '<span class="text-danger">Saída</span>') + '</div>';
                html += '<div class="col-md-6"><strong>Conta:</strong><br>' + (t.account_name || '-') + '</div>';
                html += '<div class="col-md-6"><strong>Valor:</strong><br><strong class="' + (t.transaction_type === 'income' ? 'text-success' : 'text-danger') + '">' + (t.transaction_type === 'income' ? '+' : '-') + '€' + parseFloat(t.amount).toFixed(2).replace('.', ',') + '</strong></div>';
                if (t.fraction_identifier) html += '<div class="col-md-6"><strong>Fração:</strong><br>' + t.fraction_identifier + '</div>';
                if (t.reference) html += '<div class="col-md-6"><strong>Referência:</strong><br><code>' + t.reference + '</code></div>';
                if (t.category) html += '<div class="col-md-6"><strong>Categoria:</strong><br>' + t.category + '</div>';
                if (t.transfer_to_account_name) html += '<div class="col-12"><strong>Transferência para:</strong><br>' + t.transfer_to_account_name + '</div>';
                html += '<div class="col-12"><strong>Descrição:</strong><br>' + (t.description || '-') + '</div>';
                if (fees.length > 0) {
                    html += '<div class="col-12"><strong>Quotas associadas/liquidadas:</strong><ul class="list-group list-group-flush mt-1">';
                    fees.forEach(f => {
                        html += '<li class="list-group-item d-flex justify-content-between align-items-center">' + f.label + '<span class="badge bg-success">€' + f.amount.toFixed(2).replace('.', ',') + '</span></li>';
                    });
                    html += '</ul></div>';
                }
                html += '</div>';
                contentEl.innerHTML = html;
            })
            .catch(err => {
                contentEl.innerHTML = '<div class="alert alert-danger">Erro ao carregar detalhes: ' + err.message + '</div>';
            });
    }
});

// Handle quota liquidation button click - open modal
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.quota-liquidation-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        
        currentTransactionId = btn.dataset.transactionId;
        currentTransactionAmount = parseFloat(btn.dataset.amount) || 0;
        
        // Reset modal
        const modalCheckbox = document.getElementById('modal_quota_liquidation_checkbox');
        const modalConfig = document.getElementById('modal_quota_config');
        const modalFraction = document.getElementById('modal_quota_fraction');
        const modalList = document.getElementById('modal_quota_list');
        const balanceInfo = document.getElementById('modal_fraction_balance_info');
        const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
        
        if (modalCheckbox) modalCheckbox.checked = false;
        if (modalFraction) modalFraction.value = '';
        if (modalConfig) modalConfig.style.display = 'none';
        if (modalList) modalList.style.display = 'none';
        if (balanceInfo) balanceInfo.style.display = 'none';
        if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
        
        const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
        const summaryDiv = document.querySelector('.quota-summary-modal');
        const remainingDestSection = document.getElementById('modal_remaining_destination_section');
        const oldestRadio = document.getElementById('modal_remaining_oldest');
        if (checkboxesDiv) checkboxesDiv.innerHTML = '';
        if (summaryDiv) summaryDiv.style.display = 'none';
        if (remainingDestSection) remainingDestSection.style.display = 'none';
        if (oldestRadio) oldestRadio.checked = true;
        
        // Show modal
        const modalElement = document.getElementById('quotaLiquidationModal');
        if (modalElement) {
            if (!quotaModal) {
                initQuotaModal();
            }
            if (quotaModal) {
                quotaModal.show();
            } else {
                const bsModal = new bootstrap.Modal(modalElement);
                bsModal.show();
            }
        }
    }
});

// Handle checkbox in modal - show/hide config section
document.getElementById('modal_quota_liquidation_checkbox').addEventListener('change', function() {
    const configSection = document.getElementById('modal_quota_config');
    if (this.checked) {
        configSection.style.display = 'block';
    } else {
        configSection.style.display = 'none';
        const fraction = document.getElementById('modal_quota_fraction');
        const list = document.getElementById('modal_quota_list');
        const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
        const summaryDiv = document.querySelector('.quota-summary-modal');
        if (fraction) fraction.value = '';
        if (list) list.style.display = 'none';
        if (checkboxesDiv) checkboxesDiv.innerHTML = '';
        if (summaryDiv) summaryDiv.style.display = 'none';
    }
});

// Handle fraction selection in modal - load pending fees and balance
document.getElementById('modal_quota_fraction').addEventListener('change', function() {
    const fractionId = this.value;
    
    if (fractionId) {
        loadFractionBalance(fractionId);
        loadQuotasForModal(fractionId, currentTransactionAmount);
    } else {
        const list = document.getElementById('modal_quota_list');
        const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
        const summaryDiv = document.querySelector('.quota-summary-modal');
        const balanceInfo = document.getElementById('modal_fraction_balance_info');
        const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
        if (list) list.style.display = 'none';
        if (checkboxesDiv) checkboxesDiv.innerHTML = '';
        if (summaryDiv) summaryDiv.style.display = 'none';
        if (balanceInfo) balanceInfo.style.display = 'none';
        if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
    }
});

function loadFractionBalance(fractionId) {
    const balanceInfo = document.getElementById('modal_fraction_balance_info');
    const balanceAmount = document.getElementById('modal_fraction_balance_amount');
    const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
    
    fetch(`{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/fraction-balance/${fractionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.has_balance) {
                if (balanceAmount) {
                    balanceAmount.textContent = parseFloat(data.balance).toFixed(2);
                }
                if (balanceInfo) {
                    balanceInfo.style.display = 'block';
                }
                // Add event listener to checkbox to update summary when toggled
                if (useBalanceCheckbox) {
                    useBalanceCheckbox.addEventListener('change', function() {
                        const fractionId = document.getElementById('modal_quota_fraction').value;
                        if (fractionId) {
                            loadQuotasForModal(fractionId, currentTransactionAmount);
                        }
                    });
                }
            } else {
                if (balanceInfo) balanceInfo.style.display = 'none';
                if (useBalanceCheckbox) useBalanceCheckbox.checked = false;
            }
        })
        .catch(error => {
            console.error('Error loading fraction balance:', error);
            if (balanceInfo) balanceInfo.style.display = 'none';
        });
}

function loadQuotasForModal(fractionId, transactionAmount) {
    const quotaListDiv = document.getElementById('modal_quota_list');
    const checkboxesDiv = document.querySelector('.quota-checkboxes-modal');
    const summaryDiv = document.querySelector('.quota-summary-modal');
    
    fetch(`{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/import/pending-fees/${fractionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fees) {
                let html = '';
                
                data.fees.forEach(fee => {
                    html += `
                        <div class="form-check mb-2">
                            <input class="form-check-input quota-fee-checkbox-modal" 
                                   type="checkbox" 
                                   value="${fee.id}"
                                   data-pending="${fee.pending_amount}">
                            <label class="form-check-label">
                                ${escapeHtml(fee.label)} - Pendente: €${fee.pending_amount.toFixed(2)}
                            </label>
                        </div>
                    `;
                });
                checkboxesDiv.innerHTML = html;
                quotaListDiv.style.display = 'block';
                
                // Add event listeners to checkboxes
                document.querySelectorAll('.quota-fee-checkbox-modal').forEach(cb => {
                    cb.addEventListener('change', function() {
                        updateQuotaSummaryModal(transactionAmount);
                    });
                });
                
                // Add event listener to use balance checkbox
                const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
                if (useBalanceCheckbox) {
                    useBalanceCheckbox.addEventListener('change', function() {
                        updateQuotaSummaryModal(transactionAmount);
                    });
                }
                
                updateQuotaSummaryModal(transactionAmount);
            } else {
                checkboxesDiv.innerHTML = '<p class="text-muted">Nenhuma quota pendente encontrada.</p>';
                quotaListDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading quotas:', error);
            checkboxesDiv.innerHTML = '<p class="text-danger">Erro ao carregar quotas.</p>';
            quotaListDiv.style.display = 'block';
        });
}

function updateQuotaSummaryModal(transactionAmount) {
    const selectedFees = [];
    let selectedTotal = 0;
    
    document.querySelectorAll('.quota-fee-checkbox-modal:checked').forEach(cb => {
        const feeId = parseInt(cb.value);
        const pendingAmount = parseFloat(cb.dataset.pending);
        selectedFees.push({ id: feeId, pending: pendingAmount });
        selectedTotal += pendingAmount;
    });
    
    // Check if using fraction balance
    const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
    const useBalance = useBalanceCheckbox && useBalanceCheckbox.checked;
    let balanceAmount = 0;
    if (useBalance) {
        const balanceText = document.getElementById('modal_fraction_balance_amount');
        if (balanceText) {
            balanceAmount = parseFloat(balanceText.textContent) || 0;
        }
    }
    
    const totalAvailable = transactionAmount + balanceAmount;
    const remaining = Math.max(0, totalAvailable - selectedTotal);
    const summaryDiv = document.querySelector('.quota-summary-modal');
    const remainingDestSection = document.getElementById('modal_remaining_destination_section');
    const destTextSpan = document.querySelector('.quota-remaining-dest-text');
    
    if (selectedFees.length > 0 || remaining > 0) {
        document.querySelector('.quota-selected-total-modal').textContent = selectedTotal.toFixed(2);
        document.querySelector('.quota-remaining-modal').textContent = remaining.toFixed(2);
        summaryDiv.style.display = 'block';
        // Show remaining destination when there are selected quotas and remaining > 0
        if (remainingDestSection) {
            remainingDestSection.style.display = (selectedFees.length > 0 && remaining > 0) ? 'block' : 'none';
        }
        updateRemainingDestText();
    } else {
        summaryDiv.style.display = 'none';
        if (remainingDestSection) remainingDestSection.style.display = 'none';
    }
}

function updateRemainingDestText() {
    const destRadio = document.querySelector('input[name="modal_remaining_destination"]:checked');
    const destTextSpan = document.querySelector('.quota-remaining-dest-text');
    if (!destTextSpan) return;
    const dest = destRadio ? destRadio.value : 'oldest';
    const texts = { oldest: 'será aplicado às mais antigas', unregistered: 'para quotas antigas não registadas', balance: 'fica em saldo' };
    destTextSpan.textContent = texts[dest] || texts.oldest;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Save quota liquidation configuration
document.getElementById('saveQuotaLiquidation').addEventListener('click', function() {
    if (!currentTransactionId) return;
    
    const saveBtn = document.getElementById('saveQuotaLiquidation');
    const isLiquidation = document.getElementById('modal_quota_liquidation_checkbox').checked;
    
    if (!isLiquidation) {
        alert('Por favor, marque a opção para liquidar quotas.');
        return;
    }
    
    const fractionId = document.getElementById('modal_quota_fraction').value;
    if (!fractionId) {
        alert('Por favor, selecione uma fração.');
        return;
    }
    
    // Disable button and show spinner to prevent double-click
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>A guardar...';
    
    // Get selected fee IDs
    const selectedFees = [];
    document.querySelectorAll('.quota-fee-checkbox-modal:checked').forEach(cb => {
        selectedFees.push(cb.value);
    });
    
    // Submit form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ BASE_URL }}condominiums/${condominiumId}/financial-transactions/${currentTransactionId}/liquidate-quotas`;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);
    
    const fractionInput = document.createElement('input');
    fractionInput.type = 'hidden';
    fractionInput.name = 'fraction_id';
    fractionInput.value = fractionId;
    form.appendChild(fractionInput);
    
    selectedFees.forEach(feeId => {
        const feeInput = document.createElement('input');
        feeInput.type = 'hidden';
        feeInput.name = 'selected_fee_ids[]';
        feeInput.value = feeId;
        form.appendChild(feeInput);
    });
    
    // Add use_balance flag if checked
    const useBalanceCheckbox = document.getElementById('modal_use_fraction_balance');
    if (useBalanceCheckbox && useBalanceCheckbox.checked) {
        const useBalanceInput = document.createElement('input');
        useBalanceInput.type = 'hidden';
        useBalanceInput.name = 'use_fraction_balance';
        useBalanceInput.value = '1';
        form.appendChild(useBalanceInput);
    }
    
    // Add remaining_destination (oldest, unregistered, balance)
    const remainingDestRadio = document.querySelector('input[name="modal_remaining_destination"]:checked');
    const remainingDestInput = document.createElement('input');
    remainingDestInput.type = 'hidden';
    remainingDestInput.name = 'remaining_destination';
    remainingDestInput.value = remainingDestRadio ? remainingDestRadio.value : 'oldest';
    form.appendChild(remainingDestInput);
    
    document.body.appendChild(form);
    form.submit();
});

// Apply table styles
function initFinancialTransactionsTableStyles() {
    const styleId = 'financial-transactions-table-styles';
    let styleSheet = document.getElementById(styleId);
    
    if (styleSheet) {
        styleSheet.remove();
    }
    
    styleSheet = document.createElement('style');
    styleSheet.id = styleId;
    
    const css = `
        /* Zebra striping simples - linhas pares cinzento claro, ímpares branco */
        body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(even) td {
            background-color: #e9ecef !important;
        }
        
        body #financial-transactions-table-container #financial-transactions-table tbody tr:nth-child(odd) td {
            background-color: #ffffff !important;
        }
        
        /* Hover effect - amarelo pastel claro para todas as linhas */
        body #financial-transactions-table-container #financial-transactions-table tbody tr:hover td {
            background-color: #fff9e6 !important;
        }
        
        /* Cursor pointer */
        body #financial-transactions-table-container #financial-transactions-table tbody tr {
            cursor: pointer !important;
        }
    `;
    
    styleSheet.textContent = css;
    document.head.appendChild(styleSheet);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFinancialTransactionsTableStyles);
} else {
    initFinancialTransactionsTableStyles();
}
</script>
