<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Criar Movimento Financeiro</h2>
        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Informações do Movimento</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        
                        <div class="mb-3">
                            <label for="bank_account_id" class="form-label">Conta Bancária <span class="text-danger">*</span></label>
                            <select class="form-select" id="bank_account_id" name="bank_account_id" required>
                                <option value="">Selecione uma conta...</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}" data-balance="{{ account.current_balance }}" {% if preselected_account_id == account.id %}selected{% endif %}>
                                    {{ account.name }} 
                                    {% if account.account_type == 'cash' %}(Caixa){% endif %}
                                    - Saldo: €{{ account.current_balance|number_format(2, ',', '.') }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="transaction_type" class="form-label">Tipo <span class="text-danger">*</span></label>
                            <select class="form-select" id="transaction_type" name="transaction_type" required>
                                <option value="">Selecione...</option>
                                <option value="income" {% if preselected_transaction_type|default('') == 'income' %}selected{% endif %}>Entrada (Receita)</option>
                                <option value="expense" {% if preselected_transaction_type|default('') == 'expense' %}selected{% endif %}>Saída (Despesa)</option>
                                <option value="transfer">Transferência entre Contas</option>
                            </select>
                        </div>

                        <div class="mb-3" id="transfer_account_group" style="display: none;">
                            <label for="transfer_account_id" class="form-label">Conta de Destino <span class="text-danger">*</span></label>
                            <select class="form-select" id="transfer_account_id" name="transfer_account_id">
                                <option value="">Selecione a conta de destino...</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}" data-balance="{{ account.current_balance }}">
                                    {{ account.name }} 
                                    {% if account.account_type == 'cash' %}(Caixa){% endif %}
                                    - Saldo: €{{ account.current_balance|number_format(2, ',', '.') }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">O valor será transferido da conta selecionada acima para esta conta.</small>
                        </div>

                        <div class="mb-3">
                            <label for="amount" class="form-label">Valor (€) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                            <small class="form-text text-muted" id="balance-warning" style="display: none; color: red;">
                                Atenção: Saldo insuficiente!
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="transaction_date" class="form-label">Data <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="transaction_date" name="transaction_date" value="{{ "now"|date("Y-m-d") }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Descrição <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" name="description" rows="3" required placeholder="Descrição do movimento"></textarea>
                        </div>

                        <div class="mb-3" id="income_destination_group" style="display: none;">
                            <label for="income_entry_type" class="form-label">Tipo de entrada (atribuir a fração)</label>
                            <select class="form-select" id="income_entry_type" name="income_entry_type">
                                <option value="">Não atribuir a fração</option>
                                <option value="quota">Quotas</option>
                                <option value="reserva_espaco">Reservas de espaço</option>
                                <option value="outros">Outros</option>
                            </select>
                            <small class="form-text text-muted">Se escolher Quotas, Reservas de espaço ou Outros, deve selecionar a fração. Para Quotas, o valor será aplicado às quotas em atraso da fração.</small>
                        </div>
                        <div class="mb-3" id="fraction_id_group" style="display: none;">
                            <label for="fraction_id" class="form-label">Fração <span class="text-danger">*</span></label>
                            <select class="form-select" id="fraction_id" name="fraction_id">
                                <option value="">Selecione a fração...</option>
                                {% for fraction in fractions|default([]) %}
                                <option value="{{ fraction.id }}">{{ fraction.identifier }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3" id="category_group">
                            <label for="category_income_select" class="form-label">Categoria</label>
                            <div id="category_income_wrapper" style="display: none;">
                                <select class="form-select form-select-category-create" id="category_income_select" data-kind="income">
                                    <option value="">— Sem categoria —</option>
                                    {% for cat in revenue_categories|default([]) %}
                                    <option value="{{ cat.name|e('html_attr') }}">{{ cat.name }}</option>
                                    {% endfor %}
                                    <option value="__new__">+ Criar nova...</option>
                                </select>
                            </div>
                            <div id="category_expense_wrapper" style="display: none;">
                                <select class="form-select form-select-category-create" id="category_expense_select" data-kind="expense">
                                    <option value="">— Sem categoria —</option>
                                    {% for cat in expense_categories|default([]) %}
                                    <option value="{{ cat.name|e('html_attr') }}">{{ cat.name }}</option>
                                    {% endfor %}
                                    <option value="__new__">+ Criar nova...</option>
                                </select>
                            </div>
                            <input type="hidden" id="category" name="category" value="">
                        </div>

                        <div class="mb-3">
                            <label for="reference" class="form-label">Referência</label>
                            <input type="text" class="form-control" id="reference" name="reference" placeholder="Ex: Número de transferência, referência">
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Criar Movimento
                            </button>
                            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountSelect = document.getElementById('bank_account_id');
    const transactionType = document.getElementById('transaction_type');
    const transferAccountSelect = document.getElementById('transfer_account_id');
    const transferAccountGroup = document.getElementById('transfer_account_group');
    const amountInput = document.getElementById('amount');
    const balanceWarning = document.getElementById('balance-warning');
    const form = document.querySelector('form');

    function toggleTransferFields() {
        if (transactionType.value === 'transfer') {
            transferAccountGroup.style.display = 'block';
            transferAccountSelect.setAttribute('required', 'required');
        } else {
            transferAccountGroup.style.display = 'none';
            transferAccountSelect.removeAttribute('required');
            transferAccountSelect.value = '';
        }
    }

    function checkBalance() {
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const transactionTypeValue = transactionType.value;
        const amount = parseFloat(amountInput.value || 0);
        
        if (selectedOption.value && (transactionTypeValue === 'expense' || transactionTypeValue === 'transfer')) {
            const balance = parseFloat(selectedOption.dataset.balance || 0);
            
            if (amount > balance) {
                balanceWarning.style.display = 'block';
                balanceWarning.textContent = `Atenção: Saldo insuficiente! Saldo atual: €${balance.toFixed(2).replace('.', ',')}`;
            } else {
                balanceWarning.style.display = 'none';
            }
        } else {
            balanceWarning.style.display = 'none';
        }
    }

    function validateTransferAccounts() {
        if (transactionType.value === 'transfer') {
            const fromAccount = accountSelect.value;
            const toAccount = transferAccountSelect.value;
            
            if (fromAccount === toAccount) {
                alert('A conta de origem e destino não podem ser a mesma!');
                return false;
            }
        }
        return true;
    }

    const incomeDestGroup = document.getElementById('income_destination_group');
    const incomeEntryType = document.getElementById('income_entry_type');
    const fractionIdGroup = document.getElementById('fraction_id_group');
    const fractionIdSelect = document.getElementById('fraction_id');

    const categoryGroup = document.getElementById('category_group');
    const categoryIncomeWrapper = document.getElementById('category_income_wrapper');
    const categoryIncomeSelect = document.getElementById('category_income_select');
    const categoryExpenseWrapper = document.getElementById('category_expense_wrapper');
    const categoryExpenseSelect = document.getElementById('category_expense_select');
    const categoryInput = document.getElementById('category');

    function syncCategoryFromSelect() {
        var sel = transactionType.value === 'income' ? categoryIncomeSelect : (transactionType.value === 'expense' ? categoryExpenseSelect : null);
        if (sel && categoryInput) categoryInput.value = (sel.value && sel.value !== '__new__') ? sel.value : '';
    }

    function toggleCategoryFields() {
        if (!categoryGroup) return;
        if (transactionType.value === 'transfer') {
            categoryGroup.style.display = 'none';
            if (categoryInput) categoryInput.value = '';
        } else {
            categoryGroup.style.display = 'block';
            if (transactionType.value === 'income') {
                if (categoryIncomeWrapper) categoryIncomeWrapper.style.display = 'block';
                if (categoryExpenseWrapper) categoryExpenseWrapper.style.display = 'none';
                if (categoryIncomeSelect) { categoryIncomeSelect.value = categoryInput ? categoryInput.value : ''; syncCategoryFromSelect(); }
            } else if (transactionType.value === 'expense') {
                if (categoryIncomeWrapper) categoryIncomeWrapper.style.display = 'none';
                if (categoryExpenseWrapper) categoryExpenseWrapper.style.display = 'block';
                if (categoryExpenseSelect) { categoryExpenseSelect.value = categoryInput ? categoryInput.value : ''; syncCategoryFromSelect(); }
            }
        }
    }

    function addCategoryOptionAndSet(selectEl, name) {
        var opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        var newOpt = selectEl.querySelector('option[value="__new__"]');
        if (newOpt) selectEl.insertBefore(opt, newOpt);
        else selectEl.appendChild(opt);
        selectEl.value = name;
        if (categoryInput) categoryInput.value = name;
    }

    function toggleIncomeFractionFields() {
        if (transactionType.value === 'income') {
            incomeDestGroup.style.display = 'block';
            if (incomeEntryType.value && ['quota', 'reserva_espaco', 'outros'].includes(incomeEntryType.value)) {
                fractionIdGroup.style.display = 'block';
                fractionIdSelect.setAttribute('required', 'required');
            } else {
                fractionIdGroup.style.display = 'none';
                fractionIdSelect.removeAttribute('required');
                fractionIdSelect.value = '';
            }
        } else {
            incomeDestGroup.style.display = 'none';
            fractionIdGroup.style.display = 'none';
            fractionIdSelect.removeAttribute('required');
            fractionIdSelect.value = '';
            incomeEntryType.value = '';
        }
    }

    if (incomeEntryType) incomeEntryType.addEventListener('change', toggleIncomeFractionFields);

    document.querySelectorAll('.form-select-category-create').forEach(function(sel) {
        sel.addEventListener('change', function() {
            var v = this.value;
            if (v === '__new__') {
                var selectEl = this;
                window.openNewCategoryModal(function(name) {
                    addCategoryOptionAndSet(selectEl, name);
                });
                this.value = categoryInput ? categoryInput.value : '';
            } else {
                syncCategoryFromSelect();
            }
        });
    });

    transactionType.addEventListener('change', function() {
        toggleTransferFields();
        toggleIncomeFractionFields();
        toggleCategoryFields();
        checkBalance();
    });

    accountSelect.addEventListener('change', function() {
        checkBalance();
        // Update transfer destination options to exclude selected account
        if (transactionType.value === 'transfer') {
            const selectedAccountId = accountSelect.value;
            Array.from(transferAccountSelect.options).forEach(option => {
                if (option.value === selectedAccountId && option.value !== '') {
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                }
            });
        }
    });

    transferAccountSelect.addEventListener('change', function() {
        // Ensure destination is different from source
        if (transferAccountSelect.value === accountSelect.value) {
            alert('A conta de destino deve ser diferente da conta de origem!');
            transferAccountSelect.value = '';
        }
    });

    amountInput.addEventListener('input', checkBalance);

    form.addEventListener('submit', function(e) {
        if (!validateTransferAccounts()) {
            e.preventDefault();
            return false;
        }

        const transactionTypeValue = transactionType.value;
        if (transactionTypeValue === 'income' && incomeEntryType && incomeEntryType.value && !fractionIdSelect.value) {
            e.preventDefault();
            alert('Selecione a fração para este tipo de entrada.');
            return false;
        }

        if (transactionTypeValue === 'expense' || transactionTypeValue === 'transfer') {
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            const balance = parseFloat(selectedOption.dataset.balance || 0);
            const amount = parseFloat(amountInput.value || 0);
            
            if (amount > balance) {
                e.preventDefault();
                alert('Saldo insuficiente para esta operação!');
                return false;
            }
        }

        if (transactionTypeValue === 'transfer' && !transferAccountSelect.value) {
            e.preventDefault();
            alert('Por favor, selecione a conta de destino!');
            return false;
        }

        // Sync category from visible select before submit
        if (transactionTypeValue === 'income' && categoryIncomeSelect) {
            categoryInput.value = (categoryIncomeSelect.value && categoryIncomeSelect.value !== '__new__') ? categoryIncomeSelect.value : '';
        } else if (transactionTypeValue === 'expense' && categoryExpenseSelect) {
            categoryInput.value = (categoryExpenseSelect.value && categoryExpenseSelect.value !== '__new__') ? categoryExpenseSelect.value : '';
        }
    });

    // Initialize
    toggleTransferFields();
    toggleIncomeFractionFields();
    toggleCategoryFields();
});
</script>
