{# Modal e Script para Detalhes da Quota #}
{# Variáveis necessárias:
   - condominium: objeto do condomínio (deve ter 'id')
   - BASE_URL: URL base (geralmente já disponível globalmente)
#}

<!-- Modal para detalhes da quota -->
<div class="modal fade" id="feeDetailsModal" tabindex="-1" aria-labelledby="feeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title fw-bold" id="feeDetailsModalLabel">
                    <i class="bi bi-receipt-cutoff text-primary me-2"></i>Detalhes da Quota
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="feeDetailsContent" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">A carregar...</span>
                    </div>
                    <p class="text-muted mt-3 mb-0">A carregar detalhes...</p>
                </div>
            </div>
            <div class="modal-footer border-top bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showFeeDetails(feeId) {
    const modal = new bootstrap.Modal(document.getElementById('feeDetailsModal'));
    const contentDiv = document.getElementById('feeDetailsContent');
    const isAdmin = {{ is_admin|default(false) ? 'true' : 'false' }};

    // Show loading
    contentDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">A carregar...</span></div><p class="text-muted mt-3 mb-0">A carregar detalhes...</p></div>';
    modal.show();

    fetch(`{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${feeId}/details`)
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Resposta não é JSON');
            }
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                contentDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            const pendingAmount = data.pending_amount;
            const totalAmount = data.total_amount;
            const paidAmount = data.total_paid;
            const payments = data.payments || [];
            const currentFeeId = feeId;

            let paymentsHtml = '';
            if (payments.length > 0) {
                paymentsHtml = `
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h6 class="mb-0 text-muted text-uppercase">
                                <i class="bi bi-clock-history me-2"></i>Histórico de Pagamentos
                                <span class="badge bg-primary ms-2">${payments.length}</span>
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th class="border-0" style="min-width: 100px;">Data</th>
                                            <th class="border-0" style="min-width: 100px;">Valor</th>
                                            <th class="border-0" style="min-width: 100px;">Método</th>
                                            <th class="border-0" style="min-width: 120px;">Referência</th>
                                            <th class="border-0" style="min-width: 180px;">Movimento Financeiro</th>
                                            <th class="border-0" style="min-width: 150px;">Registado por</th>
                                            ${isAdmin ? '<th class="border-0" style="min-width: 100px;">Ações</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${payments.map(payment => `
                                            <tr>
                                                <td>
                                                    <i class="bi bi-calendar3 text-muted me-1"></i>
                                                    ${payment.payment_date ? new Date(payment.payment_date).toLocaleDateString('pt-PT') : '-'}
                                                </td>
                                                <td>
                                                    <span class="badge bg-success-subtle text-success-emphasis">
                                                        <strong>€${parseFloat(payment.amount || 0).toFixed(2).replace('.', ',')}</strong>
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info-subtle text-info-emphasis">
                                                        ${payment.payment_method || '-'}
                                                    </span>
                                                </td>
                                                <td>
                                                    <code class="small">${payment.reference || '-'}</code>
                                                </td>
                                                <td>
                                                    ${payment.transaction_id ? `
                                                        <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/financial-transactions" 
                                                           class="text-decoration-none d-inline-flex align-items-center" 
                                                           title="Ver movimento financeiro #${payment.transaction_id}">
                                                            <i class="bi bi-link-45deg me-1"></i>
                                                            <span class="text-truncate" style="max-width: 150px;">
                                                                ${payment.account_name ? payment.account_name + ' (#' + payment.transaction_id + ')' : 'Movimento #' + payment.transaction_id}
                                                            </span>
                                                        </a>
                                                    ` : '<span class="text-muted">-</span>'}
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        <i class="bi bi-person me-1"></i>${payment.created_by_name || '-'}
                                                    </small>
                                                </td>
                                                ${isAdmin ? `
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                                                onclick="editPayment(${payment.id}, ${feeId})" 
                                                                title="Editar Pagamento">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                onclick="deletePayment(${payment.id}, ${feeId})" 
                                                                title="Eliminar Pagamento">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                                ` : ''}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                paymentsHtml = `
                    <div class="card border-0 bg-light">
                        <div class="card-body text-center py-4">
                            <i class="bi bi-inbox display-6 text-muted mb-3"></i>
                            <p class="text-muted mb-0">Nenhum pagamento registado.</p>
                        </div>
                    </div>
                `;
            }

            const dueDate = data.fee && data.fee.due_date ? new Date(data.fee.due_date).toLocaleDateString('pt-PT') : '-';
            const period = data.fee && data.fee.period_month ?
                `${['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][data.fee.period_month - 1]}/${data.fee.period_year}` :
                (data.fee ? data.fee.period_year : '-');

            contentDiv.innerHTML = `
                <!-- Informações Básicas -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-building text-muted me-2"></i>
                            <small class="text-muted text-uppercase">Fração</small>
                        </div>
                        <div class="fw-bold fs-5">
                            <span class="badge bg-secondary fs-6">${data.fraction ? data.fraction.identifier : '-'}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar text-muted me-2"></i>
                            <small class="text-muted text-uppercase">Período</small>
                        </div>
                        <div class="fw-bold fs-5">${period}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar-event text-muted me-2"></i>
                            <small class="text-muted text-uppercase">Vencimento</small>
                        </div>
                        <div class="fw-bold">${dueDate}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-tag text-muted me-2"></i>
                            <small class="text-muted text-uppercase">Tipo</small>
                        </div>
                        <div>${data.fee && (data.fee.is_historical == 1 || data.fee.is_historical === true) ? '<span class="badge bg-warning text-dark">Dívida Histórica</span>' : '<span class="badge bg-primary">Quota</span>'}</div>
                    </div>
                </div>

                <!-- Resumo Financeiro -->
                <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="card-body p-4">
                        <h6 class="text-muted text-uppercase mb-4 text-center">
                            <i class="bi bi-cash-stack me-2"></i>Resumo Financeiro
                        </h6>
                        <div class="row g-3">
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small mb-1">Valor Total</div>
                                    <div class="fw-bold fs-4">€${parseFloat(totalAmount || 0).toFixed(2).replace('.', ',')}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small mb-1">Já Pago</div>
                                    <div class="fw-bold fs-4 text-success">€${parseFloat(paidAmount || 0).toFixed(2).replace('.', ',')}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <div class="text-muted small mb-1">Pendente</div>
                                    <div class="fw-bold fs-4 ${pendingAmount > 0 ? 'text-danger' : 'text-success'}">€${parseFloat(pendingAmount || 0).toFixed(2).replace('.', ',')}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Histórico de Pagamentos -->
                ${paymentsHtml}

                <!-- Histórico de Alterações (Auditoria) -->
                ${data.payment_history && data.payment_history.length > 0 ? `
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 text-muted text-uppercase">
                            <i class="bi bi-clock-history me-2"></i>Histórico de Alterações
                            <span class="badge bg-info ms-2">${data.payment_history.length}</span>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="border-0" style="min-width: 120px;">Data/Hora</th>
                                        <th class="border-0" style="min-width: 100px;">Ação</th>
                                        <th class="border-0" style="min-width: 200px;">Descrição</th>
                                        <th class="border-0" style="min-width: 150px;">Utilizador</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.payment_history.map(history => `
                                        <tr>
                                            <td>
                                                <small class="text-muted">
                                                    ${history.created_at ? new Date(history.created_at).toLocaleString('pt-PT') : '-'}
                                                </small>
                                            </td>
                                            <td>
                                                ${history.action === 'updated' ? 
                                                    '<span class="badge bg-warning text-dark"><i class="bi bi-pencil"></i> Editado</span>' : 
                                                    history.action === 'deleted' ? 
                                                    '<span class="badge bg-danger"><i class="bi bi-trash"></i> Eliminado</span>' : 
                                                    '<span class="badge bg-secondary">' + history.action + '</span>'}
                                            </td>
                                            <td>
                                                <small>${history.description || '-'}</small>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <i class="bi bi-person me-1"></i>${history.user_name || 'Sistema'}
                                                </small>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Recibos -->
                ${data.receipts && data.receipts.length > 0 ? `
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 text-muted text-uppercase">
                            <i class="bi bi-receipt-cutoff me-2"></i>Recibos
                            <span class="badge bg-primary ms-2">${data.receipts.length}</span>
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            ${data.receipts.filter(r => r.receipt_type === 'final').map(receipt => `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-bold">${receipt.receipt_number}</div>
                                            <small class="text-muted">
                                                <span class="badge bg-success">Final</span> 
                                                | €${parseFloat(receipt.amount || 0).toFixed(2).replace('.', ',')} 
                                                | ${receipt.generated_at ? new Date(receipt.generated_at).toLocaleDateString('pt-PT') : '-'}
                                            </small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/receipts/${receipt.id}" 
                                               class="btn btn-outline-info" 
                                               title="Visualizar"
                                               target="_blank">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ BASE_URL }}condominiums/{{ condominium.id }}/receipts/${receipt.id}/download" 
                                               class="btn btn-outline-primary" 
                                               title="Descarregar PDF">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Notas -->
                ${data.fee && data.fee.notes ? `
                <div class="card border-0 bg-light mt-4">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase mb-2">
                            <i class="bi bi-sticky me-2"></i>Notas
                        </h6>
                        <p class="mb-0">${data.fee.notes}</p>
                    </div>
                </div>
                ` : ''}
            `;
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes:', error);
            contentDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${error.message || 'Erro ao carregar detalhes da quota. Por favor, tente novamente.'}</div>`;
        });
}

// Add hover effect to fee cells
document.addEventListener('DOMContentLoaded', function() {
    const feeCells = document.querySelectorAll('.fee-cell');
    feeCells.forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            if (!this.classList.contains('table-danger') && !this.classList.contains('table-success')) {
                this.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            }
        });
        cell.addEventListener('mouseleave', function() {
            if (!this.classList.contains('table-danger') && !this.classList.contains('table-success')) {
                this.style.backgroundColor = '';
            }
        });
    });
});

// Edit payment function
function editPayment(paymentId, feeId) {
    // Load payment details and show edit modal
    fetch(`{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${feeId}/payments/${paymentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Populate edit form
            document.getElementById('edit_payment_id').value = paymentId;
            document.getElementById('edit_payment_fee_id').value = feeId;
            document.getElementById('edit_payment_amount').value = parseFloat(data.payment.amount || 0).toFixed(2);
            document.getElementById('edit_payment_method').value = data.payment.payment_method || '';
            document.getElementById('edit_payment_date').value = data.payment.payment_date || '';
            document.getElementById('edit_payment_reference').value = data.payment.reference || '';
            document.getElementById('edit_payment_notes').value = data.payment.notes || '';
            
            // Show edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
            editModal.show();
        })
        .catch(error => {
            console.error('Erro ao carregar pagamento:', error);
            alert('Erro ao carregar dados do pagamento.');
        });
}

// Delete payment function
function deletePayment(paymentId, feeId) {
    if (!confirm('Tem certeza que deseja eliminar este pagamento? Esta ação não pode ser desfeita e irá atualizar o estado da quota.')) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ BASE_URL }}condominiums/{{ condominium.id }}/fees/${feeId}/payments/${paymentId}/delete`;
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
